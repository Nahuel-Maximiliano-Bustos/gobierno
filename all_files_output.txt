// FILE: .eslintrc.cjs
module.exports = {
  root: true,
  parser: '@typescript-eslint/parser',
  plugins: ['@typescript-eslint', 'react-refresh', 'react-hooks'],
  extends: ['eslint:recommended', 'plugin:@typescript-eslint/recommended', 'plugin:react-hooks/recommended', 'prettier'],
  env: {
    browser: true,
    es2021: true
  },
  parserOptions: {
    ecmaVersion: 'latest',
    sourceType: 'module'
  },
  ignorePatterns: ['dist', 'node_modules'],
  rules: {
    '@typescript-eslint/no-explicit-any': 'off'
  }
};

// FILE: .prettierrc
{
  "singleQuote": true,
  "semi": true,
  "printWidth": 100,
  "trailingComma": "none"
}

// FILE: index.html
<!doctype html>
<html lang="es-MX">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sistema de Tesorería Municipal</title>
    <link rel="manifest" href="/manifest.webmanifest" />
    <meta name="theme-color" content="#0f172a" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body class="antialiased">
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>

// FILE: package.json
{
  "name": "tesoreria-erp",
  "version": "1.0.0",
  "private": true,
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "tsc -b && vite build",
    "preview": "vite preview",
    "lint": "eslint \"src/**/*.{ts,tsx}\"",
    "test": "vitest"
  },
  "dependencies": {
    "@radix-ui/react-alert-dialog": "1.0.5",
    "@radix-ui/react-avatar": "1.0.4",
    "@radix-ui/react-dialog": "1.0.5",
    "@radix-ui/react-dropdown-menu": "2.0.6",
    "@radix-ui/react-label": "2.0.2",
    "@radix-ui/react-navigation-menu": "1.1.4",
    "@radix-ui/react-popover": "1.0.7",
    "@radix-ui/react-scroll-area": "1.0.6",
    "@radix-ui/react-select": "1.2.2",
    "@radix-ui/react-separator": "1.0.3",
    "@radix-ui/react-slot": "1.0.3",
    "@radix-ui/react-tabs": "1.0.5",
    "@radix-ui/react-toast": "1.1.4",
    "@tanstack/react-query": "5.28.9",
    "@tanstack/react-table": "8.10.9",
    "axios": "1.6.8",
    "class-variance-authority": "0.7.0",
    "clsx": "2.1.0",
    "dayjs": "1.11.11",
    "lucide-react": "0.344.0",
    "react": "18.2.0",
    "react-dom": "18.2.0",
    "react-hook-form": "7.51.4",
    "react-router-dom": "6.22.3",
    "workbox-window": "7.0.0",
    "zustand": "4.5.2"
  },
  "devDependencies": {
    "@testing-library/user-event": "14.5.2",
    "@types/node": "20.11.30",
    "@types/react": "18.2.74",
    "@types/react-dom": "18.2.24",
    "@typescript-eslint/eslint-plugin": "7.6.0",
    "@typescript-eslint/parser": "7.6.0",
    "@vitejs/plugin-react": "4.2.1",
    "autoprefixer": "10.4.17",
    "eslint": "8.57.0",
    "eslint-config-prettier": "9.1.0",
    "eslint-plugin-react-hooks": "4.6.0",
    "eslint-plugin-react-refresh": "0.4.6",
    "postcss": "8.4.35",
    "prettier": "3.2.5",
    "tailwind-merge": "2.2.2",
    "tailwindcss": "3.4.1",
    "typescript": "5.4.4",
    "vite": "5.2.0",
    "vitest": "1.5.2"
  }
}

// FILE: postcss.config.cjs
module.exports = {
  plugins: {
    tailwindcss: {},
    autoprefixer: {}
  }
};

// FILE: tailwind.config.ts
import type { Config } from 'tailwindcss';
import { fontFamily } from 'tailwindcss/defaultTheme';

const config: Config = {
  darkMode: ['class'],
  content: [
    './index.html',
    './src/**/*.{ts,tsx}'
  ],
  theme: {
    extend: {
      colors: {
        border: 'hsl(var(--border))',
        input: 'hsl(var(--input))',
        ring: 'hsl(var(--ring))',
        background: 'hsl(var(--background))',
        foreground: 'hsl(var(--foreground))',
        primary: {
          DEFAULT: 'hsl(var(--primary))',
          foreground: 'hsl(var(--primary-foreground))'
        },
        secondary: {
          DEFAULT: 'hsl(var(--secondary))',
          foreground: 'hsl(var(--secondary-foreground))'
        },
        destructive: {
          DEFAULT: 'hsl(var(--destructive))',
          foreground: 'hsl(var(--destructive-foreground))'
        },
        muted: {
          DEFAULT: 'hsl(var(--muted))',
          foreground: 'hsl(var(--muted-foreground))'
        },
        accent: {
          DEFAULT: 'hsl(var(--accent))',
          foreground: 'hsl(var(--accent-foreground))'
        },
        popover: {
          DEFAULT: 'hsl(var(--popover))',
          foreground: 'hsl(var(--popover-foreground))'
        },
        card: {
          DEFAULT: 'hsl(var(--card))',
          foreground: 'hsl(var(--card-foreground))'
        }
      },
      borderRadius: {
        lg: 'var(--radius)',
        md: 'calc(var(--radius) - 2px)',
        sm: 'calc(var(--radius) - 4px)'
      },
      fontFamily: {
        sans: ['\"Poppins\"', ...fontFamily.sans]
      }
    }
  },
  plugins: []
};

export default config;

// FILE: tsconfig.app.json
{
  "compilerOptions": {
    "target": "ES2020",
    "useDefineForClassFields": true,
    "module": "ES2020",
    "lib": ["DOM", "DOM.Iterable", "ES2020"],
    "skipLibCheck": true,
    "allowJs": false,
    "esModuleInterop": true,
    "allowSyntheticDefaultImports": true,
    "strict": true,
    "forceConsistentCasingInFileNames": true,
    "moduleResolution": "Node",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "noEmit": true,
    "jsx": "react-jsx",
    "baseUrl": ".",
    "paths": {
      "@app/*": ["src/app/*"],
      "@auth/*": ["src/auth/*"],
      "@treasury/*": ["src/treasury/*"],
      "@shared/*": ["src/shared/*"],
      "@mocks/*": ["src/mocks/*"]
    }
  },
  "include": ["src"]
}

// FILE: tsconfig.json
{
  "extends": "./tsconfig.app.json",
  "compilerOptions": {
    "composite": true
  },
  "include": ["tsconfig.app.json", "tsconfig.node.json"]
}

// FILE: tsconfig.node.json
{
  "compilerOptions": {
    "composite": true,
    "module": "ES2020",
    "moduleResolution": "Node",
    "allowSyntheticDefaultImports": true,
    "esModuleInterop": true,
    "resolveJsonModule": true
  },
  "include": ["vite.config.ts", "vitest.config.ts", "postcss.config.cjs", "tailwind.config.ts"]
}

// FILE: vite.config.ts
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';
import path from 'node:path';

export default defineConfig({
  plugins: [react()],
  resolve: {
    alias: {
      '@app': path.resolve(__dirname, 'src/app'),
      '@auth': path.resolve(__dirname, 'src/auth'),
      '@treasury': path.resolve(__dirname, 'src/treasury'),
      '@shared': path.resolve(__dirname, 'src/shared'),
      '@mocks': path.resolve(__dirname, 'src/mocks')
    }
  },
  define: {
    __APP_VERSION__: JSON.stringify('1.0.0')
  },
  test: {
    globals: true,
    environment: 'jsdom',
    setupFiles: './vitest.setup.ts'
  }
});

// FILE: vitest.setup.ts
import dayjs from 'dayjs';
import 'dayjs/locale/es-mx';

dayjs.locale('es-mx');

// FILE: public/manifest.webmanifest
{
  "name": "Tesorería Municipal",
  "short_name": "Tesorería",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#0f172a",
  "theme_color": "#2563eb",
  "lang": "es-MX",
  "description": "Sistema de gestión para el Tesorero municipal.",
  "icons": [
    {
      "src": "/icon-192.png",
      "type": "image/png",
      "sizes": "192x192"
    },
    {
      "src": "/icon-512.png",
      "type": "image/png",
      "sizes": "512x512"
    }
  ]
}

// FILE: public/robots.txt
User-agent: *
Allow: /

// FILE: public/sw.js
self.addEventListener('install', () => {
  self.skipWaiting();
});

self.addEventListener('activate', (event) => {
  event.waitUntil(clients.claim());
});

self.addEventListener('fetch', () => {
  // Placeholder de Workbox: caché se configuraría aquí.
});

// FILE: src/App.tsx
import { RouterProvider } from 'react-router-dom';
import { router } from '@app/routes';

export const App = () => <RouterProvider router={router} />;

// FILE: src/global.css
@tailwind base;
@tailwind components;
@tailwind utilities;

:root {
  --background: 216 33% 97%;
  --foreground: 222 47% 11%;
  --card: 0 0% 100%;
  --card-foreground: 222 47% 11%;
  --popover: 0 0% 100%;
  --popover-foreground: 222 47% 11%;
  --primary: 222 89% 53%;
  --primary-foreground: 0 0% 100%;
  --secondary: 199 94% 67%;
  --secondary-foreground: 222 47% 11%;
  --muted: 215 16% 47%;
  --muted-foreground: 215 16% 82%;
  --accent: 199 94% 67%;
  --accent-foreground: 222 47% 11%;
  --destructive: 0 84% 60%;
  --destructive-foreground: 0 0% 100%;
  --border: 214 32% 91%;
  --input: 214 32% 91%;
  --ring: 221 83% 53%;
  --radius: 0.8rem;
}

html,
body {
  background-color: hsl(var(--background));
  color: hsl(var(--foreground));
  font-family: 'Poppins', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  min-height: 100%;
}

* {
  @apply outline-offset-2;
}

[data-focus-visible-added] {
  @apply outline outline-2 outline-primary;
}

::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

::-webkit-scrollbar-thumb {
  background-color: hsla(222, 47%, 11%, 0.25);
  border-radius: 9999px;
}

// FILE: src/main.tsx
import React from 'react';
import ReactDOM from 'react-dom/client';
import { RouterProvider } from 'react-router-dom';
import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
import dayjs from 'dayjs';
import 'dayjs/locale/es-mx';
import { router } from '@app/routes';
import './global.css';

const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      refetchOnWindowFocus: false,
      retry: 1
    }
  }
});

dayjs.locale('es-mx');

const rootElement = document.getElementById('root');
if (!rootElement) throw new Error('Elemento root no encontrado');

ReactDOM.createRoot(rootElement).render(
  <React.StrictMode>
    <QueryClientProvider client={queryClient}>
      <RouterProvider router={router} />
    </QueryClientProvider>
  </React.StrictMode>
);

if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    import('workbox-window').then(({ Workbox }) => {
      try {
        const wb = new Workbox('/sw.js');
        wb.register();
      } catch (error) {
        console.error('No se pudo registrar el Service Worker', error);
      }
    });
  });
}

// FILE: src/vite-env.d.ts
/// <reference types="vite/client" />
declare module '*?raw' {
  const content: string;
  export default content;
}

// FILE: src/app/routes.tsx
import { createBrowserRouter, Navigate } from 'react-router-dom';
import { LoginPage } from '@auth/LoginPage';
import { RequireAuth } from './guards/RequireAuth';
import { TreasuryLayout } from './layouts/TreasuryLayout';
import { DashboardTesoreria } from '@treasury/pages/DashboardTesoreria';
import { IngresosList } from '@treasury/pages/IngresosList';
import { IngresoNew } from '@treasury/pages/IngresoNew';
import { IngresoDetail } from '@treasury/pages/IngresoDetail';
import { EgresosList } from '@treasury/pages/EgresosList';
import { EgresoNew } from '@treasury/pages/EgresoNew';
import { EgresoDetail } from '@treasury/pages/EgresoDetail';
import { CompromisosList } from '@treasury/pages/CompromisosList';
import { CompromisoNew } from '@treasury/pages/CompromisoNew';
import { CompromisoDetail } from '@treasury/pages/CompromisoDetail';
import { Conciliacion } from '@treasury/pages/Conciliacion';
import { PresupuestoPage } from '@treasury/pages/Presupuesto';
import { ProveedoresPage } from '@treasury/pages/Proveedores';
import { BancosCuentasPage } from '@treasury/pages/BancosCuentas';
import { MovimientosBancariosPage } from '@treasury/pages/MovimientosBancarios';
import { ReportesTesoreriaPage } from '@treasury/pages/ReportesTesoreria';
import { ConfigTesoreriaPage } from '@treasury/pages/ConfigTesoreria';
import { NotFound } from '@pages/NotFound';

export const router = createBrowserRouter([
  {
    path: '/login',
    element: <LoginPage />
  },
  {
    path: '/',
    element: <Navigate to="/tesoreria/dashboard" replace />
  },
  {
    element: <RequireAuth />,
    children: [
      {
        path: '/tesoreria',
        element: <TreasuryLayout />, 
        children: [
          { path: 'dashboard', element: <DashboardTesoreria /> },
          { path: 'ingresos', element: <IngresosList /> },
          { path: 'ingresos/nuevo', element: <IngresoNew /> },
          { path: 'ingresos/:id', element: <IngresoDetail /> },
          { path: 'egresos', element: <EgresosList /> },
          { path: 'egresos/nuevo', element: <EgresoNew /> },
          { path: 'egresos/:id', element: <EgresoDetail /> },
          { path: 'compromisos', element: <CompromisosList /> },
          { path: 'compromisos/nuevo', element: <CompromisoNew /> },
          { path: 'compromisos/:id', element: <CompromisoDetail /> },
          { path: 'conciliacion', element: <Conciliacion /> },
          { path: 'presupuesto', element: <PresupuestoPage /> },
          { path: 'proveedores', element: <ProveedoresPage /> },
          { path: 'bancos', element: <BancosCuentasPage /> },
          { path: 'movimientos', element: <MovimientosBancariosPage /> },
          { path: 'reportes', element: <ReportesTesoreriaPage /> },
          { path: 'config', element: <ConfigTesoreriaPage /> }
        ]
      }
    ]
  },
  {
    path: '*',
    element: <NotFound />
  }
]);

// FILE: src/app/guards/RequireAuth.tsx
import { Navigate, Outlet, useLocation } from 'react-router-dom';
import { useAuthStore } from '@auth/auth.store';

export const RequireAuth = () => {
  const token = useAuthStore((state) => state.token);
  const location = useLocation();

  if (!token) {
    return <Navigate to="/login" replace state={{ from: location }} />;
  }

  return <Outlet />;
};

// FILE: src/app/layouts/TreasuryLayout.tsx
import { useEffect, useRef } from 'react';
import { Outlet, useLocation, useNavigate } from 'react-router-dom';
import { SidebarMenu } from '@treasury/components/SidebarMenu';
import { Topbar } from '@treasury/components/Topbar';
import { ToastContainer } from '@shared/components/ToastContainer';
import { Breadcrumb } from '@shared/components/ui/breadcrumb';
import { useUIStore } from '@shared/store/ui.store';

const shortcutMap: Record<string, string> = {
  '/tesoreria/ingresos': '/tesoreria/ingresos/nuevo',
  '/tesoreria/egresos': '/tesoreria/egresos/nuevo',
  '/tesoreria/compromisos': '/tesoreria/compromisos/nuevo'
};

const computeNewRoute = (pathname: string) => {
  if (pathname.startsWith('/tesoreria/ingresos')) return '/tesoreria/ingresos/nuevo';
  if (pathname.startsWith('/tesoreria/egresos')) return '/tesoreria/egresos/nuevo';
  if (pathname.startsWith('/tesoreria/compromisos')) return '/tesoreria/compromisos/nuevo';
  return shortcutMap[pathname];
};

export const TreasuryLayout = () => {
  const navigate = useNavigate();
  const location = useLocation();
  const breadcrumb = useUIStore((state) => state.breadcrumb);
  const searchRef = useRef<HTMLInputElement>(null);

  useEffect(() => {
    let lastKey = '';
    let lastKeyTime = 0;
    const handler = (event: KeyboardEvent) => {
      if (['INPUT', 'SELECT', 'TEXTAREA'].includes((event.target as HTMLElement)?.tagName)) {
        if (event.key === '/' && event.ctrlKey) {
          event.preventDefault();
          searchRef.current?.focus();
        }
        return;
      }

      if (event.key === '/') {
        event.preventDefault();
        searchRef.current?.focus();
      }

      if (event.key.toLowerCase() === 'n') {
        event.preventDefault();
        const next = computeNewRoute(location.pathname);
        if (next) navigate(next);
      }

      if (event.key.toLowerCase() === 'g') {
        lastKey = 'g';
        lastKeyTime = Date.now();
        return;
      }

      if (lastKey === 'g' && Date.now() - lastKeyTime < 800) {
        if (event.key.toLowerCase() === 'd') {
          event.preventDefault();
          navigate('/tesoreria/dashboard');
        }
        if (event.key.toLowerCase() === 'c') {
          event.preventDefault();
          navigate('/tesoreria/compromisos');
        }
        lastKey = '';
        lastKeyTime = 0;
      }
    };

    window.addEventListener('keydown', handler);
    return () => window.removeEventListener('keydown', handler);
  }, [location.pathname, navigate]);

  return (
    <div className="flex min-h-screen bg-slate-100 text-slate-900">
      <SidebarMenu />
      <div className="flex flex-1 flex-col">
        <Topbar searchRef={searchRef} onSearch={(term) => term && navigate('/tesoreria/reportes', { state: { term } })} />
        <main className="flex-1 space-y-4 p-6">
          <Breadcrumb items={breadcrumb} />
          <Outlet />
        </main>
        <ToastContainer />
      </div>
    </div>
  );
};

// FILE: src/auth/LoginPage.tsx
import { useForm } from 'react-hook-form';
import { Button } from '@shared/components/ui/button';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@shared/components/ui/card';
import { Input } from '@shared/components/ui/input';
import { Label } from '@shared/components/ui/label';
import { useAuth } from './useAuth';
import { useState } from 'react';

interface LoginFormValues {
  email: string;
  password: string;
}

export const LoginPage = () => {
  const { handleSubmit, register } = useForm<LoginFormValues>({
    defaultValues: { email: 'tesorero@demo', password: 'demo1234' }
  });
  const { login } = useAuth();
  const [loading, setLoading] = useState(false);

  const onSubmit = async (values: LoginFormValues) => {
    setLoading(true);
    try {
      await login(values.email, values.password);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-950 via-slate-800 to-slate-900">
      <div className="mx-auto flex min-h-screen max-w-6xl flex-col items-center justify-center px-4">
        <Card className="w-full max-w-md border-slate-700/40 bg-slate-900/70 backdrop-blur">
          <CardHeader>
            <CardTitle className="text-2xl text-white">Tesorería Municipal</CardTitle>
            <CardDescription className="text-slate-300">
              Inicie sesión con las credenciales asignadas al Tesorero.
            </CardDescription>
          </CardHeader>
          <CardContent>
            <form onSubmit={handleSubmit(onSubmit)} className="space-y-4" aria-label="Formulario de acceso">
              <div className="space-y-2">
                <Label htmlFor="email" className="text-slate-200">
                  Correo institucional
                </Label>
                <Input
                  id="email"
                  type="email"
                  placeholder="tesorero@demo"
                  autoComplete="username"
                  {...register('email', { required: true })}
                />
              </div>
              <div className="space-y-2">
                <Label htmlFor="password" className="text-slate-200">
                  Contraseña
                </Label>
                <Input
                  id="password"
                  type="password"
                  placeholder="••••••••"
                  autoComplete="current-password"
                  {...register('password', { required: true })}
                />
              </div>
              <Button type="submit" className="w-full" disabled={loading}>
                {loading ? 'Verificando…' : 'Ingresar'}
              </Button>
              <p className="text-center text-xs text-slate-400">
                Único usuario autorizado: tesorero@demo / demo1234
              </p>
            </form>
          </CardContent>
        </Card>
      </div>
    </div>
  );
};

// FILE: src/auth/auth.store.ts
import { create } from 'zustand';
import { setAuthToken } from '@shared/lib/api';

export type TesoreriaUser = {
  email: string;
  nombre: string;
  rol: 'TESORERO';
  permisos: Array<'VER' | 'CAPTURAR' | 'EDITAR' | 'AUTORIZAR'>;
};

type AuthState = {
  token: string | null;
  user: TesoreriaUser | null;
  login: (token: string, user: TesoreriaUser) => void;
  logout: () => void;
};

export const useAuthStore = create<AuthState>((set) => ({
  token: null,
  user: null,
  login: (token, user) => {
    set({ token, user });
    setAuthToken(token);
  },
  logout: () => {
    set({ token: null, user: null });
    setAuthToken(null);
  }
}));

// FILE: src/auth/useAuth.ts
import { useMemo } from 'react';
import { useNavigate } from 'react-router-dom';
import { useAuthStore } from './auth.store';
import { toast } from '@shared/hooks/useToast';
import { api } from '@shared/lib/api';

export const useAuth = () => {
  const navigate = useNavigate();
  const token = useAuthStore((state) => state.token);
  const user = useAuthStore((state) => state.user);
  const loginStore = useAuthStore((state) => state.login);
  const logoutStore = useAuthStore((state) => state.logout);

  const login = async (email: string, password: string) => {
    const response = await api.post('/auth/login', { email, password });
    const { token: authToken, user: sessionUser } = response.data;
    loginStore(authToken, sessionUser);
    toast({ title: 'Bienvenido a Tesorería', description: `Sesión iniciada como ${sessionUser.nombre}` });
    navigate('/tesoreria/dashboard', { replace: true });
  };

  const logout = () => {
    logoutStore();
    toast({ title: 'Sesión finalizada', variant: 'warning' });
    navigate('/login', { replace: true });
  };

  return useMemo(
    () => ({
      token,
      user,
      isAuthenticated: Boolean(token),
      login,
      logout
    }),
    [token, user]
  );
};

// FILE: src/mocks/db.ts
import {
  Compromiso,
  CuentaBancaria,
  Egreso,
  Ingreso,
  MovimientoBancario,
  Presupuesto,
  Proveedor
} from '@treasury/types';
import { seeds } from './seeds';

export type MockDB = {
  ingresos: Ingreso[];
  egresos: Egreso[];
  compromisos: Compromiso[];
  presupuesto: Presupuesto;
  proveedores: Proveedor[];
  cuentas: CuentaBancaria[];
  movimientos: MovimientoBancario[];
};

const clone = <T>(value: T): T => JSON.parse(JSON.stringify(value));

const ensureId = <T extends { id?: string }>(value: T) => ({
  ...value,
  id: value.id ?? crypto.randomUUID()
});

class Database {
  private state: MockDB;

  constructor() {
    this.state = this.seed();
  }

  private seed(): MockDB {
    return {
      ingresos: clone(seeds.ingresos),
      egresos: clone(seeds.egresos),
      compromisos: clone(seeds.compromisos),
      presupuesto: clone(seeds.presupuesto),
      proveedores: clone(seeds.proveedores),
      cuentas: clone(seeds.cuentas),
      movimientos: clone(seeds.movimientos)
    };
  }

  reset() {
    this.state = this.seed();
  }

  list<K extends keyof MockDB>(key: K): MockDB[K] {
    return clone(this.state[key]);
  }

  insert<K extends keyof MockDB>(key: K, item: MockDB[K] extends Array<infer U> ? U : never) {
    if (!Array.isArray(this.state[key])) {
      throw new Error(`Insert no soportado en ${String(key)}`);
    }
    const next = ensureId(item as any);
    (this.state[key] as Array<typeof next>).push(next);
    return clone(next);
  }

  find<K extends keyof MockDB>(key: K, id: string) {
    if (key === 'presupuesto') {
      const presupuesto = this.state.presupuesto;
      return presupuesto.id === id ? clone(presupuesto) : undefined;
    }
    const collection = this.state[key] as Array<any>;
    return clone(collection.find((record) => record.id === id));
  }

  update<K extends keyof MockDB>(key: K, id: string, patch: Partial<MockDB[K] extends Array<infer U> ? U : MockDB[K]>) {
    if (key === 'presupuesto') {
      this.state.presupuesto = { ...this.state.presupuesto, ...(patch as Partial<Presupuesto>) } as Presupuesto;
      return clone(this.state.presupuesto);
    }
    const collection = this.state[key] as Array<any>;
    const idx = collection.findIndex((record) => record.id === id);
    if (idx === -1) throw new Error('Registro no encontrado');
    const updated = { ...collection[idx], ...patch };
    collection[idx] = updated;
    return clone(updated);
  }

  delete<K extends keyof MockDB>(key: K, id: string) {
    if (!Array.isArray(this.state[key])) {
      throw new Error(`Delete no soportado en ${String(key)}`);
    }
    const collection = this.state[key] as Array<any>;
    const idx = collection.findIndex((record) => record.id === id);
    if (idx === -1) return false;
    collection.splice(idx, 1);
    return true;
  }
}

export const db = new Database();

// FILE: src/mocks/handlers.ts
import type { AxiosRequestConfig } from 'axios';
import dayjs from 'dayjs';
import { db } from './db';
import type {
  Compromiso,
  CuentaBancaria,
  Egreso,
  Ingreso,
  MovimientoBancario,
  Partida,
  Presupuesto,
  Proveedor
} from '@treasury/types';

export class MockHttpError extends Error {
  status: number;
  statusText?: string;
  payload?: Record<string, unknown>;

  constructor(status: number, message: string, statusText?: string, payload?: Record<string, unknown>) {
    super(message);
    this.status = status;
    this.statusText = statusText;
    this.payload = payload;
  }
}

const wait = (ms: number) => new Promise((resolve) => setTimeout(resolve, ms));

const parseUrl = (url = '') => url.replace(/^\/api/, '').split('?')[0];

const parseBody = (config: AxiosRequestConfig) => {
  if (!config.data) return {};
  if (typeof config.data === 'string') {
    try {
      return JSON.parse(config.data);
    } catch (error) {
      return {};
    }
  }
  return config.data as Record<string, unknown>;
};

const ensureAuth = (config: AxiosRequestConfig) => {
  const header = (config.headers?.Authorization ?? config.headers?.authorization) as string | undefined;
  if (!header) throw new MockHttpError(401, 'No autenticado');
};

const withDelay = async <T>(fn: () => T, ms = 250) => {
  await wait(ms);
  return fn();
};

const toNumber = (value: unknown) => {
  const num = Number(value);
  return Number.isFinite(num) ? num : 0;
};

const aggregatePresupuesto = () => {
  const presupuesto = db.list('presupuesto') as Presupuesto;
  const compromisos = db.list('compromisos') as Compromiso[];
  const egresos = db.list('egresos') as Egreso[];

  const partidasExtendidas = presupuesto.partidas.map((partida) => {
    const comprometido = compromisos
      .filter((comp) => comp.partida === partida.clave && ['BORRADOR', 'REVISION', 'AUTORIZADO'].includes(comp.estatus))
      .reduce((sum, comp) => sum + comp.importe, 0);
    const devengado = compromisos
      .filter((comp) => comp.partida === partida.clave && ['AUTORIZADO', 'PAGADO', 'CERRADO'].includes(comp.estatus))
      .reduce((sum, comp) => sum + comp.importe, 0);
    const pagado = egresos.filter((eg) => eg.partida === partida.clave && eg.estatus === 'PAGADO').reduce((sum, eg) => sum + eg.importe, 0);
    const disponible = partida.disponible - comprometido;
    return { ...partida, comprometido, devengado, pagado, disponible };
  });

  return { ...presupuesto, partidas: partidasExtendidas };
};

export const compromisoTransitions: Record<Compromiso['estatus'], Compromiso['estatus'][]> = {
  BORRADOR: ['REVISION'],
  REVISION: ['RECHAZADO', 'AUTORIZADO'],
  RECHAZADO: [],
  AUTORIZADO: ['PAGADO'],
  PAGADO: ['CERRADO'],
  CERRADO: []
};

export const handleRequest = async (config: AxiosRequestConfig) => {
  const method = (config.method ?? 'get').toUpperCase();
  const url = parseUrl(config.url ?? '');
  const params = (config.params ?? {}) as Record<string, unknown>;
  const body = parseBody(config);

  if (url === '/auth/login' && method === 'POST') {
    const { email, password } = body as { email?: string; password?: string };
    if (email === 'tesorero@demo' && password === 'demo1234') {
      return withDelay(() => ({
        status: 200,
        data: {
          token: 'TESORERIA_TOKEN',
          user: {
            email,
            nombre: 'Tesorero Municipal',
            rol: 'TESORERO' as const,
            permisos: ['VER', 'CAPTURAR', 'EDITAR', 'AUTORIZAR'] as const
          }
        }
      }));
    }
    throw new MockHttpError(401, 'Credenciales inválidas');
  }

  ensureAuth(config);

  if (url === '/auth/profile' && method === 'GET') {
    return withDelay(() => ({
      status: 200,
      data: {
        email: 'tesorero@demo',
        nombre: 'Tesorero Municipal',
        rol: 'TESORERO',
        permisos: ['VER', 'CAPTURAR', 'EDITAR', 'AUTORIZAR']
      }
    }));
  }

  if (url === '/dashboard/tesoreria' && method === 'GET') {
    const ingresos = db.list('ingresos') as Ingreso[];
    const egresos = db.list('egresos') as Egreso[];
    const compromisos = db.list('compromisos') as Compromiso[];
    const presupuesto = aggregatePresupuesto();
    const movimientos = db.list('movimientos') as MovimientoBancario[];
    const mesActual = dayjs().month();
    const ingresosMes = ingresos.filter((ing) => dayjs(ing.fecha).month() === mesActual);
    const egresosMes = egresos.filter((eg) => dayjs(eg.fecha).month() === mesActual);
    const metaMensual = 1_200_000;
    const porVencer = compromisos.filter((comp) => dayjs(comp.fechaProgramada).diff(dayjs(), 'day') <= 7 && !['PAGADO', 'CERRADO'].includes(comp.estatus));
    const alertasConciliacion = movimientos.filter((mov) => !mov.conciliado && dayjs(mov.fecha).isBefore(dayjs().subtract(5, 'day')));
    const bitacoraReciente = compromisos.flatMap((comp) => comp.bitacora.map((item) => ({ ...item, entidad: comp.concepto }))).slice(0, 10);
    const tareas = compromisos.filter((comp) => comp.estatus === 'REVISION' || comp.estatus === 'AUTORIZADO');

    return withDelay(() => ({
      status: 200,
      data: {
        ingresosMes: ingresosMes.reduce((sum, item) => sum + item.importe, 0),
        metaMensual,
        egresosCapitulo: egresosMes.reduce<Record<string, number>>((acc, item) => {
          acc[item.capitulo] = (acc[item.capitulo] ?? 0) + item.importe;
          return acc;
        }, {}),
        avancePresupuestal: presupuesto.partidas.map((partida) => ({
          clave: partida.clave,
          nombre: partida.nombre,
          disponible: partida.disponible,
          pagado: partida.pagado
        })),
        compromisosPorVencer: porVencer,
        alertasConciliacion,
        bitacoraReciente,
        tareasHoy: tareas
      }
    }));
  }

  if (url === '/ingresos' && method === 'GET') {
    const ingresos = db.list('ingresos') as Ingreso[];
    const filtered = ingresos.filter((ingreso) => {
      const matchesTexto = params.q
        ? ingreso.concepto.toLowerCase().includes(String(params.q).toLowerCase()) ||
          ingreso.referencia?.toLowerCase().includes(String(params.q).toLowerCase())
        : true;
      const fechaInicio = params.fechaInicio ? dayjs(params.fechaInicio as string) : null;
      const fechaFin = params.fechaFin ? dayjs(params.fechaFin as string) : null;
      const matchesFecha = (!fechaInicio || dayjs(ingreso.fecha).isSameOrAfter(fechaInicio, 'day')) &&
        (!fechaFin || dayjs(ingreso.fecha).isSameOrBefore(fechaFin, 'day'));
      const matchesFuente = params.fuente ? ingreso.fuente === params.fuente : true;
      const matchesCuenta = params.cuentaId ? ingreso.cuentaId === params.cuentaId : true;
      return matchesTexto && matchesFecha && matchesFuente && matchesCuenta;
    });
    return withDelay(() => ({ status: 200, data: filtered }));
  }

  if (url?.startsWith('/ingresos/') && method === 'GET') {
    const id = url.split('/')[2];
    const ingreso = db.find('ingresos', id) as Ingreso | undefined;
    if (!ingreso) throw new MockHttpError(404, 'Ingreso no encontrado');
    return withDelay(() => ({ status: 200, data: ingreso }));
  }

  if (url === '/ingresos' && method === 'POST') {
    const payload = body as Partial<Ingreso>;
    const ingreso = db.insert('ingresos', {
      ...(payload as Ingreso),
      bitacora: [
        {
          ts: new Date().toISOString(),
          user: 'TESORERO',
          action: 'Ingreso capturado'
        }
      ]
    } as Ingreso);
    return withDelay(() => ({ status: 201, data: ingreso }));
  }

  if (url?.startsWith('/ingresos/') && method === 'PUT') {
    const id = url.split('/')[2];
    const ingresoActual = db.find('ingresos', id) as Ingreso | undefined;
    if (!ingresoActual) throw new MockHttpError(404, 'Ingreso no encontrado');
    const updates = body as Partial<Ingreso>;
    const ingreso = db.update('ingresos', id, {
      ...updates,
      bitacora: [
        ...ingresoActual.bitacora,
        {
          ts: new Date().toISOString(),
          user: 'TESORERO',
          action: 'Ingreso actualizado',
          after: updates
        }
      ]
    } as Ingreso);
    return withDelay(() => ({ status: 200, data: ingreso }));
  }

  if (url?.startsWith('/ingresos/') && method === 'DELETE') {
    const id = url.split('/')[2];
    db.delete('ingresos', id);
    return withDelay(() => ({ status: 204, data: null }));
  }

  if (url === '/egresos' && method === 'GET') {
    const egresos = db.list('egresos') as Egreso[];
    const filtered = egresos.filter((egreso) => {
      const matchesTexto = params.q
        ? egreso.concepto.toLowerCase().includes(String(params.q).toLowerCase())
        : true;
      const matchesProveedor = params.proveedorId ? egreso.proveedorId === params.proveedorId : true;
      const matchesEstatus = params.estatus ? egreso.estatus === params.estatus : true;
      const fechaInicio = params.fechaInicio ? dayjs(params.fechaInicio as string) : null;
      const fechaFin = params.fechaFin ? dayjs(params.fechaFin as string) : null;
      const matchesFecha = (!fechaInicio || dayjs(egreso.fecha).isSameOrAfter(fechaInicio, 'day')) &&
        (!fechaFin || dayjs(egreso.fecha).isSameOrBefore(fechaFin, 'day'));
      return matchesTexto && matchesProveedor && matchesEstatus && matchesFecha;
    });
    return withDelay(() => ({ status: 200, data: filtered }));
  }

  if (url?.startsWith('/egresos/') && method === 'GET') {
    const id = url.split('/')[2];
    const egreso = db.find('egresos', id) as Egreso | undefined;
    if (!egreso) throw new MockHttpError(404, 'Egreso no encontrado');
    return withDelay(() => ({ status: 200, data: egreso }));
  }

  if (url === '/egresos' && method === 'POST') {
    const payload = body as Partial<Egreso>;
    const egreso = db.insert('egresos', {
      ...(payload as Egreso),
      bitacora: [
        {
          ts: new Date().toISOString(),
          user: 'TESORERO',
          action: 'Egreso capturado'
        }
      ]
    } as Egreso);
    return withDelay(() => ({ status: 201, data: egreso }));
  }

  if (url?.startsWith('/egresos/') && method === 'PUT') {
    const id = url.split('/')[2];
    const egresoActual = db.find('egresos', id) as Egreso | undefined;
    if (!egresoActual) throw new MockHttpError(404, 'Egreso no encontrado');
    const updates = body as Partial<Egreso>;
    const egreso = db.update('egresos', id, {
      ...updates,
      bitacora: [
        ...egresoActual.bitacora,
        {
          ts: new Date().toISOString(),
          user: 'TESORERO',
          action: 'Egreso actualizado',
          after: updates
        }
      ]
    } as Egreso);
    return withDelay(() => ({ status: 200, data: egreso }));
  }

  if (url?.startsWith('/egresos/') && method === 'DELETE') {
    const id = url.split('/')[2];
    db.delete('egresos', id);
    return withDelay(() => ({ status: 204, data: null }));
  }

  if (url === '/compromisos' && method === 'GET') {
    const compromisos = db.list('compromisos') as Compromiso[];
    const filtered = compromisos.filter((comp) => {
      const matchesStatus = params.estatus ? comp.estatus === params.estatus : true;
      const matchesProveedor = params.proveedorId ? comp.proveedor.id === params.proveedorId : true;
      const termino = params.q ? String(params.q).toLowerCase() : '';
      const matchesTexto = termino ? comp.concepto.toLowerCase().includes(termino) : true;
      const fechaInicio = params.fechaInicio ? dayjs(params.fechaInicio as string) : null;
      const fechaFin = params.fechaFin ? dayjs(params.fechaFin as string) : null;
      const matchesFecha = (!fechaInicio || dayjs(comp.fechaDocumento).isSameOrAfter(fechaInicio, 'day')) &&
        (!fechaFin || dayjs(comp.fechaDocumento).isSameOrBefore(fechaFin, 'day'));
      return matchesStatus && matchesProveedor && matchesTexto && matchesFecha;
    });
    return withDelay(() => ({ status: 200, data: filtered }));
  }

  if (url?.startsWith('/compromisos/') && method === 'GET') {
    const id = url.split('/')[2];
    const compromiso = db.find('compromisos', id) as Compromiso | undefined;
    if (!compromiso) throw new MockHttpError(404, 'Compromiso no encontrado');
    return withDelay(() => ({ status: 200, data: compromiso }));
  }

  if (url === '/compromisos' && method === 'POST') {
    const payload = body as Compromiso;
    const compromiso = db.insert('compromisos', {
      ...payload,
      estatus: 'BORRADOR',
      bitacora: [
        ...(payload.bitacora ?? []),
        {
          ts: new Date().toISOString(),
          user: 'TESORERO',
          action: 'Compromiso creado'
        }
      ]
    } as Compromiso);
    return withDelay(() => ({ status: 201, data: compromiso }));
  }

  if (url?.startsWith('/compromisos/') && method === 'PUT') {
    const id = url.split('/')[2];
    const actual = db.find('compromisos', id) as Compromiso | undefined;
    if (!actual) throw new MockHttpError(404, 'Compromiso no encontrado');
    const updates = body as Partial<Compromiso>;
    const compromiso = db.update('compromisos', id, {
      ...updates,
      bitacora: [
        ...actual.bitacora,
        {
          ts: new Date().toISOString(),
          user: 'TESORERO',
          action: 'Compromiso actualizado',
          after: updates
        }
      ]
    } as Compromiso);
    return withDelay(() => ({ status: 200, data: compromiso }));
  }

  if (url?.startsWith('/compromisos/') && method === 'POST') {
    const [, , id, action] = url.split('/');
    if (action !== 'transition') throw new MockHttpError(404, 'Acción no encontrada');
    const actual = db.find('compromisos', id) as Compromiso | undefined;
    if (!actual) throw new MockHttpError(404, 'Compromiso no encontrado');
    const { estatus, motivo, refPago, fechaPago } = body as {
      estatus: Compromiso['estatus'];
      motivo?: string;
      refPago?: string;
      fechaPago?: string;
    };
    const permitidos = compromisoTransitions[actual.estatus] ?? [];
    if (!permitidos.includes(estatus)) {
      throw new MockHttpError(422, 'Transición no permitida', 'Unprocessable Entity', { actual: actual.estatus, destino: estatus });
    }
    if (estatus === 'RECHAZADO' && !motivo) {
      throw new MockHttpError(422, 'Debe capturar el motivo del rechazo');
    }
    const bitacoraEntry = {
      ts: new Date().toISOString(),
      user: 'TESORERO',
      action: `Cambio de estatus ${actual.estatus} → ${estatus}`,
      after: { motivo, refPago, fechaPago }
    };
    const compromiso = db.update('compromisos', id, {
      estatus,
      refPago: refPago ?? actual.refPago,
      bitacora: [...actual.bitacora, bitacoraEntry]
    } as Compromiso);
    return withDelay(() => ({ status: 200, data: compromiso }));
  }

  if (url === '/presupuesto' && method === 'GET') {
    const presupuesto = aggregatePresupuesto();
    return withDelay(() => ({ status: 200, data: presupuesto }));
  }

  if (url === '/presupuesto/modificaciones' && method === 'POST') {
    const { partida, monto, motivo } = body as { partida: string; monto: number; motivo: string };
    const presupuesto = db.list('presupuesto') as Presupuesto;
    const partidaIdx = presupuesto.partidas.findIndex((item) => item.clave === partida);
    if (partidaIdx === -1) throw new MockHttpError(404, 'Partida no encontrada');
    presupuesto.partidas[partidaIdx].disponible += monto;
    presupuesto.actualizado = new Date().toISOString();
    const updated = db.update('presupuesto', presupuesto.id, presupuesto as unknown as Presupuesto);
    return withDelay(() => ({ status: 200, data: { ...updated, motivo } }));
  }

  if (url === '/proveedores' && method === 'GET') {
    const proveedores = db.list('proveedores') as Proveedor[];
    const filtered = proveedores.filter((prov) =>
      params.q ? prov.nombre.toLowerCase().includes(String(params.q).toLowerCase()) : true
    );
    return withDelay(() => ({ status: 200, data: filtered }));
  }

  if (url === '/proveedores' && method === 'POST') {
    const proveedor = db.insert('proveedores', body as Proveedor);
    return withDelay(() => ({ status: 201, data: proveedor }));
  }

  if (url?.startsWith('/proveedores/') && method === 'PUT') {
    const id = url.split('/')[2];
    const proveedor = db.update('proveedores', id, body as Partial<Proveedor>);
    return withDelay(() => ({ status: 200, data: proveedor }));
  }

  if (url?.startsWith('/proveedores/') && method === 'DELETE') {
    const id = url.split('/')[2];
    db.delete('proveedores', id);
    return withDelay(() => ({ status: 204, data: null }));
  }

  if (url === '/bancos' && method === 'GET') {
    return withDelay(() => ({ status: 200, data: db.list('cuentas') as CuentaBancaria[] }));
  }

  if (url === '/bancos' && method === 'POST') {
    const cuenta = db.insert('cuentas', body as CuentaBancaria);
    return withDelay(() => ({ status: 201, data: cuenta }));
  }

  if (url?.startsWith('/bancos/') && method === 'PUT') {
    const id = url.split('/')[2];
    const cuenta = db.update('cuentas', id, body as Partial<CuentaBancaria>);
    return withDelay(() => ({ status: 200, data: cuenta }));
  }

  if (url === '/movimientos' && method === 'GET') {
    const movimientos = db.list('movimientos') as MovimientoBancario[];
    const filtered = movimientos.filter((mov) => {
      const matchCuenta = params.cuentaId ? mov.cuentaId === params.cuentaId : true;
      const matchConciliado = params.conciliado !== undefined ? mov.conciliado === (params.conciliado === 'true') : true;
      return matchCuenta && matchConciliado;
    });
    return withDelay(() => ({ status: 200, data: filtered }));
  }

  if (url === '/movimientos' && method === 'POST') {
    const movimiento = db.insert('movimientos', body as MovimientoBancario);
    return withDelay(() => ({ status: 201, data: movimiento }));
  }

  if (url === '/movimientos/import' && method === 'POST') {
    const lista = body as MovimientoBancario[];
    const registros = lista.map((mov) => db.insert('movimientos', mov));
    return withDelay(() => ({ status: 201, data: registros }));
  }

  if (url?.startsWith('/movimientos/') && method === 'PUT') {
    const id = url.split('/')[2];
    const movimiento = db.update('movimientos', id, body as Partial<MovimientoBancario>);
    return withDelay(() => ({ status: 200, data: movimiento }));
  }

  if (url === '/conciliacion/match' && method === 'POST') {
    const { ids, conciliado } = body as { ids: string[]; conciliado: boolean };
    ids.forEach((id) => {
      try {
        db.update('movimientos', id, { conciliado });
      } catch (error) {
        // ignorar registros inexistentes en la simulación
      }
    });
    return withDelay(() => ({ status: 200, data: ids }));
  }

  if (url === '/reportes' && method === 'GET') {
    const ingresos = db.list('ingresos') as Ingreso[];
    const egresos = db.list('egresos') as Egreso[];
    const compromisos = db.list('compromisos') as Compromiso[];
    const filtroCuenta = params.cuentaId ? String(params.cuentaId) : null;
    const filtroCapitulo = params.capitulo ? String(params.capitulo) : null;
    const fechaInicio = params.fechaInicio ? dayjs(String(params.fechaInicio)) : null;
    const fechaFin = params.fechaFin ? dayjs(String(params.fechaFin)) : null;

    const filtrarFecha = (fecha: string) =>
      (!fechaInicio || dayjs(fecha).isSameOrAfter(fechaInicio, 'day')) &&
      (!fechaFin || dayjs(fecha).isSameOrBefore(fechaFin, 'day'));

    const libroIngresos = ingresos
      .filter((ing) => filtrarFecha(ing.fecha) && (!filtroCuenta || ing.cuentaId === filtroCuenta))
      .map((ing) => ({ tipo: 'Ingreso', fecha: ing.fecha, concepto: ing.concepto, importe: ing.importe }));

    const libroEgresos = egresos
      .filter((eg) => filtrarFecha(eg.fecha) && (!filtroCuenta || eg.cuentaId === filtroCuenta))
      .map((eg) => ({ tipo: 'Egreso', fecha: eg.fecha, concepto: eg.concepto, importe: eg.importe, proveedorId: eg.proveedorId }));

    const compromisosPorEstatus = compromisos.reduce<Record<string, { total: number; items: Compromiso[] }>>((acc, comp) => {
      if (!filtrarFecha(comp.fechaDocumento)) return acc;
      if (filtroCapitulo && comp.capitulo !== filtroCapitulo) return acc;
      const bucket = acc[comp.estatus] ?? { total: 0, items: [] };
      bucket.total += comp.importe;
      bucket.items.push(comp);
      acc[comp.estatus] = bucket;
      return acc;
    }, {});

    const flujoCaja = libroIngresos.reduce((sum, ingreso) => sum + ingreso.importe, 0) -
      libroEgresos.reduce((sum, egreso) => sum + egreso.importe, 0);

    return withDelay(() => ({
      status: 200,
      data: {
        libroIngresos,
        libroEgresos,
        compromisosPorEstatus,
        flujoCaja
      }
    }));
  }

  throw new MockHttpError(404, 'Recurso no encontrado');
};

// FILE: src/mocks/seeds.ts
import dayjs from 'dayjs';
import {
  Compromiso,
  CuentaBancaria,
  Egreso,
  Ingreso,
  MovimientoBancario,
  Presupuesto,
  Proveedor
} from '@treasury/types';

const today = dayjs();

const proveedores: Proveedor[] = [
  {
    id: 'prov-001',
    nombre: 'Servicios Urbanos del Bajío',
    rfc: 'SUB920304AB1',
    email: 'contacto@sub.com.mx',
    telefono: '4771234567',
    direccion: 'Calle Hidalgo 200, Centro'
  },
  {
    id: 'prov-002',
    nombre: 'Energía y Luz MX',
    rfc: 'ELM850912CD2',
    email: 'facturacion@energia.mx',
    telefono: '5556789012',
    direccion: 'Av. Reforma 789, CDMX'
  },
  {
    id: 'prov-003',
    nombre: 'Construcciones del Centro',
    rfc: 'CDC930405EF3',
    email: 'ventas@cdc.com',
    telefono: '4437890123',
    direccion: 'Circuito Interior 300, Morelia'
  },
  {
    id: 'prov-004',
    nombre: 'Papelería La Oficina',
    rfc: 'PLO010101GH4',
    email: 'ventas@papoficina.mx',
    telefono: '4493456789',
    direccion: 'Av. Universidad 123, Aguascalientes'
  },
  {
    id: 'prov-005',
    nombre: 'Tecnologías Municipales SA',
    rfc: 'TMS980716IJ5',
    email: 'soporte@tmunicipales.mx',
    telefono: '5512345678',
    direccion: 'Insurgentes Sur 1600, CDMX'
  }
];

const cuentas: CuentaBancaria[] = [
  {
    id: 'CTA-001',
    banco: 'BBVA',
    clabe: '012345678901234567',
    moneda: 'MXN',
    nombre: 'Cuenta Recaudadora',
    saldo: 575_450.32
  },
  {
    id: 'CTA-002',
    banco: 'Santander',
    clabe: '014785236954123456',
    moneda: 'MXN',
    nombre: 'Participaciones Federales',
    saldo: 1_245_890.54
  },
  {
    id: 'CTA-003',
    banco: 'Banorte',
    clabe: '072691005284765432',
    moneda: 'MXN',
    nombre: 'Obra Pública Municipal',
    saldo: 980_120.0
  }
];

const ingresos: Ingreso[] = Array.from({ length: 12 }).map((_, idx) => {
  const fecha = today.subtract(idx, 'day');
  const importe = 15_000 + idx * 750;
  return {
    id: `ing-${idx + 1}`,
    fecha: fecha.format('YYYY-MM-DD'),
    concepto: idx % 2 === 0 ? 'Cobro de impuesto predial' : 'Derechos por licencias',
    importe,
    fuente: idx % 2 === 0 ? 'Predial' : 'Licencias',
    referencia: `REF-${1000 + idx}`,
    cuentaId: idx % 2 === 0 ? 'CTA-001' : 'CTA-002',
    partida: idx % 2 === 0 ? '11501' : '13202',
    capitulo: idx % 2 === 0 ? '1000' : '3000',
    bitacora: [
      {
        ts: fecha.hour(8).toISOString(),
        user: 'TESORERO',
        action: 'CAPTURADO'
      }
    ]
  };
});

const egresos: Egreso[] = Array.from({ length: 10 }).map((_, idx) => {
  const fecha = today.subtract(idx + 2, 'day');
  const proveedor = proveedores[idx % proveedores.length];
  const importe = 12_500 + idx * 1_250;
  return {
    id: `eg-${idx + 1}`,
    fecha: fecha.format('YYYY-MM-DD'),
    concepto: idx % 2 === 0 ? 'Pago de servicios básicos' : 'Adquisición de equipo',
    importe,
    proveedorId: proveedor.id,
    uuid: idx % 3 === 0 ? `9e3b0c0a-120${idx}-4d3b-87ab-1234567890ab` : undefined,
    cuentaId: idx % 2 === 0 ? 'CTA-002' : 'CTA-003',
    partida: idx % 2 === 0 ? '21301' : '33502',
    capitulo: idx % 2 === 0 ? '2000' : '3000',
    estatus: idx % 3 === 0 ? 'PAGADO' : 'PENDIENTE',
    refPago: idx % 3 === 0 ? `TR-${3000 + idx}` : undefined,
    bitacora: [
      {
        ts: fecha.hour(9).toISOString(),
        user: 'TESORERO',
        action: 'REGISTRADO'
      }
    ]
  };
});

const compromisos: Compromiso[] = Array.from({ length: 8 }).map((_, idx) => {
  const fechaDocumento = today.subtract(idx + 5, 'day');
  const proveedor = proveedores[idx % proveedores.length];
  const estatusSequence: Compromiso['estatus'][] = [
    'BORRADOR',
    'REVISION',
    'AUTORIZADO',
    'PAGADO',
    'CERRADO'
  ];
  const estatus = estatusSequence[Math.min(estatusSequence.length - 1, idx)];
  return {
    id: `comp-${idx + 1}`,
    proveedor,
    uuid: `1d84fa3${idx}-0b8a-4c4b-97ae-b0f9bfb6b4${idx}`,
    concepto: idx % 2 === 0 ? 'Adquisición de luminarias LED' : 'Mantenimiento preventivo a vehículos',
    importe: 45_000 + idx * 5_500,
    partida: idx % 2 === 0 ? '33501' : '21201',
    capitulo: idx % 2 === 0 ? '3000' : '2000',
    fechaDocumento: fechaDocumento.format('YYYY-MM-DD'),
    fechaProgramada: fechaDocumento.add(7, 'day').format('YYYY-MM-DD'),
    estatus,
    banco: idx % 2 === 0 ? 'BBVA' : 'Santander',
    refPago: idx > 2 ? `PAY-${idx + 100}` : undefined,
    adjuntos: [
      {
        id: `adj-${idx + 1}`,
        name: `comprobante-${idx + 1}.pdf`
      }
    ],
    bitacora: [
      {
        ts: fechaDocumento.toISOString(),
        user: 'TESORERO',
        action: 'CREADO'
      }
    ]
  };
});

const presupuesto: Presupuesto = {
  id: 'pres-2025',
  ejercicio: today.year(),
  actualizado: today.toISOString(),
  partidas: [
    { clave: '1000', capitulo: '1000', nombre: 'Servicios Personales', disponible: 2_500_000 },
    { clave: '2000', capitulo: '2000', nombre: 'Materiales y Suministros', disponible: 1_250_000 },
    { clave: '21301', capitulo: '2000', nombre: 'Energía eléctrica', disponible: 450_000 },
    { clave: '3000', capitulo: '3000', nombre: 'Servicios Generales', disponible: 1_800_000 },
    { clave: '33501', capitulo: '3000', nombre: 'Arrendamientos', disponible: 950_000 },
    { clave: '4000', capitulo: '4000', nombre: 'Transferencias y Subsidios', disponible: 600_000 }
  ]
};

const movimientos: MovimientoBancario[] = [
  {
    id: 'mov-001',
    cuentaId: 'CTA-001',
    fecha: today.subtract(1, 'day').format('YYYY-MM-DD'),
    concepto: 'DEPÓSITO PREDIAL',
    importe: 12_500,
    tipo: 'ABONO',
    ref: 'PDL-90812',
    conciliado: false
  },
  {
    id: 'mov-002',
    cuentaId: 'CTA-001',
    fecha: today.subtract(2, 'day').format('YYYY-MM-DD'),
    concepto: 'PAGO CFE',
    importe: -3_560.75,
    tipo: 'CARGO',
    ref: 'EG-77123',
    conciliado: false
  },
  {
    id: 'mov-003',
    cuentaId: 'CTA-002',
    fecha: today.subtract(3, 'day').format('YYYY-MM-DD'),
    concepto: 'PARTICIPACIONES FEDERALES',
    importe: 480_000,
    tipo: 'ABONO',
    ref: 'PART-SEP',
    conciliado: true
  }
];

export const seeds = {
  ingresos,
  egresos,
  compromisos,
  presupuesto,
  proveedores,
  cuentas,
  movimientos
};

// FILE: src/mocks/data/conciliacion_ejemplo.csv
fecha,concepto,importe,tipo,ref,cuenta
2025-09-01,DEPÓSITO PREDIAL,12500.00,ABONO,PDL-90812,CTA-001
2025-09-02,PAGO PROVEEDOR LUZ,-3560.75,CARGO,EG-77123,CTA-001
2025-09-05,TRANSFERENCIA PARTICIPACIONES,480000.00,ABONO,PART-SEP,CTA-002
2025-09-06,PAGO CONSTRUCCIÓN PARQUE,-185000.00,CARGO,OBR-55221,CTA-002
2025-09-08,COMISIÓN BANCARIA,-95.00,CARGO,COM-00045,CTA-001

// FILE: src/mocks/data/movimientos_ejemplo.csv
cuenta,fecha,concepto,tipo,importe,ref,conciliado
CTA-001,2025-09-01,DEPÓSITO PREDIAL,ABONO,12500.00,PDL-90812,false
CTA-001,2025-09-02,PAGO CFE,CARGO,-3560.75,EG-77123,false
CTA-002,2025-09-05,PARTICIPACIONES FEDERALES,ABONO,480000.00,PART-SEP,true
CTA-002,2025-09-06,PAGO OBRA PARQUE,CARGO,-185000.00,OBR-55221,false
CTA-001,2025-09-08,COMISIÓN BANCARIA,CARGO,-95.00,COM-00045,true

// FILE: src/pages/NotFound.tsx
import { Link } from 'react-router-dom';
import { Button } from '@shared/components/ui/button';

export const NotFound = () => (
  <div className="flex min-h-screen flex-col items-center justify-center gap-4">
    <h1 className="text-4xl font-bold">404</h1>
    <p className="text-sm text-muted-foreground">Ruta no encontrada dentro del módulo de Tesorería.</p>
    <Button asChild>
      <Link to="/tesoreria/dashboard">Regresar al dashboard</Link>
    </Button>
  </div>
);

// FILE: src/shared/__tests__/validators.test.ts
import { describe, expect, it } from 'vitest';
import { validateUUID, validateRFC, validatePositiveAmount } from '@shared/lib/validators';

describe('Validadores de Tesorería', () => {
  it('valida correctamente un UUID', () => {
    expect(validateUUID('123e4567-e89b-12d3-a456-426614174000')).toBe(true);
    expect(validateUUID('invalid')).not.toBe(true);
  });

  it('valida el formato de RFC', () => {
    expect(validateRFC('ABC010203XYZ')).toBe(true);
    expect(validateRFC('ABC123')).not.toBe(true);
  });

  it('requiere importes positivos con dos decimales', () => {
    expect(validatePositiveAmount(100.5)).toBe(true);
    expect(validatePositiveAmount(0)).not.toBe(true);
    expect(validatePositiveAmount(-10)).not.toBe(true);
    expect(validatePositiveAmount(10.123)).not.toBe(true);
  });
});

// FILE: src/shared/components/AuditTrail.tsx
import { formatDate } from '../lib/utils';

interface AuditTrailEntry {
  ts: string;
  user: string;
  action: string;
  before?: unknown;
  after?: unknown;
}

interface AuditTrailProps {
  entries: AuditTrailEntry[];
}

export const AuditTrail = ({ entries }: AuditTrailProps) => {
  if (!entries?.length) {
    return <p className="text-sm text-muted-foreground">Sin movimientos registrados.</p>;
  }
  return (
    <ol className="space-y-3">
      {entries.map((entry) => (
        <li key={`${entry.ts}-${entry.action}`} className="rounded-lg border border-dashed border-border p-3">
          <div className="flex items-center justify-between text-xs text-muted-foreground">
            <span>{formatDate(entry.ts)}</span>
            <span>{entry.user}</span>
          </div>
          <p className="mt-1 text-sm font-medium text-foreground">{entry.action}</p>
          {entry.before || entry.after ? (
            <pre className="mt-2 overflow-x-auto rounded bg-muted/20 p-2 text-xs text-muted-foreground">
              {JSON.stringify({ before: entry.before, after: entry.after }, null, 2)}
            </pre>
          ) : null}
        </li>
      ))}
    </ol>
  );
};

// FILE: src/shared/components/CFDIViewer.tsx
import { Button } from './ui/button';
import { Badge } from './ui/badge';

interface CFDIViewerProps {
  uuid: string;
  xmlUrl?: string;
  pdfUrl?: string;
}

export const CFDIViewer = ({ uuid, xmlUrl, pdfUrl }: CFDIViewerProps) => {
  return (
    <div className="space-y-3 rounded-lg border border-border p-4">
      <div className="flex items-center justify-between">
        <div>
          <p className="text-sm font-medium">UUID</p>
          <p className="text-xs text-muted-foreground">{uuid}</p>
        </div>
        <Badge variant="outline">CFDI 3.3</Badge>
      </div>
      <div className="flex flex-wrap gap-2">
        <Button type="button" variant="outline" disabled={!xmlUrl} onClick={() => xmlUrl && window.open(xmlUrl, '_blank')?.focus()}>
          Ver XML
        </Button>
        <Button type="button" variant="outline" disabled={!pdfUrl} onClick={() => pdfUrl && window.open(pdfUrl, '_blank')?.focus()}>
          Ver PDF
        </Button>
      </div>
      <p className="text-xs text-muted-foreground">Documentos demostrativos cargados en este compromiso.</p>
    </div>
  );
};

// FILE: src/shared/components/DataTable.tsx
import { useMemo, useState } from 'react';
import {
  ColumnDef,
  flexRender,
  getCoreRowModel,
  getFilteredRowModel,
  getPaginationRowModel,
  useReactTable
} from '@tanstack/react-table';
import { Button } from './ui/button';
import { Input } from './ui/input';
import { Checkbox } from './ui/checkbox';
import { cn } from '../lib/utils';

export interface BulkAction<T> {
  label: string;
  onClick: (rows: T[]) => void;
}

interface DataTableProps<TData> {
  data: TData[];
  columns: ColumnDef<TData, any>[];
  searchPlaceholder?: string;
  onRowClick?: (row: TData) => void;
  bulkActions?: BulkAction<TData>[];
  manualFilterComponent?: React.ReactNode;
}

export function DataTable<TData>(props: DataTableProps<TData>) {
  const { data, columns, searchPlaceholder, onRowClick, bulkActions, manualFilterComponent } = props;
  const [globalFilter, setGlobalFilter] = useState('');
  const [rowSelection, setRowSelection] = useState<Record<string, boolean>>({});

  const table = useReactTable({
    data,
    columns,
    state: {
      globalFilter,
      rowSelection
    },
    enableRowSelection: Boolean(bulkActions?.length),
    onRowSelectionChange: setRowSelection,
    onGlobalFilterChange: setGlobalFilter,
    getCoreRowModel: getCoreRowModel(),
    getFilteredRowModel: getFilteredRowModel(),
    getPaginationRowModel: getPaginationRowModel()
  });

  const selectionRows = useMemo(
    () => table.getSelectedRowModel().flatRows.map((row) => row.original),
    [table]
  );

  const renderSelectionColumn = Boolean(bulkActions?.length);

  return (
    <div className="space-y-3">
      <div className="flex flex-wrap items-center gap-2">
        {bulkActions && bulkActions.length > 0 ? (
          <div className="flex items-center gap-2">
            {bulkActions.map((action) => (
              <Button
                key={action.label}
                variant="outline"
                size="sm"
                onClick={() => action.onClick(selectionRows)}
                disabled={selectionRows.length === 0}
              >
                {action.label}
              </Button>
            ))}
          </div>
        ) : null}
        {manualFilterComponent}
        {searchPlaceholder ? (
          <Input
            placeholder={searchPlaceholder}
            value={globalFilter ?? ''}
            onChange={(event) => setGlobalFilter(event.target.value)}
            className="ml-auto w-full max-w-xs"
          />
        ) : null}
      </div>
      <div className="overflow-hidden rounded-lg border border-border">
        <table className="w-full min-w-full text-sm">
          <thead className="bg-muted/30 text-xs uppercase tracking-wide text-muted-foreground">
            {table.getHeaderGroups().map((headerGroup) => (
              <tr key={headerGroup.id}>
                {renderSelectionColumn ? (
                  <th className="w-8 px-2 py-2">
                    <Checkbox
                      aria-label="Seleccionar todos"
                      checked={table.getIsAllPageRowsSelected()}
                      indeterminate={table.getIsSomePageRowsSelected()}
                      onCheckedChange={(value) => table.toggleAllPageRowsSelected(Boolean(value))}
                    />
                  </th>
                ) : null}
                {headerGroup.headers.map((header) => (
                  <th key={header.id} className="px-3 py-2 text-left">
                    {header.isPlaceholder ? null : flexRender(header.column.columnDef.header, header.getContext())}
                  </th>
                ))}
              </tr>
            ))}
          </thead>
          <tbody>
            {table.getRowModel().rows.length === 0 ? (
              <tr>
                <td colSpan={columns.length + (renderSelectionColumn ? 1 : 0)} className="px-4 py-6 text-center text-muted-foreground">
                  No se encontraron registros con los filtros aplicados.
                </td>
              </tr>
            ) : (
              table.getRowModel().rows.map((row) => (
                <tr
                  key={row.id}
                  className={cn(
                    'border-t border-border/80 transition-colors hover:bg-muted/20',
                    row.getIsSelected() && 'bg-primary/5'
                  )}
                  onClick={() => onRowClick?.(row.original)}
                >
                  {renderSelectionColumn ? (
                    <td className="px-2 py-2" onClick={(event) => event.stopPropagation()}>
                      <Checkbox
                        checked={row.getIsSelected()}
                        onCheckedChange={(value) => row.toggleSelected(Boolean(value))}
                        aria-label="Seleccionar fila"
                      />
                    </td>
                  ) : null}
                  {row.getVisibleCells().map((cell) => (
                    <td key={cell.id} className="px-3 py-2 align-middle">
                      {flexRender(cell.column.columnDef.cell, cell.getContext())}
                    </td>
                  ))}
                </tr>
              ))
            )}
          </tbody>
        </table>
      </div>
      <div className="flex items-center justify-between text-xs text-muted-foreground">
        {renderSelectionColumn ? (
          <span>{selectionRows.length} seleccionados</span>
        ) : (
          <span />
        )}
        <div className="flex items-center gap-1">
          <Button variant="ghost" size="sm" onClick={() => table.previousPage()} disabled={!table.getCanPreviousPage()}>
            Anterior
          </Button>
          <span>
            Página {table.getState().pagination.pageIndex + 1} de {table.getPageCount() || 1}
          </span>
          <Button variant="ghost" size="sm" onClick={() => table.nextPage()} disabled={!table.getCanNextPage()}>
            Siguiente
          </Button>
        </div>
      </div>
    </div>
  );
}

// FILE: src/shared/components/PanelLateral.tsx
import { ReactNode, useEffect } from 'react';
import { Button } from './ui/button';

interface PanelLateralProps {
  title: string;
  description?: string;
  open: boolean;
  onClose: () => void;
  children: ReactNode;
}

export const PanelLateral = ({ title, description, open, onClose, children }: PanelLateralProps) => {
  useEffect(() => {
    const handler = (event: KeyboardEvent) => {
      if (event.key === 'Escape') onClose();
    };
    window.addEventListener('keydown', handler);
    return () => window.removeEventListener('keydown', handler);
  }, [onClose]);

  if (!open) return null;

  return (
    <div className="fixed inset-0 z-50 flex">
      <div className="absolute inset-0 bg-slate-900/60" aria-hidden onClick={onClose} />
      <aside className="ml-auto flex h-full w-full max-w-xl flex-col overflow-y-auto bg-white p-6 shadow-2xl">
        <header className="mb-4 flex items-start justify-between gap-4">
          <div>
            <h2 className="text-lg font-semibold">{title}</h2>
            {description ? <p className="text-sm text-muted-foreground">{description}</p> : null}
          </div>
          <Button variant="ghost" onClick={onClose} aria-label="Cerrar panel">
            Cerrar
          </Button>
        </header>
        <div className="space-y-4">{children}</div>
      </aside>
    </div>
  );
};

// FILE: src/shared/components/StatusBadge.tsx
import React from 'react';
import { Badge } from './ui/badge';

const statusVariants: Record<string, { label: string; variant: React.ComponentProps<typeof Badge>['variant'] }> = {
  BORRADOR: { label: 'Borrador', variant: 'outline' },
  REVISION: { label: 'En revisión', variant: 'warning' },
  RECHAZADO: { label: 'Rechazado', variant: 'destructive' },
  AUTORIZADO: { label: 'Autorizado', variant: 'success' },
  PAGADO: { label: 'Pagado', variant: 'success' },
  CERRADO: { label: 'Cerrado', variant: 'default' },
  PENDIENTE: { label: 'Pendiente', variant: 'warning' }
};

export const StatusBadge = ({ status }: { status: string }) => {
  const mapping = statusVariants[status] ?? { label: status, variant: 'outline' };
  return <Badge variant={mapping.variant}>{mapping.label}</Badge>;
};

// FILE: src/shared/components/ToastContainer.tsx
import { useToast } from '../hooks/useToast';
import { cn } from '../lib/utils';

const variantStyles: Record<string, string> = {
  default: 'border border-border bg-background/95 backdrop-blur text-foreground',
  destructive: 'border border-red-200 bg-red-50 text-red-700',
  success: 'border border-emerald-200 bg-emerald-50 text-emerald-700',
  warning: 'border border-amber-200 bg-amber-50 text-amber-700'
};

export const ToastContainer = () => {
  const { toasts } = useToast();
  return (
    <div className="fixed inset-x-0 top-4 z-[100] flex justify-center px-4">
      <div className="flex w-full max-w-md flex-col gap-2">
        {toasts.map((item) => (
          <div
            key={item.id}
            role="status"
            className={cn(
              'rounded-lg px-4 py-3 shadow-lg transition-all',
              variantStyles[item.variant ?? 'default']
            )}
          >
            <p className="text-sm font-semibold">{item.title}</p>
            {item.description ? <p className="text-xs text-muted-foreground">{item.description}</p> : null}
          </div>
        ))}
      </div>
    </div>
  );
};

// FILE: src/shared/components/Uploader.tsx
import { useRef } from 'react';
import { Button } from './ui/button';
import { validateFile } from '../lib/validators';
import { toast } from '../hooks/useToast';

interface UploaderProps {
  accept?: string;
  maxSizeMB?: number;
  onFiles: (files: File[]) => void;
  onRemove?: (fileName: string) => void;
  files?: { name: string; size: number }[];
}

export const Uploader = ({ accept, maxSizeMB = 5, onFiles, files = [], onRemove }: UploaderProps) => {
  const inputRef = useRef<HTMLInputElement | null>(null);

  const trigger = () => inputRef.current?.click();

  const handleFiles = (fileList: FileList | null) => {
    if (!fileList) return;
    const parsed: File[] = [];
    Array.from(fileList).forEach((file) => {
      const validation = validateFile(file, maxSizeMB);
      if (validation === true) {
        parsed.push(file);
      } else {
        toast({ title: 'Archivo no válido', description: validation, variant: 'warning' });
      }
    });
    if (parsed.length > 0) {
      onFiles(parsed);
    }
  };

  return (
    <div className="space-y-2">
      <input
        ref={inputRef}
        type="file"
        multiple
        className="hidden"
        accept={accept}
        onChange={(event) => handleFiles(event.target.files)}
      />
      <Button type="button" variant="outline" onClick={trigger}>
        Cargar archivos
      </Button>
      <ul className="space-y-1 text-sm text-muted-foreground">
        {files.map((file) => (
          <li key={file.name} className="flex items-center justify-between rounded border border-dashed border-border px-2 py-1">
            <span>
              {file.name}{' '}
              <span className="text-xs">({(file.size / (1024 * 1024)).toFixed(2)} MB)</span>
            </span>
            {onRemove ? (
              <button type="button" className="text-xs text-primary" onClick={() => onRemove(file.name)}>
                Quitar
              </button>
            ) : null}
          </li>
        ))}
      </ul>
    </div>
  );
};

// FILE: src/shared/components/Wizard.tsx
import { useState } from 'react';
import { Button } from './ui/button';
import { cn } from '../lib/utils';

export interface WizardStep<Props extends Record<string, any> = Record<string, any>> {
  id: string;
  title: string;
  description?: string;
  content: (props: Props & { onChange: (values: Partial<Props>) => void }) => React.ReactNode;
  validator?: (values: Props) => string | true;
}

interface WizardProps<Props extends Record<string, any>> {
  steps: WizardStep<Props>[];
  initialValues: Props;
  onFinish: (values: Props) => Promise<void> | void;
  autosave?: (values: Props) => void;
}

export function Wizard<Props extends Record<string, any>>(props: WizardProps<Props>) {
  const { steps, initialValues, onFinish, autosave } = props;
  const [values, setValues] = useState<Props>(initialValues);
  const [activeIndex, setActiveIndex] = useState(0);
  const [error, setError] = useState<string | null>(null);
  const isLast = activeIndex === steps.length - 1;
  const activeStep = steps[activeIndex];

  const handleNext = async () => {
    const validation = activeStep.validator?.(values) ?? true;
    if (validation !== true) {
      setError(validation);
      return;
    }
    setError(null);
    if (isLast) {
      await onFinish(values);
      return;
    }
    setActiveIndex((prev) => Math.min(prev + 1, steps.length - 1));
    autosave?.(values);
  };

  const handlePrev = () => {
    setActiveIndex((prev) => Math.max(prev - 1, 0));
  };

  const onChange = (patch: Partial<Props>) => {
    setValues((prev) => {
      const next = { ...prev, ...patch } as Props;
      autosave?.(next);
      return next;
    });
  };

  return (
    <div className="space-y-4">
      <ol className="flex flex-col gap-2 md:flex-row md:items-center md:gap-4">
        {steps.map((step, index) => (
          <li key={step.id} className="flex items-center gap-3">
            <span
              className={cn(
                'flex h-8 w-8 items-center justify-center rounded-full border text-sm font-semibold',
                index === activeIndex && 'border-primary text-primary',
                index < activeIndex && 'border-emerald-500 bg-emerald-500 text-white'
              )}
            >
              {index + 1}
            </span>
            <div>
              <p className="text-sm font-medium">{step.title}</p>
              {step.description ? <p className="text-xs text-muted-foreground">{step.description}</p> : null}
            </div>
          </li>
        ))}
      </ol>
      <div className="rounded-lg border border-dashed border-border p-4">
        {activeStep.content({ ...(values as Props & { onChange: (values: Partial<Props>) => void }), onChange })}
      </div>
      {error ? <p className="text-sm text-red-600">{error}</p> : null}
      <div className="flex items-center justify-between">
        <Button variant="outline" onClick={handlePrev} disabled={activeIndex === 0}>
          Anterior
        </Button>
        <Button onClick={handleNext}>{isLast ? 'Finalizar' : 'Siguiente'}</Button>
      </div>
    </div>
  );
}

// FILE: src/shared/components/ui/avatar.tsx
import * as React from 'react';
import * as AvatarPrimitive from '@radix-ui/react-avatar';
import { cn } from '../../lib/utils';

const Avatar = React.forwardRef<
  React.ElementRef<typeof AvatarPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Root>
>(({ className, ...props }, ref) => (
  <AvatarPrimitive.Root ref={ref} className={cn('relative flex h-9 w-9 shrink-0 overflow-hidden rounded-full', className)} {...props} />
));
Avatar.displayName = AvatarPrimitive.Root.displayName;

const AvatarImage = React.forwardRef<
  React.ElementRef<typeof AvatarPrimitive.Image>,
  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Image>
>(({ className, ...props }, ref) => (
  <AvatarPrimitive.Image ref={ref} className={cn('aspect-square h-full w-full', className)} {...props} />
));
AvatarImage.displayName = AvatarPrimitive.Image.displayName;

const AvatarFallback = React.forwardRef<
  React.ElementRef<typeof AvatarPrimitive.Fallback>,
  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Fallback>
>(({ className, ...props }, ref) => (
  <AvatarPrimitive.Fallback
    ref={ref}
    className={cn('flex h-full w-full items-center justify-center rounded-full bg-muted text-sm font-medium', className)}
    {...props}
  />
));
AvatarFallback.displayName = AvatarPrimitive.Fallback.displayName;

export { Avatar, AvatarImage, AvatarFallback };

// FILE: src/shared/components/ui/badge.tsx
import { cva, type VariantProps } from 'class-variance-authority';
import { cn } from '../../lib/utils';

const badgeVariants = cva(
  'inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold',
  {
    variants: {
      variant: {
        default: 'border-transparent bg-primary/10 text-primary',
        success: 'border-transparent bg-emerald-100 text-emerald-700',
        warning: 'border-transparent bg-amber-100 text-amber-700',
        destructive: 'border-transparent bg-red-100 text-red-700',
        outline: 'text-foreground'
      }
    },
    defaultVariants: {
      variant: 'default'
    }
  }
);

export interface BadgeProps extends React.HTMLAttributes<HTMLDivElement>, VariantProps<typeof badgeVariants> {}

export const Badge = ({ className, variant, ...props }: BadgeProps) => (
  <div className={cn(badgeVariants({ variant }), className)} {...props} />
);

// FILE: src/shared/components/ui/breadcrumb.tsx
import { Slash } from 'lucide-react';
import { cn } from '../../lib/utils';

export const Breadcrumb = ({ items }: { items: string[] }) => {
  if (!items?.length) return null;
  return (
    <nav aria-label="Breadcrumb" className="flex items-center gap-1 text-sm text-muted-foreground">
      {items.map((item, index) => (
        <span key={`${item}-${index}`} className="flex items-center gap-1">
          <span className={cn(index === items.length - 1 && 'text-foreground font-medium')}>{item}</span>
          {index < items.length - 1 ? <Slash className="h-3 w-3 opacity-50" /> : null}
        </span>
      ))}
    </nav>
  );
};

// FILE: src/shared/components/ui/button.tsx
import * as React from 'react';
import { Slot } from '@radix-ui/react-slot';
import { cva, type VariantProps } from 'class-variance-authority';
import { cn } from '../../lib/utils';

const buttonVariants = cva(
  'inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-60 ring-offset-background',
  {
    variants: {
      variant: {
        default: 'bg-primary text-primary-foreground shadow hover:bg-primary/90',
        secondary: 'bg-secondary text-secondary-foreground hover:bg-secondary/80',
        outline: 'border border-input bg-background hover:bg-accent hover:text-accent-foreground',
        ghost: 'hover:bg-accent hover:text-accent-foreground',
        destructive: 'bg-destructive text-destructive-foreground hover:bg-destructive/90',
        subtle: 'bg-muted/10 text-foreground hover:bg-muted/20'
      },
      size: {
        default: 'h-10 px-4 py-2',
        sm: 'h-8 px-3 text-xs',
        lg: 'h-11 px-8 text-base',
        icon: 'h-10 w-10'
      }
    },
    defaultVariants: {
      variant: 'default',
      size: 'default'
    }
  }
);

export interface ButtonProps
  extends React.ButtonHTMLAttributes<HTMLButtonElement>,
    VariantProps<typeof buttonVariants> {
  asChild?: boolean;
}

const Button = React.forwardRef<HTMLButtonElement, ButtonProps>((props, ref) => {
  const { className, variant, size, asChild = false, ...rest } = props;
  const Comp = asChild ? Slot : 'button';
  return (
    <Comp ref={ref} className={cn(buttonVariants({ variant, size, className }))} {...rest} />
  );
});
Button.displayName = 'Button';

export { Button, buttonVariants };

// FILE: src/shared/components/ui/card.tsx
import * as React from 'react';
import { cn } from '../../lib/utils';

const Card = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
  ({ className, ...props }, ref) => (
    <div
      ref={ref}
      className={cn('rounded-xl border border-border bg-card text-card-foreground shadow-sm', className)}
      {...props}
    />
  )
);
Card.displayName = 'Card';

const CardHeader = ({ className, ...props }: React.HTMLAttributes<HTMLDivElement>) => (
  <div className={cn('flex flex-col space-y-1.5 p-6', className)} {...props} />
);

const CardTitle = ({ className, ...props }: React.HTMLAttributes<HTMLHeadingElement>) => (
  <h3 className={cn('text-lg font-semibold leading-none tracking-tight', className)} {...props} />
);

const CardDescription = ({ className, ...props }: React.HTMLAttributes<HTMLParagraphElement>) => (
  <p className={cn('text-sm text-muted-foreground', className)} {...props} />
);

const CardContent = ({ className, ...props }: React.HTMLAttributes<HTMLDivElement>) => (
  <div className={cn('p-6 pt-0', className)} {...props} />
);

const CardFooter = ({ className, ...props }: React.HTMLAttributes<HTMLDivElement>) => (
  <div className={cn('flex items-center p-6 pt-0', className)} {...props} />
);

export { Card, CardHeader, CardTitle, CardDescription, CardContent, CardFooter };

// FILE: src/shared/components/ui/checkbox.tsx
import * as React from 'react';
import * as CheckboxPrimitive from '@radix-ui/react-checkbox';
import { Check } from 'lucide-react';
import { cn } from '../../lib/utils';

const Checkbox = React.forwardRef<
  React.ElementRef<typeof CheckboxPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>
>(({ className, ...props }, ref) => (
  <CheckboxPrimitive.Root
    ref={ref}
    className={cn(
      'peer h-4 w-4 shrink-0 rounded border border-input bg-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground',
      className
    )}
    {...props}
  >
    <CheckboxPrimitive.Indicator className={cn('flex items-center justify-center text-current')}>
      <Check className="h-3 w-3" />
    </CheckboxPrimitive.Indicator>
  </CheckboxPrimitive.Root>
));
Checkbox.displayName = CheckboxPrimitive.Root.displayName;

export { Checkbox };

// FILE: src/shared/components/ui/dropdown-menu.tsx
import * as DropdownMenuPrimitive from '@radix-ui/react-dropdown-menu';
import { Check, ChevronRight, Circle } from 'lucide-react';
import { cn } from '../../lib/utils';

const DropdownMenu = DropdownMenuPrimitive.Root;
const DropdownMenuTrigger = DropdownMenuPrimitive.Trigger;
const DropdownMenuGroup = DropdownMenuPrimitive.Group;
const DropdownMenuPortal = DropdownMenuPrimitive.Portal;
const DropdownMenuSub = DropdownMenuPrimitive.Sub;
const DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup;

const DropdownMenuSubTrigger = ({
  className,
  inset,
  children,
  ...props
}: React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {
  inset?: boolean;
}) => (
  <DropdownMenuPrimitive.SubTrigger
    className={cn(
      'flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground',
      inset && 'pl-8',
      className
    )}
    {...props}
  >
    {children}
    <ChevronRight className="ml-auto h-4 w-4" />
  </DropdownMenuPrimitive.SubTrigger>
);

const DropdownMenuSubContent = ({ className, ...props }: React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>) => (
  <DropdownMenuPrimitive.SubContent
    className={cn(
      'z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg',
      className
    )}
    {...props}
  />
);

const DropdownMenuContent = ({ className, sideOffset = 4, ...props }: React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>) => (
  <DropdownMenuPrimitive.Portal>
    <DropdownMenuPrimitive.Content
      sideOffset={sideOffset}
      className={cn(
        'z-50 min-w-[12rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md',
        className
      )}
      {...props}
    />
  </DropdownMenuPrimitive.Portal>
);

const DropdownMenuItem = ({ className, inset, ...props }: React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {
  inset?: boolean;
}) => (
  <DropdownMenuPrimitive.Item
    className={cn(
      'relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground',
      inset && 'pl-8',
      className
    )}
    {...props}
  />
);

const DropdownMenuCheckboxItem = ({
  className,
  children,
  checked,
  ...props
}: React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>) => (
  <DropdownMenuPrimitive.CheckboxItem
    className={cn(
      'relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground',
      className
    )}
    checked={checked}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <DropdownMenuPrimitive.ItemIndicator>
        <Check className="h-4 w-4" />
      </DropdownMenuPrimitive.ItemIndicator>
    </span>
    {children}
  </DropdownMenuPrimitive.CheckboxItem>
);

const DropdownMenuRadioItem = ({ className, children, ...props }: React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>) => (
  <DropdownMenuPrimitive.RadioItem
    className={cn(
      'relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground',
      className
    )}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <DropdownMenuPrimitive.ItemIndicator>
        <Circle className="h-2 w-2 fill-current" />
      </DropdownMenuPrimitive.ItemIndicator>
    </span>
    {children}
  </DropdownMenuPrimitive.RadioItem>
);

const DropdownMenuLabel = ({ className, inset, ...props }: React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {
  inset?: boolean;
}) => (
  <DropdownMenuPrimitive.Label className={cn('px-2 py-1.5 text-sm font-semibold', inset && 'pl-8', className)} {...props} />
);

const DropdownMenuSeparator = ({ className, ...props }: React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>) => (
  <DropdownMenuPrimitive.Separator className={cn('-mx-1 my-1 h-px bg-border', className)} {...props} />
);

export {
  DropdownMenu,
  DropdownMenuTrigger,
  DropdownMenuGroup,
  DropdownMenuPortal,
  DropdownMenuSub,
  DropdownMenuSubTrigger,
  DropdownMenuSubContent,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuCheckboxItem,
  DropdownMenuRadioItem,
  DropdownMenuRadioGroup,
  DropdownMenuLabel,
  DropdownMenuSeparator
};

// FILE: src/shared/components/ui/input.tsx
import * as React from 'react';
import { cn } from '../../lib/utils';

export type InputProps = React.InputHTMLAttributes<HTMLInputElement>;

const Input = React.forwardRef<HTMLInputElement, InputProps>((props, ref) => {
  const { className, type, ...rest } = props;
  return (
    <input
      ref={ref}
      type={type}
      className={cn(
        'flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2',
        className
      )}
      {...rest}
    />
  );
});
Input.displayName = 'Input';

export { Input };

// FILE: src/shared/components/ui/label.tsx
import * as React from 'react';
import * as LabelPrimitive from '@radix-ui/react-label';
import { cn } from '../../lib/utils';

const Label = React.forwardRef<
  React.ElementRef<typeof LabelPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root>
>(({ className, ...props }, ref) => (
  <LabelPrimitive.Root
    ref={ref}
    className={cn('text-sm font-medium text-foreground', className)}
    {...props}
  />
));
Label.displayName = LabelPrimitive.Root.displayName;

export { Label };

// FILE: src/shared/components/ui/progress.tsx
import { cn } from '../../lib/utils';

interface ProgressProps {
  value: number;
  className?: string;
}

export const Progress = ({ value, className }: ProgressProps) => (
  <div className={cn('h-2 w-full overflow-hidden rounded-full bg-muted', className)}>
    <div
      className="h-full rounded-full bg-primary transition-all"
      style={{ width: `${Math.min(100, Math.max(0, value))}%` }}
      aria-valuenow={value}
      aria-valuemin={0}
      aria-valuemax={100}
      role="progressbar"
    />
  </div>
);

// FILE: src/shared/components/ui/scroll-area.tsx
import * as React from 'react';
import * as ScrollAreaPrimitive from '@radix-ui/react-scroll-area';
import { cn } from '../../lib/utils';

const ScrollArea = React.forwardRef<
  React.ElementRef<typeof ScrollAreaPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Root>
>(({ className, children, ...props }, ref) => (
  <ScrollAreaPrimitive.Root ref={ref} className={cn('relative overflow-hidden', className)} {...props}>
    <ScrollAreaPrimitive.Viewport className="h-full w-full rounded">
      {children}
    </ScrollAreaPrimitive.Viewport>
    <ScrollAreaPrimitive.Scrollbar
      orientation="vertical"
      className="flex touch-none select-none border-l border-border bg-background/60 p-[1px]"
    >
      <ScrollAreaPrimitive.Thumb className="relative flex-1 rounded-full bg-muted" />
    </ScrollAreaPrimitive.Scrollbar>
    <ScrollAreaPrimitive.Scrollbar
      orientation="horizontal"
      className="flex touch-none select-none border-t border-border bg-background/60 p-[1px]"
    >
      <ScrollAreaPrimitive.Thumb className="relative flex-1 rounded-full bg-muted" />
    </ScrollAreaPrimitive.Scrollbar>
    <ScrollAreaPrimitive.Corner className="bg-border" />
  </ScrollAreaPrimitive.Root>
));
ScrollArea.displayName = ScrollAreaPrimitive.Root.displayName;

export { ScrollArea };

// FILE: src/shared/components/ui/select.tsx
import * as React from 'react';
import * as SelectPrimitive from '@radix-ui/react-select';
import { Check, ChevronDown, ChevronUp } from 'lucide-react';
import { cn } from '../../lib/utils';

const Select = SelectPrimitive.Root;
const SelectGroup = SelectPrimitive.Group;
const SelectValue = SelectPrimitive.Value;

const SelectTrigger = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>
>(({ className, children, ...props }, ref) => (
  <SelectPrimitive.Trigger
    ref={ref}
    className={cn(
      'flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2',
      className
    }
    {...props}
  >
    {children}
    <SelectPrimitive.Icon asChild>
      <ChevronDown className="h-4 w-4 opacity-50" />
    </SelectPrimitive.Icon>
  </SelectPrimitive.Trigger>
));
SelectTrigger.displayName = SelectPrimitive.Trigger.displayName;

const SelectContent = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>
>(({ className, children, position = 'popper', ...props }, ref) => (
  <SelectPrimitive.Portal>
    <SelectPrimitive.Content
      ref={ref}
      className={cn(
        'relative z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-md',
        position === 'popper' && 'translate-y-1',
        className
      )}
      position={position}
      {...props}
    >
      <SelectPrimitive.ScrollUpButton className="flex cursor-default items-center justify-center py-1">
        <ChevronUp className="h-4 w-4" />
      </SelectPrimitive.ScrollUpButton>
      <SelectPrimitive.Viewport className="p-1">
        {children}
      </SelectPrimitive.Viewport>
      <SelectPrimitive.ScrollDownButton className="flex cursor-default items-center justify-center py-1">
        <ChevronDown className="h-4 w-4" />
      </SelectPrimitive.ScrollDownButton>
    </SelectPrimitive.Content>
  </SelectPrimitive.Portal>
));
SelectContent.displayName = SelectPrimitive.Content.displayName;

const SelectItem = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>
>(({ className, children, ...props }, ref) => (
  <SelectPrimitive.Item
    ref={ref}
    className={cn(
      'relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground',
      className
    )}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <SelectPrimitive.ItemIndicator>
        <Check className="h-4 w-4" />
      </SelectPrimitive.ItemIndicator>
    </span>
    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>
  </SelectPrimitive.Item>
));
SelectItem.displayName = SelectPrimitive.Item.displayName;

export { Select, SelectGroup, SelectValue, SelectTrigger, SelectContent, SelectItem };

// FILE: src/shared/components/ui/separator.tsx
import * as React from 'react';
import * as SeparatorPrimitive from '@radix-ui/react-separator';
import { cn } from '../../lib/utils';

const Separator = React.forwardRef<
  React.ElementRef<typeof SeparatorPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>
>(({ className, orientation = 'horizontal', decorative = false, ...props }, ref) => (
  <SeparatorPrimitive.Root
    ref={ref}
    decorative={decorative}
    orientation={orientation}
    className={cn(
      'shrink-0 bg-border',
      orientation === 'horizontal' ? 'h-px w-full' : 'h-full w-px',
      className
    )}
    {...props}
  />
));
Separator.displayName = SeparatorPrimitive.Root.displayName;

export { Separator };

// FILE: src/shared/components/ui/skeleton.tsx
import { cn } from '../../lib/utils';

export const Skeleton = ({ className }: { className: string }) => (
  <div className={cn('animate-pulse rounded-md bg-muted/30', className)} />
);

// FILE: src/shared/components/ui/switch.tsx
import * as React from 'react';
import * as SwitchPrimitives from '@radix-ui/react-switch';
import { cn } from '../../lib/utils';

const Switch = React.forwardRef<
  React.ElementRef<typeof SwitchPrimitives.Root>,
  React.ComponentPropsWithoutRef<typeof SwitchPrimitives.Root>
>(({ className, ...props }, ref) => (
  <SwitchPrimitives.Root
    className={cn(
      'peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent bg-muted transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 data-[state=checked]:bg-primary',
      className
    )}
    {...props}
    ref={ref}
  >
    <SwitchPrimitives.Thumb className="pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform duration-200 data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0" />
  </SwitchPrimitives.Root>
));
Switch.displayName = SwitchPrimitives.Root.displayName;

export { Switch };

// FILE: src/shared/components/ui/tabs.tsx
import * as TabsPrimitive from '@radix-ui/react-tabs';
import { cn } from '../../lib/utils';

const Tabs = TabsPrimitive.Root;

const TabsList = ({ className, ...props }: React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>) => (
  <TabsPrimitive.List
    className={cn(
      'inline-flex h-10 items-center justify-center rounded-md bg-muted/20 p-1 text-muted-foreground',
      className
    )}
    {...props}
  />
);

const TabsTrigger = ({ className, ...props }: React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>) => (
  <TabsPrimitive.Trigger
    className={cn(
      'inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium transition-all data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow',
      className
    )}
    {...props}
  />
);

const TabsContent = ({ className, ...props }: React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>) => (
  <TabsPrimitive.Content className={cn('mt-3', className)} {...props} />
);

export { Tabs, TabsList, TabsTrigger, TabsContent };

// FILE: src/shared/components/ui/textarea.tsx
import * as React from 'react';
import { cn } from '../../lib/utils';

export type TextareaProps = React.TextareaHTMLAttributes<HTMLTextAreaElement>;

const Textarea = React.forwardRef<HTMLTextAreaElement, TextareaProps>(({ className, ...props }, ref) => {
  return (
    <textarea
      ref={ref}
      className={cn(
        'flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2',
        className
      )}
      {...props}
    />
  );
});
Textarea.displayName = 'Textarea';

export { Textarea };

// FILE: src/shared/hooks/usePermissions.ts
import { useAuthStore } from '@auth/auth.store';

export type TesoreriaPermission = 'VER' | 'CAPTURAR' | 'EDITAR' | 'AUTORIZAR';

const ROLE_POLICIES: Record<'TESORERO', TesoreriaPermission[]> = {
  TESORERO: ['VER', 'CAPTURAR', 'EDITAR', 'AUTORIZAR']
};

export const usePermissions = () => {
  const user = useAuthStore((state) => state.user);
  const role = user?.rol ?? 'TESORERO';
  const permissions = ROLE_POLICIES[role] ?? [];
  const has = (perm: TesoreriaPermission) => permissions.includes(perm);
  return { permissions, has };
};

// FILE: src/shared/hooks/useToast.ts
import { create } from 'zustand';

type ToastVariant = 'default' | 'destructive' | 'success' | 'warning';

type ToastMessage = {
  id: string;
  title: string;
  description?: string;
  variant?: ToastVariant;
  duration?: number;
};

type ToastStore = {
  toasts: ToastMessage[];
  remove: (id: string) => void;
  push: (toast: ToastMessage) => void;
};

const useToastStore = create<ToastStore>((set) => ({
  toasts: [],
  remove: (id) => set((state) => ({ toasts: state.toasts.filter((item) => item.id !== id) })),
  push: (toast) =>
    set((state) => ({
      toasts: [...state.toasts.filter((item) => item.id !== toast.id), toast]
    }))
}));

export const toast = (payload: Omit<ToastMessage, 'id'> & { id?: string }) => {
  const id = payload.id ?? crypto.randomUUID();
  useToastStore.getState().push({ ...payload, id });
  const duration = payload.duration ?? 5_000;
  window.setTimeout(() => useToastStore.getState().remove(id), duration);
};

export const useToast = () => useToastStore();

// FILE: src/shared/i18n/index.ts
const dictionary: Record<string, string> = {
  'app.title': 'Tesorería Municipal',
  'app.subtitle': 'Control presupuestal y financiero del municipio',
  'actions.create': 'Crear',
  'actions.edit': 'Editar',
  'actions.delete': 'Eliminar',
  'actions.save': 'Guardar cambios',
  'actions.cancel': 'Cancelar',
  'actions.export': 'Exportar',
  'status.pending': 'Pendiente',
  'status.paid': 'Pagado'
};

export const t = (key: string, fallback?: string) => dictionary[key] ?? fallback ?? key;

// FILE: src/shared/lib/api.ts
import axios, { AxiosError, type AxiosAdapter } from 'axios';
import { handleRequest, MockHttpError } from '@mocks/handlers';
import { toast } from '../hooks/useToast';

let authToken: string | null = null;

export const setAuthToken = (token: string | null) => {
  authToken = token;
};

const mockAdapter: AxiosAdapter = async (config) => {
  try {
    const response = await handleRequest(config);
    return {
      data: response.data,
      status: response.status ?? 200,
      statusText: response.statusText ?? 'OK',
      headers: response.headers ?? {},
      config,
      request: {}
    };
  } catch (error) {
    if (error instanceof MockHttpError) {
      throw new AxiosError(error.message, String(error.status), config, {}, {
        data: { message: error.message, ...error.payload },
        status: error.status,
        statusText: error.statusText ?? 'Error',
        headers: {},
        config,
        request: {}
      });
    }
    throw error;
  }
};

export const api = axios.create({
  baseURL: '/api',
  timeout: 2000,
  adapter: mockAdapter
});

api.interceptors.request.use((config) => {
  if (authToken) {
    config.headers = {
      ...config.headers,
      Authorization: `Bearer ${authToken}`
    };
  }
  return config;
});

type ErrorMessages = Record<number, string>;

const errorMessages: ErrorMessages = {
  401: 'Su sesión expiró, inicie sesión nuevamente.',
  403: 'No cuenta con permisos para realizar esta acción.',
  422: 'Revise la información capturada, hay campos con errores.',
  500: 'Ocurrió un incidente interno. Se registró para seguimiento.'
};

api.interceptors.response.use(
  (response) => response,
  (error: AxiosError<{ message?: string; incidentId?: string }>) => {
    const status = error.response?.status ?? 500;
    const description =
      error.response?.data?.message ?? errorMessages[status] ?? 'Error inesperado en el servicio.';
    toast({
      title: `Error ${status}`,
      description,
      variant: status >= 500 ? 'destructive' : 'warning'
    });
    if (status === 401) {
      window.location.href = '/login';
    }
    return Promise.reject(error);
  }
);

// FILE: src/shared/lib/utils.ts
import dayjs from 'dayjs';

export const cn = (...classes: Array<string | false | null | undefined>) =>
  classes.filter(Boolean).join(' ');

export const formatCurrency = (value: number) =>
  new Intl.NumberFormat('es-MX', {
    style: 'currency',
    currency: 'MXN'
  }).format(value);

export const formatDate = (value: string | Date) =>
  dayjs(value).format('DD/MM/YYYY');

export const wait = (ms: number) => new Promise((resolve) => setTimeout(resolve, ms));

export const downloadFile = (name: string, content: string, type = 'text/csv') => {
  const blob = new Blob([content], { type });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = name;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
};

// FILE: src/shared/lib/validators.ts
import dayjs from 'dayjs';

const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
const rfcRegex = /^[A-ZÑ&]{3,4}\d{6}[A-Z0-9]{3}$/;
const partidaRegex = /^\d{4,5}$/;

export const validateUUID = (value?: string) => {
  if (!value) return true;
  return uuidRegex.test(value) || 'El UUID no tiene un formato válido.';
};

export const validateRFC = (value: string) => {
  if (!value) return 'El RFC es obligatorio.';
  return rfcRegex.test(value.toUpperCase()) || 'El RFC no cumple con el formato oficial.';
};

export const validatePositiveAmount = (value: number) => {
  if (Number.isNaN(value)) return 'El importe es obligatorio.';
  if (value <= 0) return 'El importe debe ser mayor a 0.00.';
  const decimals = value.toString().split('.')[1];
  if (decimals && decimals.length > 2) return 'El importe solo permite dos decimales.';
  return true;
};

export const validateNonFutureDate = (value: string) => {
  if (!value) return 'La fecha es obligatoria.';
  const date = dayjs(value);
  if (!date.isValid()) return 'La fecha es inválida.';
  if (date.isAfter(dayjs(), 'day')) return 'La fecha no puede ser futura.';
  return true;
};

export const validatePartida = (partida: string) => {
  if (!partida) return 'Seleccione una partida válida.';
  if (!partidaRegex.test(partida)) return 'La partida debe contener 4 o 5 dígitos.';
  return true;
};

export const validateCapituloPartida = (capitulo: string, partida: string) => {
  if (!capitulo || !partida) return 'Capítulo y partida son obligatorios.';
  if (!partida.startsWith(capitulo[0])) return 'La partida no corresponde al capítulo seleccionado.';
  return true;
};

const allowedExtensions = ['xml', 'pdf', 'jpg', 'jpeg', 'png'];

export const validateFile = (file: File, maxSizeMB = 5) => {
  const extension = file.name.split('.').pop()?.toLowerCase();
  if (!extension || !allowedExtensions.includes(extension)) {
    return 'Formato de archivo no permitido (solo XML, PDF, JPG, PNG).';
  }
  const sizeMB = file.size / (1024 * 1024);
  if (sizeMB > maxSizeMB) {
    return `El archivo supera el tamaño máximo permitido (${maxSizeMB} MB).`;
  }
  return true;
};

// FILE: src/shared/store/ui.store.ts
import { create } from 'zustand';

interface UIPanelState {
  id: string;
  open: boolean;
}

interface UIState {
  sidebarCollapsed: boolean;
  toggleSidebar: () => void;
  breadcrumb: string[];
  setBreadcrumb: (items: string[]) => void;
  panel: UIPanelState | null;
  openPanel: (id: string) => void;
  closePanel: () => void;
}

export const useUIStore = create<UIState>((set) => ({
  sidebarCollapsed: false,
  toggleSidebar: () => set((state) => ({ sidebarCollapsed: !state.sidebarCollapsed })),
  breadcrumb: [],
  setBreadcrumb: (items) => set({ breadcrumb: items }),
  panel: null,
  openPanel: (id) => set({ panel: { id, open: true } }),
  closePanel: () => set({ panel: null })
}));

// FILE: src/treasury/types.ts
export type UUID = string;
export type EstatusCompromiso =
  | 'BORRADOR'
  | 'REVISION'
  | 'RECHAZADO'
  | 'AUTORIZADO'
  | 'PAGADO'
  | 'CERRADO';

export type Proveedor = {
  id: string;
  nombre: string;
  rfc: string;
  telefono?: string;
  email?: string;
  direccion?: string;
};

export type Ingreso = {
  id: string;
  fecha: string;
  concepto: string;
  importe: number;
  fuente: string;
  referencia?: string;
  cuentaId: string;
  partida: string;
  capitulo: string;
  bitacora: any[];
};

export type Egreso = {
  id: string;
  fecha: string;
  concepto: string;
  importe: number;
  proveedorId: string;
  uuid?: UUID;
  cuentaId: string;
  partida: string;
  capitulo: string;
  estatus: 'PENDIENTE' | 'PAGADO';
  refPago?: string;
  bitacora: any[];
};

export type Compromiso = {
  id: string;
  proveedor: Proveedor;
  uuid: UUID;
  concepto: string;
  importe: number;
  partida: string;
  capitulo: string;
  fechaDocumento: string;
  fechaProgramada: string;
  estatus: EstatusCompromiso;
  banco?: string;
  refPago?: string;
  adjuntos?: Array<{ id: string; name: string; url?: string }>;
  bitacora: Array<{
    ts: string;
    user: string;
    action: string;
    before?: any;
    after?: any;
  }>;
};

export type Partida = {
  clave: string;
  capitulo: string;
  nombre: string;
  disponible: number;
};

export type Presupuesto = {
  id: string;
  ejercicio: number;
  partidas: Partida[];
  actualizado: string;
};

export type CuentaBancaria = {
  id: string;
  banco: string;
  clabe: string;
  moneda: 'MXN';
  nombre: string;
  saldo: number;
};

export type MovimientoBancario = {
  id: string;
  cuentaId: string;
  fecha: string;
  concepto: string;
  importe: number;
  tipo: 'ABONO' | 'CARGO';
  ref?: string;
  conciliado: boolean;
};

// FILE: src/treasury/__tests__/compromisos.machine.test.ts
import { describe, expect, it } from 'vitest';
import { compromisoTransitions } from '@mocks/handlers';

const canTransition = (from: string, to: string) => (compromisoTransitions as any)[from]?.includes(to);

describe('Máquina de estados de Compromiso', () => {
  it('permite avanzar de BORRADOR a REVISION', () => {
    expect(canTransition('BORRADOR', 'REVISION')).toBe(true);
  });

  it('no permite aprobar directamente desde BORRADOR', () => {
    expect(canTransition('BORRADOR', 'AUTORIZADO')).toBe(false);
  });

  it('permite autorizar después de revisión', () => {
    expect(canTransition('REVISION', 'AUTORIZADO')).toBe(true);
  });

  it('permite rechazar en revisión pero no después de autorizado', () => {
    expect(canTransition('REVISION', 'RECHAZADO')).toBe(true);
    expect(canTransition('AUTORIZADO', 'RECHAZADO')).toBe(false);
  });

  it('solo permite cerrar después de pagado', () => {
    expect(canTransition('PAGADO', 'CERRADO')).toBe(true);
    expect(canTransition('AUTORIZADO', 'CERRADO')).toBe(false);
  });
});

// FILE: src/treasury/components/BankMatchTable.tsx
import { Checkbox } from '@shared/components/ui/checkbox';
import { Button } from '@shared/components/ui/button';
import { formatCurrency, formatDate } from '@shared/lib/utils';
import type { MovimientoBancario } from '@treasury/types';
import { useState } from 'react';

interface BankMatchTableProps {
  movimientos: MovimientoBancario[];
  onToggle: (ids: string[], conciliado: boolean) => void;
}

export const BankMatchTable = ({ movimientos, onToggle }: BankMatchTableProps) => {
  const [selected, setSelected] = useState<Record<string, boolean>>({});

  const toggle = (id: string, value: boolean) => {
    setSelected((prev) => ({ ...prev, [id]: value }));
  };

  const selectedIds = Object.entries(selected)
    .filter(([, value]) => value)
    .map(([key]) => key);

  return (
    <div className="space-y-3">
      <div className="flex items-center gap-2">
        <Button
          variant="outline"
          size="sm"
          disabled={selectedIds.length === 0}
          onClick={() => onToggle(selectedIds, true)}
        >
          Confirmar conciliación
        </Button>
        <Button
          variant="ghost"
          size="sm"
          disabled={selectedIds.length === 0}
          onClick={() => onToggle(selectedIds, false)}
        >
          Marcar investigación
        </Button>
        <span className="text-xs text-muted-foreground">{selectedIds.length} seleccionados</span>
      </div>
      <div className="overflow-hidden rounded-lg border border-border">
        <table className="w-full text-sm">
          <thead className="bg-muted/40 text-xs uppercase text-muted-foreground">
            <tr>
              <th className="w-10 px-2 py-2 text-left">
                <Checkbox
                  checked={selectedIds.length === movimientos.length && movimientos.length > 0}
                  indeterminate={selectedIds.length > 0 && selectedIds.length < movimientos.length}
                  onCheckedChange={(value) => {
                    const next: Record<string, boolean> = {};
                    movimientos.forEach((mov) => {
                      next[mov.id] = Boolean(value);
                    });
                    setSelected(next);
                  }}
                />
              </th>
              <th className="px-3 py-2 text-left">Fecha</th>
              <th className="px-3 py-2 text-left">Concepto</th>
              <th className="px-3 py-2 text-left">Tipo</th>
              <th className="px-3 py-2 text-right">Importe</th>
              <th className="px-3 py-2 text-left">Referencia</th>
              <th className="px-3 py-2 text-center">Conciliado</th>
            </tr>
          </thead>
          <tbody>
            {movimientos.map((mov) => (
              <tr key={mov.id} className="border-t border-border/80 hover:bg-muted/30">
                <td className="px-2 py-2">
                  <Checkbox checked={selected[mov.id] ?? false} onCheckedChange={(value) => toggle(mov.id, Boolean(value))} />
                </td>
                <td className="px-3 py-2 text-xs">{formatDate(mov.fecha)}</td>
                <td className="px-3 py-2">{mov.concepto}</td>
                <td className="px-3 py-2 text-xs">{mov.tipo}</td>
                <td className="px-3 py-2 text-right font-medium">{formatCurrency(mov.importe)}</td>
                <td className="px-3 py-2 text-xs">{mov.ref ?? '—'}</td>
                <td className="px-3 py-2 text-center text-xs">
                  {mov.conciliado ? 'Sí' : 'No'}
                </td>
              </tr>
            ))}
            {movimientos.length === 0 ? (
              <tr>
                <td colSpan={7} className="px-4 py-6 text-center text-sm text-muted-foreground">
                  No hay movimientos en el periodo seleccionado.
                </td>
              </tr>
            ) : null}
          </tbody>
        </table>
      </div>
    </div>
  );
};

// FILE: src/treasury/components/BudgetAffectation.tsx
import type { Partida } from '@treasury/types';
import { formatCurrency } from '@shared/lib/utils';
import { Progress } from '@shared/components/ui/progress';

interface BudgetAffectationProps {
  partida?: Partida & { comprometido?: number; devengado?: number; pagado?: number };
  importe?: number;
}

export const BudgetAffectation = ({ partida, importe = 0 }: BudgetAffectationProps) => {
  if (!partida) {
    return <p className="text-sm text-muted-foreground">Seleccione una partida para visualizar su disponibilidad.</p>;
  }

  const comprometido = partida.comprometido ?? 0;
  const disponible = partida.disponible ?? 0;
  const impacto = importe + comprometido;
  const porcentaje = partida.disponible > 0 ? Math.min(100, Math.round((impacto / (disponible + comprometido)) * 100)) : 0;

  return (
    <div className="space-y-2 rounded-lg border border-border p-4 text-sm">
      <div className="flex items-center justify-between text-xs text-muted-foreground">
        <span>{partida.clave} · {partida.nombre}</span>
        <span>Capítulo {partida.capitulo}</span>
      </div>
      <div className="grid gap-2 md:grid-cols-2">
        <p>Disponible actual: {formatCurrency(disponible)}</p>
        <p>Comprometido: {formatCurrency(comprometido)}</p>
        <p>Importe a afectar: {formatCurrency(importe)}</p>
        <p>Disponible post-afectación: {formatCurrency(disponible - importe)}</p>
      </div>
      <Progress value={porcentaje} />
      <p className="text-xs text-muted-foreground">
        El compromiso consume {porcentaje}% del techo financiero disponible en esta partida.
      </p>
    </div>
  );
};

// FILE: src/treasury/components/CompromisoWizard.tsx
import { useState } from 'react';
import { Wizard, type WizardStep } from '@shared/components/Wizard';
import { Input } from '@shared/components/ui/input';
import { Label } from '@shared/components/ui/label';
import { Textarea } from '@shared/components/ui/textarea';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@shared/components/ui/select';
import { Uploader } from '@shared/components/Uploader';
import type { Compromiso, CuentaBancaria, Partida, Proveedor } from '@treasury/types';
import { BudgetAffectation } from './BudgetAffectation';
import { validateCapituloPartida, validatePartida, validatePositiveAmount, validateRFC, validateUUID } from '@shared/lib/validators';

export interface CompromisoWizardProps {
  proveedores: Proveedor[];
  partidas: Array<Partida & { comprometido?: number; devengado?: number; pagado?: number }>;
  cuentas: CuentaBancaria[];
  onSubmit: (values: Compromiso) => Promise<void> | void;
}

type CompromisoDraft = {
  proveedor: Proveedor;
  uuid: string;
  concepto: string;
  importe: number;
  partida: string;
  capitulo: string;
  fechaDocumento: string;
  fechaProgramada: string;
  estatus: Compromiso['estatus'];
  banco?: string;
  refPago?: string;
  adjuntos: Array<{ id: string; name: string }>; 
  bitacora: Compromiso['bitacora'];
};

const defaultProveedor: Proveedor = {
  id: '',
  nombre: '',
  rfc: ''
};

export const CompromisoWizard = ({ proveedores, partidas, cuentas, onSubmit }: CompromisoWizardProps) => {
  const [adjuntos, setAdjuntos] = useState<Array<{ id: string; name: string }>>([]);

  const steps: WizardStep<CompromisoDraft>[] = [
    {
      id: 'proveedor',
      title: 'Proveedor',
      description: 'Selecciona un proveedor o da de alta uno nuevo',
      validator: (values) => {
        if (!values.proveedor?.id && !values.proveedor?.nombre) return 'Debe seleccionar o capturar un proveedor.';
        const rfcValid = validateRFC(values.proveedor?.rfc ?? '');
        return rfcValid === true ? true : rfcValid;
      },
      content: ({ proveedor, onChange }) => {
        return (
          <div className="grid gap-4 md:grid-cols-2">
            <div className="space-y-2">
              <Label>Proveedor registrado</Label>
              <Select
                value={proveedor?.id ?? ''}
                onValueChange={(value) => {
                  if (!value) return;
                  const encontrado = proveedores.find((item) => item.id === value);
                  if (encontrado) onChange({ proveedor: encontrado });
                }}
              >
                <SelectTrigger>
                  <SelectValue placeholder="Seleccione proveedor" />
                </SelectTrigger>
                <SelectContent>
                  {proveedores.map((prov) => (
                    <SelectItem key={prov.id} value={prov.id}>
                      {prov.nombre} ({prov.rfc})
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>
            <div className="space-y-2">
              <Label>Alta rápida</Label>
              <Input
                placeholder="Nombre comercial"
                value={proveedor?.nombre ?? ''}
                onChange={(event) =>
                  onChange({ proveedor: { ...(proveedor ?? defaultProveedor), nombre: event.target.value } })
                }
              />
              <Input
                placeholder="RFC"
                value={proveedor?.rfc ?? ''}
                onChange={(event) =>
                  onChange({ proveedor: { ...(proveedor ?? defaultProveedor), rfc: event.target.value.toUpperCase() } })
                }
              />
              <Input
                placeholder="Correo de contacto"
                value={proveedor?.email ?? ''}
                onChange={(event) =>
                  onChange({ proveedor: { ...(proveedor ?? defaultProveedor), email: event.target.value } })
                }
              />
            </div>
          </div>
        );
      }
    },
    {
      id: 'documento',
      title: 'Documento',
      description: 'Datos fiscales del compromiso',
      validator: (values) => {
        const uuidValid = validateUUID(values.uuid);
        const importeValid = validatePositiveAmount(values.importe);
        if (uuidValid !== true) return uuidValid;
        if (importeValid !== true) return importeValid;
        if (!values.fechaDocumento) return 'Capture la fecha del documento respaldatorio.';
        if (!values.adjuntos?.length) return 'Adjunte al menos un archivo del comprobante.';
        return true;
      },
      content: ({ uuid, concepto, importe, fechaDocumento, adjuntos: wizardAdjuntos, onChange }) => (
        <div className="grid gap-4 md:grid-cols-2">
          <div className="space-y-2">
            <Label>UUID</Label>
            <Input value={uuid ?? ''} onChange={(event) => onChange({ uuid: event.target.value })} placeholder="UUID del CFDI" />
          </div>
          <div className="space-y-2">
            <Label>Importe</Label>
            <Input
              type="number"
              step="0.01"
              value={importe ?? 0}
              onChange={(event) => onChange({ importe: Number(event.target.value) })}
            />
          </div>
          <div className="space-y-2 md:col-span-2">
            <Label>Concepto</Label>
            <Textarea
              rows={3}
              value={concepto ?? ''}
              onChange={(event) => onChange({ concepto: event.target.value })}
              placeholder="Describe el servicio o producto comprometido"
            />
          </div>
          <div className="space-y-2">
            <Label>Fecha del documento</Label>
            <Input
              type="date"
              value={fechaDocumento ?? ''}
              onChange={(event) => onChange({ fechaDocumento: event.target.value })}
            />
          </div>
          <div className="space-y-2">
            <Label>Adjuntos</Label>
            <Uploader
              accept=".xml,.pdf"
              onFiles={(files) => {
                const next = [...(wizardAdjuntos ?? []), ...files.map((file) => ({ id: crypto.randomUUID(), name: file.name }))];
                setAdjuntos(next);
                onChange({ adjuntos: next });
              }}
              files={(wizardAdjuntos ?? []).map((file) => ({ name: file.name, size: 1024 }))}
              onRemove={(fileName) => {
                const next = (wizardAdjuntos ?? []).filter((file) => file.name !== fileName);
                setAdjuntos(next);
                onChange({ adjuntos: next });
              }}
            />
          </div>
        </div>
      )
    },
    {
      id: 'presupuesto',
      title: 'Presupuesto',
      description: 'Afectación presupuestal simulada',
      validator: (values) => {
        const partidaValid = validatePartida(values.partida ?? '');
        if (partidaValid !== true) return partidaValid;
        const capituloValid = validateCapituloPartida(values.capitulo ?? '', values.partida ?? '');
        if (capituloValid !== true) return capituloValid;
        return true;
      },
      content: ({ capitulo, partida, importe, onChange }) => {
        const partidaSeleccionada = partidas.find((item) => item.clave === partida);
        return (
          <div className="space-y-4">
            <div className="grid gap-3 md:grid-cols-2">
              <div className="space-y-2">
                <Label>Capítulo</Label>
                <Select value={capitulo ?? ''} onValueChange={(value) => onChange({ capitulo: value })}>
                  <SelectTrigger>
                    <SelectValue placeholder="Seleccione" />
                  </SelectTrigger>
                  <SelectContent>
                    {[...new Set(partidas.map((item) => item.capitulo))].map((cap) => (
                      <SelectItem key={cap} value={cap}>
                        {cap}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
              <div className="space-y-2">
                <Label>Partida</Label>
                <Select value={partida ?? ''} onValueChange={(value) => onChange({ partida: value })}>
                  <SelectTrigger>
                    <SelectValue placeholder="Seleccione partida" />
                  </SelectTrigger>
                  <SelectContent>
                    {partidas
                      .filter((item) => !capitulo || item.capitulo === capitulo)
                      .map((item) => (
                        <SelectItem key={item.clave} value={item.clave}>
                          {item.clave} · {item.nombre}
                        </SelectItem>
                      ))}
                  </SelectContent>
                </Select>
              </div>
            </div>
            <BudgetAffectation partida={partidaSeleccionada} importe={importe} />
          </div>
        );
      }
    },
    {
      id: 'programacion',
      title: 'Programación',
      description: 'Agenda de pago y cuenta fuente',
      validator: (values) => {
        if (!values.fechaProgramada) return 'Defina la fecha programada de pago.';
        if (!values.banco) return 'Indique el banco o cuenta de pago.';
        return true;
      },
      content: ({ fechaProgramada, banco, refPago, onChange }) => (
        <div className="grid gap-4 md:grid-cols-2">
          <div className="space-y-2">
            <Label>Fecha programada</Label>
            <Input
              type="date"
              value={fechaProgramada ?? ''}
              onChange={(event) => onChange({ fechaProgramada: event.target.value })}
            />
          </div>
          <div className="space-y-2">
            <Label>Banco / Cuenta</Label>
            <Select value={banco ?? ''} onValueChange={(value) => onChange({ banco: value })}>
              <SelectTrigger>
                <SelectValue placeholder="Seleccione cuenta" />
              </SelectTrigger>
              <SelectContent>
                {cuentas.map((cuenta) => (
                  <SelectItem key={cuenta.id} value={`${cuenta.banco} · ${cuenta.nombre}`}>
                    {cuenta.banco} · {cuenta.nombre}
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
          </div>
          <div className="space-y-2 md:col-span-2">
            <Label>Referencia programada</Label>
            <Input value={refPago ?? ''} onChange={(event) => onChange({ refPago: event.target.value })} placeholder="Referencia o folio" />
          </div>
        </div>
      )
    }
  ];

  return (
    <Wizard
      steps={steps}
      initialValues={{
        proveedor: defaultProveedor,
        uuid: '',
        concepto: '',
        importe: 0,
        partida: '',
        capitulo: '',
        fechaDocumento: new Date().toISOString().slice(0, 10),
        fechaProgramada: new Date().toISOString().slice(0, 10),
        estatus: 'BORRADOR',
        banco: '',
        refPago: '',
        adjuntos: [],
        bitacora: []
      }}
      autosave={(values) => {
        if (values.adjuntos !== adjuntos) {
          setAdjuntos(values.adjuntos ?? []);
        }
      }}
      onFinish={async (values) => {
        await onSubmit({
          ...values,
          id: crypto.randomUUID(),
          adjuntos: values.adjuntos,
          bitacora: [
            {
              ts: new Date().toISOString(),
              user: 'TESORERO',
              action: 'Compromiso creado via asistente'
            }
          ]
        } as Compromiso);
      }}
    />
  );
};

// FILE: src/treasury/components/EgresoForm.tsx
import { useMemo, useState } from 'react';
import { useForm } from 'react-hook-form';
import { Button } from '@shared/components/ui/button';
import { Input } from '@shared/components/ui/input';
import { Label } from '@shared/components/ui/label';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@shared/components/ui/select';
import { Textarea } from '@shared/components/ui/textarea';
import { Uploader } from '@shared/components/Uploader';
import { validateNonFutureDate, validatePositiveAmount, validatePartida, validateCapituloPartida, validateUUID } from '@shared/lib/validators';
import type { CuentaBancaria, Egreso, Partida, Proveedor } from '@treasury/types';

interface EgresoFormProps {
  defaultValues?: Partial<Egreso>;
  proveedores: Proveedor[];
  cuentas: CuentaBancaria[];
  partidas: Partida[];
  onSubmit: (values: Partial<Egreso> & { adjuntos?: string[] }) => Promise<void> | void;
  loading?: boolean;
}

export const EgresoForm = ({ defaultValues, proveedores, cuentas, partidas, onSubmit, loading }: EgresoFormProps) => {
  const {
    handleSubmit,
    register,
    setValue,
    watch,
    formState: { errors }
  } = useForm<Partial<Egreso>>({
    defaultValues: {
      fecha: defaultValues?.fecha ?? new Date().toISOString().slice(0, 10),
      concepto: defaultValues?.concepto ?? '',
      importe: defaultValues?.importe ?? 0,
      proveedorId: defaultValues?.proveedorId ?? proveedores[0]?.id,
      cuentaId: defaultValues?.cuentaId ?? cuentas[0]?.id,
      capitulo: defaultValues?.capitulo ?? '',
      partida: defaultValues?.partida ?? '',
      estatus: defaultValues?.estatus ?? 'PENDIENTE'
    }
  });

  const [adjuntos, setAdjuntos] = useState<string[]>([]);
  const selectedCapitulo = watch('capitulo');
  const providerQuery = watch('proveedorId');

  const proveedorActual = useMemo(() => proveedores.find((prov) => prov.id === providerQuery), [proveedores, providerQuery]);

  const submit = handleSubmit(async (values) => {
    const importeValid = validatePositiveAmount(Number(values.importe));
    const uuidValid = validateUUID(values.uuid);
    const partidaValid = validatePartida(values.partida ?? '');
    const capituloValid = validateCapituloPartida(values.capitulo ?? '', values.partida ?? '');
    const fechaValid = validateNonFutureDate(values.fecha ?? '');
    const validations = [importeValid, uuidValid, partidaValid, capituloValid, fechaValid];
    const errorsList = validations.filter((v) => v !== true);
    if (errorsList.length) {
      throw new Error(errorsList.join('\n'));
    }
    await onSubmit({ ...values, adjuntos });
  });

  return (
    <form onSubmit={submit} className="grid gap-4" aria-label="Formulario de egreso">
      <div className="grid gap-3 md:grid-cols-2">
        <div className="space-y-2">
          <Label htmlFor="fecha">Fecha del egreso</Label>
          <Input type="date" id="fecha" {...register('fecha', { required: true })} />
          {errors.fecha ? <p className="text-xs text-red-600">Seleccione una fecha válida.</p> : null}
        </div>
        <div className="space-y-2">
          <Label htmlFor="importe">Importe</Label>
          <Input type="number" step="0.01" id="importe" {...register('importe', { valueAsNumber: true })} />
          {errors.importe ? <p className="text-xs text-red-600">Capture un importe válido.</p> : null}
        </div>
      </div>
      <div className="space-y-2">
        <Label>Proveedor</Label>
        <Select onValueChange={(value) => setValue('proveedorId', value)} value={watch('proveedorId')}>
          <SelectTrigger>
            <SelectValue placeholder="Seleccione el proveedor" />
          </SelectTrigger>
          <SelectContent>
            {proveedores.map((proveedor) => (
              <SelectItem key={proveedor.id} value={proveedor.id}>
                {proveedor.nombre} ({proveedor.rfc})
              </SelectItem>
            ))}
          </SelectContent>
        </Select>
        {proveedorActual ? (
          <p className="text-xs text-muted-foreground">RFC: {proveedorActual.rfc} · {proveedorActual.email}</p>
        ) : null}
      </div>
      <div className="space-y-2">
        <Label htmlFor="concepto">Concepto del egreso</Label>
        <Textarea id="concepto" rows={3} {...register('concepto', { required: true })} />
      </div>
      <div className="grid gap-3 md:grid-cols-3">
        <div className="space-y-2">
          <Label>UUID (opcional)</Label>
          <Input placeholder="XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX" {...register('uuid')} />
        </div>
        <div className="space-y-2">
          <Label>Cuenta bancaria</Label>
          <Select onValueChange={(value) => setValue('cuentaId', value)} value={watch('cuentaId')}>
            <SelectTrigger>
              <SelectValue placeholder="Cuenta" />
            </SelectTrigger>
            <SelectContent>
              {cuentas.map((cuenta) => (
                <SelectItem key={cuenta.id} value={cuenta.id}>
                  {cuenta.nombre}
                </SelectItem>
              ))}
            </SelectContent>
          </Select>
        </div>
        <div className="space-y-2">
          <Label>Estatus</Label>
          <Select onValueChange={(value) => setValue('estatus', value as Egreso['estatus'])} value={watch('estatus')}>
            <SelectTrigger>
              <SelectValue placeholder="Estatus" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="PENDIENTE">Pendiente</SelectItem>
              <SelectItem value="PAGADO">Pagado</SelectItem>
            </SelectContent>
          </Select>
        </div>
      </div>
      <div className="grid gap-3 md:grid-cols-2">
        <div className="space-y-2">
          <Label>Capítulo</Label>
          <Select onValueChange={(value) => setValue('capitulo', value)} value={watch('capitulo')}>
            <SelectTrigger>
              <SelectValue placeholder="Capítulo" />
            </SelectTrigger>
            <SelectContent>
              {[...new Set(partidas.map((partida) => partida.capitulo))].map((capitulo) => (
                <SelectItem key={capitulo} value={capitulo}>
                  {capitulo}
                </SelectItem>
              ))}
            </SelectContent>
          </Select>
        </div>
        <div className="space-y-2">
          <Label>Partida</Label>
          <Select onValueChange={(value) => setValue('partida', value)} value={watch('partida')}>
            <SelectTrigger>
              <SelectValue placeholder="Partida" />
            </SelectTrigger>
            <SelectContent>
              {partidas
                .filter((partida) => !selectedCapitulo || partida.capitulo === selectedCapitulo)
                .map((partida) => (
                  <SelectItem key={partida.clave} value={partida.clave}>
                    {partida.clave} · {partida.nombre}
                  </SelectItem>
                ))}
            </SelectContent>
          </Select>
        </div>
      </div>
      <div className="space-y-2">
        <Label>Adjuntos (XML/PDF)</Label>
        <Uploader
          accept=".xml,.pdf"
          onFiles={(files) => setAdjuntos((prev) => [...prev, ...files.map((file) => file.name)])}
          files={adjuntos.map((file) => ({ name: file, size: 1024 }))}
          onRemove={(fileName) => setAdjuntos((prev) => prev.filter((name) => name !== fileName))}
        />
      </div>
      <div className="space-y-2">
        <Label>Referencia de pago (opcional)</Label>
        <Input placeholder="Número de transferencia" {...register('refPago')} />
      </div>
      <div className="flex justify-end">
        <Button type="submit" disabled={loading}>
          {loading ? 'Guardando…' : 'Guardar egreso'}
        </Button>
      </div>
    </form>
  );
};

// FILE: src/treasury/components/IngresoForm.tsx
import { useState } from 'react';
import { useForm } from 'react-hook-form';
import { Button } from '@shared/components/ui/button';
import { Input } from '@shared/components/ui/input';
import { Label } from '@shared/components/ui/label';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@shared/components/ui/select';
import { Textarea } from '@shared/components/ui/textarea';
import { Uploader } from '@shared/components/Uploader';
import { validateNonFutureDate, validatePositiveAmount, validatePartida, validateCapituloPartida } from '@shared/lib/validators';
import type { CuentaBancaria, Ingreso, Partida } from '@treasury/types';

export interface IngresoFormProps {
  defaultValues?: Partial<Ingreso>;
  cuentas: CuentaBancaria[];
  partidas: Partida[];
  onSubmit: (values: Partial<Ingreso> & { adjuntos?: string[] }) => Promise<void> | void;
  loading?: boolean;
}

export const IngresoForm = ({ defaultValues, cuentas, partidas, onSubmit, loading }: IngresoFormProps) => {
  const {
    handleSubmit,
    register,
    setValue,
    watch,
    formState: { errors }
  } = useForm<Partial<Ingreso>>({
    defaultValues: {
      fecha: defaultValues?.fecha ?? new Date().toISOString().slice(0, 10),
      concepto: defaultValues?.concepto ?? '',
      importe: defaultValues?.importe ?? 0,
      fuente: defaultValues?.fuente ?? '',
      referencia: defaultValues?.referencia ?? '',
      cuentaId: defaultValues?.cuentaId ?? cuentas[0]?.id,
      capitulo: defaultValues?.capitulo ?? '',
      partida: defaultValues?.partida ?? ''
    }
  });

  const [adjuntos, setAdjuntos] = useState<string[]>(defaultValues?.bitacora?.map((item) => item.action) ?? []);

  const selectedCapitulo = watch('capitulo');

  const submit = handleSubmit(async (values) => {
    const fechaValid = validateNonFutureDate(values.fecha ?? '');
    const importeValid = validatePositiveAmount(Number(values.importe));
    const partidaValid = validatePartida(values.partida ?? '');
    const capituloValid = validateCapituloPartida(values.capitulo ?? '', values.partida ?? '');

    const validations = [fechaValid, importeValid, partidaValid, capituloValid];
    const errorsList = validations.filter((item) => item !== true);
    if (errorsList.length) {
      throw new Error(Array.isArray(errorsList) ? errorsList.join('\n') : String(errorsList));
    }
    await onSubmit({ ...values, adjuntos });
  });

  return (
    <form onSubmit={submit} className="grid gap-4" aria-label="Formulario de ingreso">
      <div className="grid gap-3 md:grid-cols-2">
        <div className="space-y-2">
          <Label htmlFor="fecha">Fecha de ingreso</Label>
          <Input type="date" id="fecha" {...register('fecha', { required: true })} />
          {errors.fecha ? <p className="text-xs text-red-600">Ingrese una fecha válida.</p> : null}
        </div>
        <div className="space-y-2">
          <Label htmlFor="importe">Importe</Label>
          <Input type="number" step="0.01" id="importe" {...register('importe', { valueAsNumber: true })} />
          {errors.importe ? <p className="text-xs text-red-600">El importe es obligatorio.</p> : null}
        </div>
      </div>
      <div className="space-y-2">
        <Label htmlFor="concepto">Concepto</Label>
        <Textarea id="concepto" rows={2} {...register('concepto', { required: true })} />
        {errors.concepto ? <p className="text-xs text-red-600">Capture el concepto del ingreso.</p> : null}
      </div>
      <div className="grid gap-3 md:grid-cols-2">
        <div className="space-y-2">
          <Label>Fuente de recurso</Label>
          <Input placeholder="Ej. Predial" {...register('fuente', { required: true })} />
        </div>
        <div className="space-y-2">
          <Label htmlFor="referencia">Referencia</Label>
          <Input id="referencia" placeholder="Referencia bancaria" {...register('referencia')} />
        </div>
      </div>
      <div className="grid gap-3 md:grid-cols-2">
        <div className="space-y-2">
          <Label>Cuenta bancaria</Label>
          <Select onValueChange={(value) => setValue('cuentaId', value)} value={watch('cuentaId')}>
            <SelectTrigger>
              <SelectValue placeholder="Seleccione una cuenta" />
            </SelectTrigger>
            <SelectContent>
              {cuentas.map((cuenta) => (
                <SelectItem key={cuenta.id} value={cuenta.id}>
                  {cuenta.nombre}
                </SelectItem>
              ))}
            </SelectContent>
          </Select>
        </div>
        <div className="space-y-2">
          <Label>Capítulo</Label>
          <Select onValueChange={(value) => setValue('capitulo', value)} value={watch('capitulo')}>
            <SelectTrigger>
              <SelectValue placeholder="Seleccione el capítulo" />
            </SelectTrigger>
            <SelectContent>
              {[...new Set(partidas.map((partida) => partida.capitulo))].map((capitulo) => (
                <SelectItem key={capitulo} value={capitulo}>
                  {capitulo}
                </SelectItem>
              ))}
            </SelectContent>
          </Select>
        </div>
      </div>
      <div className="grid gap-3 md:grid-cols-2">
        <div className="space-y-2">
          <Label>Partida</Label>
          <Select onValueChange={(value) => setValue('partida', value)} value={watch('partida')}>
            <SelectTrigger>
              <SelectValue placeholder="Seleccione partida" />
            </SelectTrigger>
            <SelectContent>
              {partidas
                .filter((partida) => !selectedCapitulo || partida.capitulo === selectedCapitulo)
                .map((partida) => (
                  <SelectItem key={partida.clave} value={partida.clave}>
                    {partida.clave} · {partida.nombre}
                  </SelectItem>
                ))}
            </SelectContent>
          </Select>
        </div>
        <div className="space-y-2">
          <Label>Adjuntos</Label>
          <Uploader
            accept=".xml,.pdf,.jpg,.png"
            onFiles={(files) => setAdjuntos((prev) => [...prev, ...files.map((file) => file.name)])}
            files={adjuntos.map((file) => ({ name: file, size: 1024 }))}
            onRemove={(fileName) => setAdjuntos((prev) => prev.filter((name) => name !== fileName))}
          />
        </div>
      </div>
      <div className="flex justify-end gap-2">
        <Button type="submit" disabled={loading}>
          {loading ? 'Guardando…' : 'Guardar ingreso'}
        </Button>
      </div>
    </form>
  );
};

// FILE: src/treasury/components/KPIWidgets.tsx
import { useMemo } from 'react';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@shared/components/ui/card';
import { Progress } from '@shared/components/ui/progress';
import { formatCurrency, formatDate } from '@shared/lib/utils';
import type { DashboardData } from '../hooks/useDashboard';
import { Badge } from '@shared/components/ui/badge';

interface KPIWidgetsProps {
  data?: DashboardData;
  isLoading: boolean;
}

export const KPIWidgets = ({ data, isLoading }: KPIWidgetsProps) => {
  const avance = useMemo(() => {
    if (!data) return 0;
    return Math.min(100, Math.round((data.ingresosMes / data.metaMensual) * 100));
  }, [data]);

  if (isLoading) {
    return <p className="text-sm text-muted-foreground">Cargando indicadores financieros…</p>;
  }

  if (!data) {
    return <p className="text-sm text-muted-foreground">Sin datos aún. Capture ingresos y egresos para visualizar KPIs.</p>;
  }

  return (
    <div className="grid gap-4 lg:grid-cols-12">
      <Card className="lg:col-span-3">
        <CardHeader>
          <CardTitle>Ingresos del mes</CardTitle>
          <CardDescription>Meta mensual {formatCurrency(data.metaMensual)}</CardDescription>
        </CardHeader>
        <CardContent>
          <p className="text-3xl font-semibold text-primary">{formatCurrency(data.ingresosMes)}</p>
          <Progress value={avance} className="mt-3" />
          <p className="mt-1 text-xs text-muted-foreground">Avance {avance}%</p>
        </CardContent>
      </Card>

      <Card className="lg:col-span-3">
        <CardHeader>
          <CardTitle>Egresos por capítulo</CardTitle>
          <CardDescription>Distribución del mes</CardDescription>
        </CardHeader>
        <CardContent className="space-y-2">
          {Object.entries(data.egresosCapitulo).map(([capitulo, importe]) => (
            <div key={capitulo}>
              <div className="flex items-center justify-between text-xs text-muted-foreground">
                <span>Capítulo {capitulo}</span>
                <span>{formatCurrency(importe)}</span>
              </div>
              <div className="mt-1 h-2 rounded-full bg-muted">
                <div
                  className="h-2 rounded-full bg-amber-500"
                  style={{ width: `${Math.min(100, (importe / data.metaMensual) * 100)}%` }}
                />
              </div>
            </div>
          ))}
          {Object.keys(data.egresosCapitulo).length === 0 ? (
            <p className="text-xs text-muted-foreground">Aún no hay egresos capturados este mes.</p>
          ) : null}
        </CardContent>
      </Card>

      <Card className="lg:col-span-3">
        <CardHeader>
          <CardTitle>Compromisos por vencer</CardTitle>
          <CardDescription>Próximos 7 días</CardDescription>
        </CardHeader>
        <CardContent className="space-y-2">
          {data.compromisosPorVencer.slice(0, 4).map((comp) => (
            <div key={comp.id} className="rounded border border-border/80 p-2">
              <p className="text-sm font-medium text-foreground">{comp.concepto}</p>
              <p className="text-xs text-muted-foreground">
                Programado para {formatDate(comp.fechaProgramada)} · {formatCurrency(comp.importe)}
              </p>
            </div>
          ))}
          {data.compromisosPorVencer.length === 0 ? (
            <p className="text-xs text-muted-foreground">Sin compromisos próximos a vencer.</p>
          ) : null}
        </CardContent>
      </Card>

      <Card className="lg:col-span-3">
        <CardHeader>
          <CardTitle>Alertas de conciliación</CardTitle>
          <CardDescription>Movimientos sin conciliar</CardDescription>
        </CardHeader>
        <CardContent className="space-y-2">
          {data.alertasConciliacion.slice(0, 4).map((mov) => (
            <div key={mov.id} className="flex items-center justify-between rounded border border-red-100 bg-red-50 p-2 text-xs text-red-700">
              <span>{mov.concepto}</span>
              <span>{formatDate(mov.fecha)}</span>
            </div>
          ))}
          {data.alertasConciliacion.length === 0 ? (
            <p className="text-xs text-muted-foreground">Sin diferencias relevantes.</p>
          ) : null}
        </CardContent>
      </Card>

      <Card className="lg:col-span-6">
        <CardHeader>
          <CardTitle>Bitácora reciente</CardTitle>
          <CardDescription>Últimos movimientos registrados</CardDescription>
        </CardHeader>
        <CardContent className="space-y-3">
          {data.bitacoraReciente.map((item) => (
            <div key={`${item.ts}-${item.action}`} className="flex items-center justify-between rounded border border-dashed border-border px-3 py-2 text-sm">
              <div>
                <p className="font-medium">{item.action}</p>
                <p className="text-xs text-muted-foreground">{item.entidad}</p>
              </div>
              <div className="text-right text-xs text-muted-foreground">
                <p>{item.user}</p>
                <p>{formatDate(item.ts)}</p>
              </div>
            </div>
          ))}
          {data.bitacoraReciente.length === 0 ? (
            <p className="text-sm text-muted-foreground">Sin eventos registrados.</p>
          ) : null}
        </CardContent>
      </Card>

      <Card className="lg:col-span-6">
        <CardHeader>
          <CardTitle>Tareas del día</CardTitle>
          <CardDescription>Autorizaciones y revisiones pendientes</CardDescription>
        </CardHeader>
        <CardContent className="space-y-3">
          {data.tareasHoy.map((tarea) => (
            <div key={tarea.id} className="flex items-center justify-between rounded-lg border border-border px-3 py-2">
              <div>
                <p className="text-sm font-medium">{tarea.concepto}</p>
                <p className="text-xs text-muted-foreground">
                  {formatDate(tarea.fechaDocumento)} · {formatCurrency(tarea.importe)}
                </p>
              </div>
              <Badge variant="warning">{tarea.estatus}</Badge>
            </div>
          ))}
          {data.tareasHoy.length === 0 ? (
            <p className="text-sm text-muted-foreground">Sin tareas pendientes. ¡Buen trabajo!</p>
          ) : null}
        </CardContent>
      </Card>
    </div>
  );
};

// FILE: src/treasury/components/SidebarMenu.tsx
import { NavLink } from 'react-router-dom';
import { cn } from '@shared/lib/utils';
import { useUIStore } from '@shared/store/ui.store';
import {
  Banknote,
  BarChart3,
  BookOpenCheck,
  Building2,
  ChevronLeft,
  ChevronRight,
  CreditCard,
  FileText,
  LayoutDashboard,
  ListChecks,
  PiggyBank,
  Settings,
  Users
} from 'lucide-react';

const sections = [
  { to: '/tesoreria/dashboard', label: 'Dashboard', icon: LayoutDashboard },
  { to: '/tesoreria/ingresos', label: 'Ingresos', icon: PiggyBank },
  { to: '/tesoreria/egresos', label: 'Egresos', icon: Banknote },
  { to: '/tesoreria/compromisos', label: 'Compromisos de Pago', icon: ListChecks },
  { to: '/tesoreria/conciliacion', label: 'Conciliación Bancaria', icon: CreditCard },
  { to: '/tesoreria/presupuesto', label: 'Presupuesto', icon: BarChart3 },
  { to: '/tesoreria/proveedores', label: 'Proveedores', icon: Users },
  { to: '/tesoreria/bancos', label: 'Bancos y Cuentas', icon: Building2 },
  { to: '/tesoreria/movimientos', label: 'Movimientos Bancarios', icon: BookOpenCheck },
  { to: '/tesoreria/reportes', label: 'Reportes', icon: FileText },
  { to: '/tesoreria/config', label: 'Configuración de Tesorería', icon: Settings }
];

export const SidebarMenu = () => {
  const collapsed = useUIStore((state) => state.sidebarCollapsed);
  const toggleSidebar = useUIStore((state) => state.toggleSidebar);
  return (
    <aside
      className={cn(
        'flex h-screen flex-col border-r border-border bg-slate-950/95 text-slate-100 transition-all',
        collapsed ? 'w-20' : 'w-64'
      )}
    >
      <div className="flex h-16 items-center justify-between gap-2 px-4 text-lg font-semibold">
        <div className="flex items-center gap-2">
          <span className="inline-flex h-9 w-9 items-center justify-center rounded-full bg-primary text-sm font-bold text-white">
            TM
          </span>
          {!collapsed ? <span>Sistema Tesorería</span> : null}
        </div>
        <button
          type="button"
          onClick={toggleSidebar}
          className="rounded-md border border-primary/40 p-1 text-slate-200 transition hover:bg-primary/30"
          aria-label={collapsed ? 'Expandir menú' : 'Contraer menú'}
        >
          {collapsed ? <ChevronRight className="h-4 w-4" /> : <ChevronLeft className="h-4 w-4" />}
        </button>
      </div>
      <nav className="flex-1 overflow-y-auto px-2 pb-6">
        <ul className="space-y-1">
          {sections.map((section) => {
            const Icon = section.icon;
            return (
              <li key={section.to}>
                <NavLink
                  to={section.to}
                  className={({ isActive }) =>
                    cn(
                      'group flex items-center gap-3 rounded-md px-3 py-2 text-sm transition-colors hover:bg-primary/20',
                      isActive ? 'bg-primary/30 text-white' : 'text-slate-300'
                    )
                  }
                >
                  <Icon className="h-5 w-5" />
                  {!collapsed ? <span>{section.label}</span> : null}
                </NavLink>
              </li>
            );
          })}
        </ul>
      </nav>
      <footer className="border-t border-slate-800 px-3 py-4 text-xs text-slate-500">
        {!collapsed ? (
          <p>
            Rol activo: <span className="font-semibold text-slate-200">TESORERO</span>
          </p>
        ) : (
          <p className="text-center text-[10px]">TES</p>
        )}
      </footer>
    </aside>
  );
};

// FILE: src/treasury/components/Topbar.tsx
import { FormEvent, useState } from 'react';
import { Bell, LogOut, Search, User } from 'lucide-react';
import { Input } from '@shared/components/ui/input';
import { Button } from '@shared/components/ui/button';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuTrigger
} from '@shared/components/ui/dropdown-menu';
import { Avatar, AvatarFallback } from '@shared/components/ui/avatar';
import { useAuth } from '@auth/useAuth';
import { useNavigate } from 'react-router-dom';
import { toast } from '@shared/hooks/useToast';

interface TopbarProps {
  onSearch?: (term: string) => void;
  searchRef?: React.RefObject<HTMLInputElement>;
}

export const Topbar = ({ onSearch, searchRef }: TopbarProps) => {
  const [term, setTerm] = useState('');
  const { user, logout } = useAuth();
  const navigate = useNavigate();

  const handleSubmit = (event: FormEvent<HTMLFormElement>) => {
    event.preventDefault();
    onSearch?.(term);
    toast({ title: 'Búsqueda global', description: term ? `Resultados para “${term}”` : 'Sin filtros' });
  };

  return (
    <header className="sticky top-0 z-40 flex h-16 items-center gap-4 border-b border-border bg-background/90 px-6 backdrop-blur">
      <form onSubmit={handleSubmit} className="relative flex-1 max-w-xl" role="search">
        <Search className="absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground" />
        <Input
          ref={searchRef}
          placeholder="Buscar en Tesorería (/)"
          value={term}
          onChange={(event) => setTerm(event.target.value)}
          className="pl-9"
          aria-label="Buscar"
        />
      </form>
      <Button variant="ghost" size="icon" aria-label="Notificaciones">
        <Bell className="h-5 w-5" />
      </Button>
      <DropdownMenu>
        <DropdownMenuTrigger asChild>
          <Button variant="ghost" className="flex items-center gap-2">
            <Avatar>
              <AvatarFallback className="bg-primary/10 text-primary">{user?.nombre?.[0] ?? 'T'}</AvatarFallback>
            </Avatar>
            <span className="hidden text-sm font-medium md:inline">{user?.nombre ?? 'TESORERO'}</span>
          </Button>
        </DropdownMenuTrigger>
        <DropdownMenuContent align="end">
          <DropdownMenuLabel>Sesión activa</DropdownMenuLabel>
          <DropdownMenuSeparator />
          <DropdownMenuItem onSelect={() => navigate('/tesoreria/config')}>
            <User className="mr-2 h-4 w-4" /> Perfil
          </DropdownMenuItem>
          <DropdownMenuSeparator />
          <DropdownMenuItem onSelect={logout} className="text-destructive">
            <LogOut className="mr-2 h-4 w-4" /> Cerrar sesión
          </DropdownMenuItem>
        </DropdownMenuContent>
      </DropdownMenu>
    </header>
  );
};

// FILE: src/treasury/hooks/useBancos.ts
import { useMutation, useQuery, useQueryClient } from '@tanstack/react-query';
import { api } from '@shared/lib/api';
import type { CuentaBancaria, MovimientoBancario } from '@treasury/types';
import { toast } from '@shared/hooks/useToast';

export const useCuentas = () =>
  useQuery({
    queryKey: ['cuentas'],
    queryFn: async () => {
      const { data } = await api.get<CuentaBancaria[]>('/bancos');
      return data;
    }
  });

export const useMovimientos = (filters?: { cuentaId?: string; conciliado?: string }) =>
  useQuery({
    queryKey: ['movimientos', filters],
    queryFn: async () => {
      const { data } = await api.get<MovimientoBancario[]>('/movimientos', { params: filters });
      return data;
    }
  });

export const useGuardarCuenta = () => {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: async (payload: Partial<CuentaBancaria> & { id?: string }) => {
      if (payload.id) {
        const { data } = await api.put<CuentaBancaria>(`/bancos/${payload.id}`, payload);
        return data;
      }
      const { data } = await api.post<CuentaBancaria>('/bancos', payload);
      return data;
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['cuentas'] });
      toast({ title: 'Cuenta bancaria guardada', variant: 'success' });
    }
  });
};

export const useGuardarMovimiento = () => {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: async (payload: Partial<MovimientoBancario> & { id?: string }) => {
      if (payload.id) {
        const { data } = await api.put<MovimientoBancario>(`/movimientos/${payload.id}`, payload);
        return data;
      }
      const { data } = await api.post<MovimientoBancario>('/movimientos', payload);
      return data;
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['movimientos'] });
      toast({ title: 'Movimiento registrado', variant: 'success' });
    }
  });
};

export const useImportarMovimientos = () => {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: async (lista: MovimientoBancario[]) => {
      const { data } = await api.post<MovimientoBancario[]>('/movimientos/import', lista);
      return data;
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['movimientos'] });
      toast({ title: 'Movimientos importados', variant: 'success' });
    }
  });
};

export const useConciliarMovimientos = () => {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: async ({ ids, conciliado }: { ids: string[]; conciliado: boolean }) => {
      const { data } = await api.post('/conciliacion/match', { ids, conciliado });
      return data;
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['movimientos'] });
      toast({ title: 'Conciliación actualizada' });
    }
  });
};

// FILE: src/treasury/hooks/useCompromisos.ts
import { useMutation, useQuery, useQueryClient } from '@tanstack/react-query';
import { api } from '@shared/lib/api';
import type { Compromiso, EstatusCompromiso } from '@treasury/types';
import { toast } from '@shared/hooks/useToast';

export interface CompromisosFilters {
  q?: string;
  estatus?: EstatusCompromiso;
  proveedorId?: string;
  fechaInicio?: string;
  fechaFin?: string;
}

export const useCompromisos = (filters?: CompromisosFilters) =>
  useQuery({
    queryKey: ['compromisos', filters],
    queryFn: async () => {
      const { data } = await api.get<Compromiso[]>('/compromisos', { params: filters });
      return data;
    }
  });

export const useCompromiso = (id?: string) =>
  useQuery({
    queryKey: ['compromiso', id],
    queryFn: async () => {
      if (!id) return null;
      const { data } = await api.get<Compromiso>(`/compromisos/${id}`);
      return data;
    },
    enabled: Boolean(id)
  });

export const useCreateCompromiso = () => {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: async (payload: Compromiso) => {
      const { data } = await api.post<Compromiso>('/compromisos', payload);
      return data;
    },
    onSuccess: (compromiso) => {
      queryClient.invalidateQueries({ queryKey: ['compromisos'] });
      toast({ title: 'Compromiso creado', description: compromiso.concepto, variant: 'success' });
    }
  });
};

export const useUpdateCompromiso = () => {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: async ({ id, payload }: { id: string; payload: Partial<Compromiso> }) => {
      const { data } = await api.put<Compromiso>(`/compromisos/${id}`, payload);
      return data;
    },
    onSuccess: (compromiso) => {
      queryClient.invalidateQueries({ queryKey: ['compromisos'] });
      queryClient.invalidateQueries({ queryKey: ['compromiso', compromiso.id] });
      toast({ title: 'Compromiso actualizado', description: compromiso.concepto });
    }
  });
};

export const useCompromisoTransition = () => {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: async ({
      id,
      estatus,
      motivo,
      refPago,
      fechaPago
    }: {
      id: string;
      estatus: EstatusCompromiso;
      motivo?: string;
      refPago?: string;
      fechaPago?: string;
    }) => {
      const { data } = await api.post<Compromiso>(`/compromisos/${id}/transition`, {
        estatus,
        motivo,
        refPago,
        fechaPago
      });
      return data;
    },
    onSuccess: (compromiso) => {
      queryClient.invalidateQueries({ queryKey: ['compromisos'] });
      queryClient.invalidateQueries({ queryKey: ['compromiso', compromiso.id] });
      toast({ title: 'Estatus actualizado', description: `${compromiso.estatus}` });
    }
  });
};

// FILE: src/treasury/hooks/useDashboard.ts
import { useQuery } from '@tanstack/react-query';
import { api } from '@shared/lib/api';
import type { Compromiso, MovimientoBancario } from '@treasury/types';

export interface DashboardData {
  ingresosMes: number;
  metaMensual: number;
  egresosCapitulo: Record<string, number>;
  avancePresupuestal: Array<{ clave: string; nombre: string; disponible: number; pagado: number }>;
  compromisosPorVencer: Compromiso[];
  alertasConciliacion: MovimientoBancario[];
  bitacoraReciente: Array<{ ts: string; user: string; action: string; entidad: string }>;
  tareasHoy: Compromiso[];
}

export const useDashboard = () =>
  useQuery({
    queryKey: ['dashboard'],
    queryFn: async () => {
      const { data } = await api.get<DashboardData>('/dashboard/tesoreria');
      return data;
    }
  });

// FILE: src/treasury/hooks/useEgresos.ts
import { useMutation, useQuery, useQueryClient } from '@tanstack/react-query';
import { api } from '@shared/lib/api';
import type { Egreso } from '@treasury/types';
import { toast } from '@shared/hooks/useToast';
import { downloadFile } from '@shared/lib/utils';

export interface EgresosFilters {
  q?: string;
  proveedorId?: string;
  estatus?: 'PENDIENTE' | 'PAGADO';
  fechaInicio?: string;
  fechaFin?: string;
}

export const useEgresos = (filters?: EgresosFilters) =>
  useQuery({
    queryKey: ['egresos', filters],
    queryFn: async () => {
      const { data } = await api.get<Egreso[]>('/egresos', { params: filters });
      return data;
    }
  });

export const useEgreso = (id?: string) =>
  useQuery({
    queryKey: ['egreso', id],
    queryFn: async () => {
      if (!id) return null;
      const { data } = await api.get<Egreso>(`/egresos/${id}`);
      return data;
    },
    enabled: Boolean(id)
  });

export const useCreateEgreso = () => {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: async (payload: Partial<Egreso>) => {
      const { data } = await api.post<Egreso>('/egresos', payload);
      return data;
    },
    onSuccess: (egreso) => {
      queryClient.invalidateQueries({ queryKey: ['egresos'] });
      toast({ title: 'Egreso registrado', description: egreso.concepto, variant: 'success' });
    }
  });
};

export const useUpdateEgreso = () => {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: async ({ id, payload }: { id: string; payload: Partial<Egreso> }) => {
      const { data } = await api.put<Egreso>(`/egresos/${id}`, payload);
      return data;
    },
    onSuccess: (egreso) => {
      queryClient.invalidateQueries({ queryKey: ['egresos'] });
      queryClient.invalidateQueries({ queryKey: ['egreso', egreso.id] });
      toast({ title: 'Egreso actualizado', description: egreso.concepto });
    }
  });
};

export const useDeleteEgreso = () => {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: async (id: string) => {
      await api.delete(`/egresos/${id}`);
      return id;
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['egresos'] });
      toast({ title: 'Egreso eliminado', variant: 'warning' });
    }
  });
};

export const exportEgresosCSV = (egresos: Egreso[]) => {
  const header = 'fecha,concepto,proveedor,importe,cuenta,partida,capitulo,estatus';
  const rows = egresos.map((eg) =>
    [eg.fecha, eg.concepto, eg.proveedorId, eg.importe.toFixed(2), eg.cuentaId, eg.partida, eg.capitulo, eg.estatus]
      .map((value) => `"${value}"`)
      .join(',')
  );
  downloadFile(`egresos-${new Date().toISOString()}.csv`, [header, ...rows].join('\n'));
};

// FILE: src/treasury/hooks/useIngresos.ts
import { useMutation, useQuery, useQueryClient } from '@tanstack/react-query';
import { api } from '@shared/lib/api';
import type { Ingreso } from '@treasury/types';
import { toast } from '@shared/hooks/useToast';
import { downloadFile } from '@shared/lib/utils';

export interface IngresosFilters {
  q?: string;
  fechaInicio?: string;
  fechaFin?: string;
  fuente?: string;
  cuentaId?: string;
}

const queryKey = (filters?: IngresosFilters) => ['ingresos', filters] as const;

export const useIngresos = (filters?: IngresosFilters) =>
  useQuery({
    queryKey: queryKey(filters),
    queryFn: async () => {
      const { data } = await api.get<Ingreso[]>('/ingresos', { params: filters });
      return data;
    }
  });

export const useIngreso = (id?: string) =>
  useQuery({
    queryKey: ['ingreso', id],
    queryFn: async () => {
      if (!id) return null;
      const { data } = await api.get<Ingreso>(`/ingresos/${id}`);
      return data;
    },
    enabled: Boolean(id)
  });

export const useCreateIngreso = () => {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: async (payload: Partial<Ingreso>) => {
      const { data } = await api.post<Ingreso>('/ingresos', payload);
      return data;
    },
    onSuccess: (ingreso) => {
      queryClient.invalidateQueries({ queryKey: ['ingresos'] });
      toast({ title: 'Ingreso registrado', description: ingreso.concepto, variant: 'success' });
    }
  });
};

export const useUpdateIngreso = () => {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: async ({ id, payload }: { id: string; payload: Partial<Ingreso> }) => {
      const { data } = await api.put<Ingreso>(`/ingresos/${id}`, payload);
      return data;
    },
    onSuccess: (ingreso) => {
      queryClient.invalidateQueries({ queryKey: ['ingresos'] });
      queryClient.invalidateQueries({ queryKey: ['ingreso', ingreso.id] });
      toast({ title: 'Ingreso actualizado', description: ingreso.concepto });
    }
  });
};

export const useDeleteIngreso = () => {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: async (id: string) => {
      await api.delete(`/ingresos/${id}`);
      return id;
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['ingresos'] });
      toast({ title: 'Ingreso eliminado', variant: 'warning' });
    }
  });
};

export const exportIngresosCSV = (ingresos: Ingreso[]) => {
  const header = 'fecha,concepto,importe,fuente,referencia,cuenta,partida,capitulo';
  const rows = ingresos.map((ing) =>
    [ing.fecha, ing.concepto, ing.importe.toFixed(2), ing.fuente, ing.referencia ?? '', ing.cuentaId, ing.partida, ing.capitulo]
      .map((value) => `"${value}"`)
      .join(',')
  );
  downloadFile(`ingresos-${new Date().toISOString()}.csv`, [header, ...rows].join('\n'));
};

// FILE: src/treasury/hooks/usePresupuesto.ts
import { useMutation, useQuery, useQueryClient } from '@tanstack/react-query';
import { api } from '@shared/lib/api';
import type { Presupuesto } from '@treasury/types';
import { toast } from '@shared/hooks/useToast';

export const usePresupuesto = () =>
  useQuery({
    queryKey: ['presupuesto'],
    queryFn: async () => {
      const { data } = await api.get<Presupuesto & {
        partidas: Array<Presupuesto['partidas'][number] & {
          comprometido: number;
          devengado: number;
          pagado: number;
          disponible: number;
        }>;
      }>('/presupuesto');
      return data;
    }
  });

export const useModificarPresupuesto = () => {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: async ({ partida, monto, motivo }: { partida: string; monto: number; motivo: string }) => {
      const { data } = await api.post('/presupuesto/modificaciones', { partida, monto, motivo });
      return data;
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['presupuesto'] });
      toast({ title: 'Presupuesto actualizado', variant: 'success' });
    }
  });
};

// FILE: src/treasury/hooks/useProveedores.ts
import { useMutation, useQuery, useQueryClient } from '@tanstack/react-query';
import { api } from '@shared/lib/api';
import type { Proveedor } from '@treasury/types';
import { toast } from '@shared/hooks/useToast';

export const useProveedores = (search?: string) =>
  useQuery({
    queryKey: ['proveedores', search],
    queryFn: async () => {
      const { data } = await api.get<Proveedor[]>('/proveedores', { params: { q: search } });
      return data;
    }
  });

export const useCrearProveedor = () => {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: async (payload: Partial<Proveedor>) => {
      const { data } = await api.post<Proveedor>('/proveedores', payload);
      return data;
    },
    onSuccess: (proveedor) => {
      queryClient.invalidateQueries({ queryKey: ['proveedores'] });
      toast({ title: 'Proveedor agregado', description: proveedor.nombre, variant: 'success' });
    }
  });
};

export const useActualizarProveedor = () => {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: async ({ id, payload }: { id: string; payload: Partial<Proveedor> }) => {
      const { data } = await api.put<Proveedor>(`/proveedores/${id}`, payload);
      return data;
    },
    onSuccess: (proveedor) => {
      queryClient.invalidateQueries({ queryKey: ['proveedores'] });
      toast({ title: 'Proveedor actualizado', description: proveedor.nombre });
    }
  });
};

export const useEliminarProveedor = () => {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: async (id: string) => {
      await api.delete(`/proveedores/${id}`);
      return id;
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['proveedores'] });
      toast({ title: 'Proveedor eliminado', variant: 'warning' });
    }
  });
};

// FILE: src/treasury/hooks/useReportes.ts
import { useQuery } from '@tanstack/react-query';
import { api } from '@shared/lib/api';
import { downloadFile } from '@shared/lib/utils';

export interface ReportesFilters {
  cuentaId?: string;
  capitulo?: string;
  fechaInicio?: string;
  fechaFin?: string;
}

export interface ReporteData {
  libroIngresos: Array<{ tipo: string; fecha: string; concepto: string; importe: number }>;
  libroEgresos: Array<{ tipo: string; fecha: string; concepto: string; importe: number; proveedorId: string }>;
  compromisosPorEstatus: Record<string, { total: number; items: any[] }>;
  flujoCaja: number;
}

export const useReportes = (filters?: ReportesFilters) =>
  useQuery({
    queryKey: ['reportes', filters],
    queryFn: async () => {
      const { data } = await api.get<ReporteData>('/reportes', { params: filters });
      return data;
    }
  });

export const exportReporteCSV = (titulo: string, rows: Array<Record<string, unknown>>) => {
  if (!rows.length) return;
  const header = Object.keys(rows[0]).join(',');
  const dataRows = rows.map((row) => Object.values(row).map((value) => `"${value ?? ''}"`).join(','));
  downloadFile(`${titulo}-${new Date().toISOString()}.csv`, [header, ...dataRows].join('\n'));
};

// FILE: src/treasury/pages/BancosCuentas.tsx
import { useEffect, useState } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@shared/components/ui/card';
import { Button } from '@shared/components/ui/button';
import { Input } from '@shared/components/ui/input';
import { useCuentas, useGuardarCuenta } from '../hooks/useBancos';
import { formatCurrency } from '@shared/lib/utils';
import { useUIStore } from '@shared/store/ui.store';
import type { CuentaBancaria } from '@treasury/types';
import { toast } from '@shared/hooks/useToast';

export const BancosCuentasPage = () => {
  const { data, isLoading, refetch } = useCuentas();
  const guardarCuenta = useGuardarCuenta();
  const setBreadcrumb = useUIStore((state) => state.setBreadcrumb);
  const [form, setForm] = useState<Partial<CuentaBancaria>>({ nombre: '', banco: '', clabe: '', saldo: 0, moneda: 'MXN' });

  useEffect(() => {
    setBreadcrumb(['Tesorería', 'Bancos y Cuentas']);
  }, [setBreadcrumb]);

  const handleSubmit = async () => {
    if (!form.nombre || !form.banco || !form.clabe) {
      toast({ title: 'Complete la información obligatoria', variant: 'warning' });
      return;
    }
    await guardarCuenta.mutateAsync(form as CuentaBancaria);
    setForm({ nombre: '', banco: '', clabe: '', saldo: 0, moneda: 'MXN' });
    refetch();
  };

  return (
    <div className="space-y-4">
      <Card>
        <CardHeader>
          <CardTitle>Registrar cuenta bancaria</CardTitle>
        </CardHeader>
        <CardContent className="grid gap-3 md:grid-cols-5">
          <Input placeholder="Banco" value={form.banco ?? ''} onChange={(event) => setForm((prev) => ({ ...prev, banco: event.target.value }))} />
          <Input placeholder="Nombre" value={form.nombre ?? ''} onChange={(event) => setForm((prev) => ({ ...prev, nombre: event.target.value }))} />
          <Input placeholder="CLABE" value={form.clabe ?? ''} onChange={(event) => setForm((prev) => ({ ...prev, clabe: event.target.value }))} />
          <Input
            type="number"
            step="0.01"
            placeholder="Saldo inicial"
            value={form.saldo ?? 0}
            onChange={(event) => setForm((prev) => ({ ...prev, saldo: Number(event.target.value) }))}
          />
          <Button onClick={handleSubmit} disabled={guardarCuenta.isPending}>
            Guardar
          </Button>
        </CardContent>
      </Card>
      <Card>
        <CardHeader>
          <CardTitle>Cuentas activas</CardTitle>
        </CardHeader>
        <CardContent className="space-y-3">
          {isLoading ? <p className="text-sm text-muted-foreground">Cargando cuentas…</p> : null}
          <ul className="grid gap-3 md:grid-cols-2">
            {data?.map((cuenta) => (
              <li key={cuenta.id} className="rounded-lg border border-border p-4">
                <p className="text-sm font-semibold">{cuenta.nombre}</p>
                <p className="text-xs text-muted-foreground">{cuenta.banco} · {cuenta.clabe}</p>
                <p className="text-sm">Saldo: {formatCurrency(cuenta.saldo)}</p>
                <Button
                  variant="outline"
                  size="sm"
                  className="mt-2"
                  onClick={() => setForm(cuenta)}
                >
                  Editar
                </Button>
              </li>
            ))}
          </ul>
        </CardContent>
      </Card>
    </div>
  );
};

// FILE: src/treasury/pages/CompromisoDetail.tsx
import { useEffect } from 'react';
import { useNavigate, useParams } from 'react-router-dom';
import { Card, CardContent, CardHeader, CardTitle } from '@shared/components/ui/card';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@shared/components/ui/tabs';
import { Button } from '@shared/components/ui/button';
import { StatusBadge } from '@shared/components/StatusBadge';
import { formatCurrency, formatDate } from '@shared/lib/utils';
import { BudgetAffectation } from '../components/BudgetAffectation';
import { CFDIViewer } from '@shared/components/CFDIViewer';
import { AuditTrail } from '@shared/components/AuditTrail';
import { useCompromiso, useCompromisoTransition } from '../hooks/useCompromisos';
import { usePresupuesto } from '../hooks/usePresupuesto';
import { useUIStore } from '@shared/store/ui.store';
import { usePermissions } from '@shared/hooks/usePermissions';
import type { EstatusCompromiso } from '@treasury/types';
import { toast } from '@shared/hooks/useToast';

const nextActions: Partial<Record<EstatusCompromiso, EstatusCompromiso[]>> = {
  BORRADOR: ['REVISION'],
  REVISION: ['RECHAZADO', 'AUTORIZADO'],
  AUTORIZADO: ['PAGADO'],
  PAGADO: ['CERRADO']
};

export const CompromisoDetail = () => {
  const { id } = useParams();
  const { data, isLoading, refetch } = useCompromiso(id);
  const { data: presupuesto } = usePresupuesto();
  const { has } = usePermissions();
  const { mutateAsync, isPending } = useCompromisoTransition();
  const setBreadcrumb = useUIStore((state) => state.setBreadcrumb);
  const navigate = useNavigate();

  useEffect(() => {
    setBreadcrumb(['Tesorería', 'Compromisos de Pago', `Detalle ${id ?? ''}`]);
  }, [id, setBreadcrumb]);

  if (isLoading) return <p className="text-sm text-muted-foreground">Cargando compromiso…</p>;
  if (!data) return <p className="text-sm text-muted-foreground">Compromiso no encontrado.</p>;

  const partida = presupuesto?.partidas.find((item) => item.clave === data.partida);
  const acciones = nextActions[data.estatus] ?? [];

  const ejecutarTransicion = async (estatus: EstatusCompromiso) => {
    if (!has('AUTORIZAR') && estatus === 'AUTORIZADO') {
      toast({ title: 'Sin permisos', description: 'Se requiere permiso de autorización.', variant: 'warning' });
      return;
    }
    let motivo: string | undefined;
    let refPago: string | undefined;
    let fechaPago: string | undefined;
    if (estatus === 'RECHAZADO') {
      motivo = window.prompt('Indique el motivo del rechazo:') ?? '';
      if (!motivo) return;
    }
    if (estatus === 'PAGADO') {
      refPago = window.prompt('Folio de pago capturado:') ?? '';
      fechaPago = window.prompt('Fecha de pago (YYYY-MM-DD):', new Date().toISOString().slice(0, 10)) ?? '';
    }
    await mutateAsync({ id: data.id, estatus, motivo, refPago, fechaPago });
    refetch();
  };

  return (
    <div className="space-y-4">
      <div className="flex flex-wrap items-center justify-between gap-3">
        <div>
          <h1 className="text-xl font-semibold">{data.concepto}</h1>
          <p className="text-sm text-muted-foreground">
            Programado para {formatDate(data.fechaProgramada)} · {data.proveedor.nombre}
          </p>
        </div>
        <div className="flex items-center gap-2">
          <StatusBadge status={data.estatus} />
          {acciones.map((accion) => (
            <Button key={accion} size="sm" onClick={() => ejecutarTransicion(accion)} disabled={isPending}>
              {accion}
            </Button>
          ))}
        </div>
      </div>
      <Tabs defaultValue="datos">
        <TabsList>
          <TabsTrigger value="datos">Datos</TabsTrigger>
          <TabsTrigger value="presupuesto">Presupuesto</TabsTrigger>
          <TabsTrigger value="adjuntos">Adjuntos</TabsTrigger>
          <TabsTrigger value="bitacora">Bitácora</TabsTrigger>
        </TabsList>
        <TabsContent value="datos" className="mt-4">
          <Card>
            <CardHeader>
              <CardTitle>Información del compromiso</CardTitle>
            </CardHeader>
            <CardContent className="grid gap-4 md:grid-cols-2">
              <div>
                <p className="text-sm font-medium">Proveedor</p>
                <p className="text-sm text-muted-foreground">{data.proveedor.nombre}</p>
              </div>
              <div>
                <p className="text-sm font-medium">Importe</p>
                <p className="text-sm text-muted-foreground">{formatCurrency(data.importe)}</p>
              </div>
              <div>
                <p className="text-sm font-medium">Fecha documento</p>
                <p className="text-sm text-muted-foreground">{formatDate(data.fechaDocumento)}</p>
              </div>
              <div>
                <p className="text-sm font-medium">Fecha programada</p>
                <p className="text-sm text-muted-foreground">{formatDate(data.fechaProgramada)}</p>
              </div>
              <div>
                <p className="text-sm font-medium">Banco</p>
                <p className="text-sm text-muted-foreground">{data.banco ?? 'No definido'}</p>
              </div>
              <div>
                <p className="text-sm font-medium">Referencia</p>
                <p className="text-sm text-muted-foreground">{data.refPago ?? '—'}</p>
              </div>
              <div className="md:col-span-2">
                <CFDIViewer uuid={data.uuid} />
              </div>
            </CardContent>
          </Card>
        </TabsContent>
        <TabsContent value="presupuesto" className="mt-4">
          <Card>
            <CardHeader>
              <CardTitle>Afectación presupuestal</CardTitle>
            </CardHeader>
            <CardContent>
              <BudgetAffectation partida={partida} importe={data.importe} />
            </CardContent>
          </Card>
        </TabsContent>
        <TabsContent value="adjuntos" className="mt-4">
          <Card>
            <CardHeader>
              <CardTitle>Adjuntos cargados</CardTitle>
            </CardHeader>
            <CardContent>
              <ul className="space-y-2 text-sm">
                {data.adjuntos?.map((adjunto) => (
                  <li key={adjunto.id} className="flex items-center justify-between rounded border border-border/80 px-3 py-2">
                    <span>{adjunto.name}</span>
                    <Button variant="ghost" size="sm" onClick={() => toast({ title: 'Descarga simulada', description: adjunto.name })}>
                      Descargar
                    </Button>
                  </li>
                ))}
              </ul>
              {!data.adjuntos?.length ? <p className="text-sm text-muted-foreground">Sin adjuntos registrados.</p> : null}
            </CardContent>
          </Card>
        </TabsContent>
        <TabsContent value="bitacora" className="mt-4">
          <Card>
            <CardHeader>
              <CardTitle>Bitácora de acciones</CardTitle>
            </CardHeader>
            <CardContent>
              <AuditTrail entries={data.bitacora} />
            </CardContent>
          </Card>
        </TabsContent>
      </Tabs>
      <Button variant="outline" onClick={() => navigate('/tesoreria/compromisos')}>
        Regresar a la lista
      </Button>
    </div>
  );
};

// FILE: src/treasury/pages/CompromisoNew.tsx
import { useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { Card, CardContent, CardHeader, CardTitle } from '@shared/components/ui/card';
import { CompromisoWizard } from '../components/CompromisoWizard';
import { useCreateCompromiso } from '../hooks/useCompromisos';
import { useProveedores } from '../hooks/useProveedores';
import { usePresupuesto } from '../hooks/usePresupuesto';
import { useCuentas } from '../hooks/useBancos';
import { useUIStore } from '@shared/store/ui.store';

export const CompromisoNew = () => {
  const navigate = useNavigate();
  const setBreadcrumb = useUIStore((state) => state.setBreadcrumb);
  const { data: proveedores } = useProveedores();
  const { data: presupuesto } = usePresupuesto();
  const { data: cuentas } = useCuentas();
  const { mutateAsync, isPending } = useCreateCompromiso();

  useEffect(() => {
    setBreadcrumb(['Tesorería', 'Compromisos de Pago', 'Nuevo compromiso']);
  }, [setBreadcrumb]);

  return (
    <Card>
      <CardHeader>
        <CardTitle>Generar compromiso</CardTitle>
      </CardHeader>
      <CardContent>
        <CompromisoWizard
          proveedores={proveedores ?? []}
          partidas={presupuesto?.partidas ?? []}
          cuentas={cuentas ?? []}
          onSubmit={async (values) => {
            await mutateAsync(values);
            navigate('/tesoreria/compromisos');
          }}
        />
        {isPending ? <p className="mt-3 text-xs text-muted-foreground">Guardando compromiso…</p> : null}
      </CardContent>
    </Card>
  );
};

// FILE: src/treasury/pages/CompromisosList.tsx
import { useEffect, useMemo, useState } from 'react';
import type { ColumnDef } from '@tanstack/react-table';
import { Button } from '@shared/components/ui/button';
import { Input } from '@shared/components/ui/input';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@shared/components/ui/select';
import { DataTable } from '@shared/components/DataTable';
import { formatCurrency, formatDate } from '@shared/lib/utils';
import { useCompromisos, type CompromisosFilters } from '../hooks/useCompromisos';
import type { Compromiso } from '@treasury/types';
import { useProveedores } from '../hooks/useProveedores';
import { useNavigate } from 'react-router-dom';
import { useUIStore } from '@shared/store/ui.store';
import { StatusBadge } from '@shared/components/StatusBadge';
import { Plus } from 'lucide-react';

const ESTATUS = ['BORRADOR', 'REVISION', 'RECHAZADO', 'AUTORIZADO', 'PAGADO', 'CERRADO'] as const;

export const CompromisosList = () => {
  const [filters, setFilters] = useState<CompromisosFilters>({});
  const { data, isLoading } = useCompromisos(filters);
  const { data: proveedores } = useProveedores();
  const navigate = useNavigate();
  const setBreadcrumb = useUIStore((state) => state.setBreadcrumb);

  useEffect(() => {
    setBreadcrumb(['Tesorería', 'Compromisos de Pago']);
  }, [setBreadcrumb]);

  const columns = useMemo<ColumnDef<Compromiso>[]>(
    () => [
      {
        accessorKey: 'fechaDocumento',
        header: 'Fecha documento',
        cell: ({ row }) => formatDate(row.original.fechaDocumento)
      },
      {
        accessorKey: 'concepto',
        header: 'Concepto'
      },
      {
        accessorKey: 'proveedor',
        header: 'Proveedor',
        cell: ({ row }) => row.original.proveedor.nombre
      },
      {
        accessorKey: 'importe',
        header: 'Importe',
        cell: ({ row }) => <span className="font-medium">{formatCurrency(row.original.importe)}</span>
      },
      {
        accessorKey: 'partida',
        header: 'Partida'
      },
      {
        accessorKey: 'estatus',
        header: 'Estatus',
        cell: ({ row }) => <StatusBadge status={row.original.estatus} />
      }
    ],
    []
  );

  const filtersComponent = (
    <div className="flex flex-wrap items-center gap-2">
      <Input
        type="date"
        value={filters.fechaInicio ?? ''}
        onChange={(event) => setFilters((prev) => ({ ...prev, fechaInicio: event.target.value }))}
        className="w-36"
      />
      <Input
        type="date"
        value={filters.fechaFin ?? ''}
        onChange={(event) => setFilters((prev) => ({ ...prev, fechaFin: event.target.value }))}
        className="w-36"
      />
      <Select value={filters.estatus ?? ''} onValueChange={(value) => setFilters((prev) => ({ ...prev, estatus: (value as Compromiso['estatus']) || undefined }))}>
        <SelectTrigger className="w-44">
          <SelectValue placeholder="Estatus" />
        </SelectTrigger>
        <SelectContent>
          <SelectItem value="">Todos</SelectItem>
          {ESTATUS.map((estatus) => (
            <SelectItem key={estatus} value={estatus}>
              {estatus}
            </SelectItem>
          ))}
        </SelectContent>
      </Select>
      <Select value={filters.proveedorId ?? ''} onValueChange={(value) => setFilters((prev) => ({ ...prev, proveedorId: value || undefined }))}>
        <SelectTrigger className="w-48">
          <SelectValue placeholder="Proveedor" />
        </SelectTrigger>
        <SelectContent>
          <SelectItem value="">Todos</SelectItem>
          {proveedores?.map((prov) => (
            <SelectItem key={prov.id} value={prov.id}>
              {prov.nombre}
            </SelectItem>
          ))}
        </SelectContent>
      </Select>
      <Button variant="ghost" size="sm" onClick={() => setFilters({})}>
        Limpiar filtros
      </Button>
    </div>
  );

  return (
    <div className="space-y-4">
      <div className="flex flex-wrap items-center justify-between gap-3">
        <div>
          <h1 className="text-xl font-semibold">Compromisos de pago</h1>
          <p className="text-sm text-muted-foreground">Gestione el flujo de autorizaciones y pagos.</p>
        </div>
        <Button size="sm" onClick={() => navigate('/tesoreria/compromisos/nuevo')}>
          <Plus className="mr-2 h-4 w-4" /> Nuevo compromiso
        </Button>
      </div>
      <DataTable
        data={data ?? []}
        columns={columns}
        searchPlaceholder="Buscar por concepto"
        manualFilterComponent={filtersComponent}
        onRowClick={(row) => navigate(`/tesoreria/compromisos/${row.id}`)}
      />
      {isLoading ? <p className="text-sm text-muted-foreground">Cargando compromisos…</p> : null}
    </div>
  );
};

// FILE: src/treasury/pages/Conciliacion.tsx
import { useEffect, useState } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@shared/components/ui/card';
import { Button } from '@shared/components/ui/button';
import { Input } from '@shared/components/ui/input';
import { useMovimientos, useConciliarMovimientos, useImportarMovimientos } from '../hooks/useBancos';
import { BankMatchTable } from '../components/BankMatchTable';
import { toast } from '@shared/hooks/useToast';
import { useUIStore } from '@shared/store/ui.store';
import { downloadFile } from '@shared/lib/utils';
import sampleConciliacion from '@mocks/data/conciliacion_ejemplo.csv?raw';

const parseCSV = async (file: File) => {
  const text = await file.text();
  const [header, ...rows] = text.trim().split(/\r?\n/);
  const columns = header.split(',');
  return rows.map((row) => {
    const values = row.split(',');
    const record: Record<string, string> = {};
    columns.forEach((col, index) => {
      record[col.trim()] = values[index]?.replace(/"/g, '') ?? '';
    });
    return {
      id: crypto.randomUUID(),
      cuentaId: record.cuenta,
      fecha: record.fecha,
      concepto: record.concepto,
      importe: Number(record.importe),
      tipo: record.tipo === 'CARGO' ? 'CARGO' : 'ABONO',
      ref: record.ref,
      conciliado: record.conciliado === 'true'
    };
  });
};

export const Conciliacion = () => {
  const setBreadcrumb = useUIStore((state) => state.setBreadcrumb);
  const [cuentaId, setCuentaId] = useState<string | undefined>();
  const { data: movimientos } = useMovimientos({ cuentaId });
  const conciliar = useConciliarMovimientos();
  const importar = useImportarMovimientos();

  useEffect(() => {
    setBreadcrumb(['Tesorería', 'Conciliación Bancaria']);
  }, [setBreadcrumb]);

  const handleImport = async (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0];
    if (!file) return;
    const registros = await parseCSV(file);
    await importar.mutateAsync(registros as any);
    toast({ title: 'Archivo importado', description: `${registros.length} movimientos agregados.` });
  };

  return (
    <div className="space-y-4">
      <Card>
        <CardHeader>
          <CardTitle>Conciliación bancaria</CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          <div className="flex flex-wrap items-center gap-2">
            <Input
              placeholder="Filtrar por cuenta (ej. CTA-001)"
              value={cuentaId ?? ''}
              onChange={(event) => setCuentaId(event.target.value || undefined)}
              className="w-48"
            />
            <Input type="file" accept=".csv" onChange={handleImport} className="w-60" />
            <Button
              variant="outline"
              size="sm"
              onClick={() => downloadFile('conciliacion_ejemplo.csv', sampleConciliacion, 'text/csv')}
            >
              Descargar plantilla
            </Button>
            <p className="text-xs text-muted-foreground">Periodo bloqueado después del cierre mensual del día 25.</p>
          </div>
          <BankMatchTable
            movimientos={movimientos ?? []}
            onToggle={async (ids, conciliado) => {
              await conciliar.mutateAsync({ ids, conciliado });
            }}
          />
        </CardContent>
      </Card>
    </div>
  );
};

// FILE: src/treasury/pages/ConfigTesoreria.tsx
import { useEffect, useState } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@shared/components/ui/card';
import { Button } from '@shared/components/ui/button';
import { Input } from '@shared/components/ui/input';
import { Switch } from '@shared/components/ui/switch';
import { useUIStore } from '@shared/store/ui.store';
import { useAuthStore } from '@auth/auth.store';
import { toast } from '@shared/hooks/useToast';

export const ConfigTesoreriaPage = () => {
  const setBreadcrumb = useUIStore((state) => state.setBreadcrumb);
  const user = useAuthStore((state) => state.user);
  const [uuidObligatorio, setUuidObligatorio] = useState(true);
  const [moneda, setMoneda] = useState('MXN');
  const [formatoFecha, setFormatoFecha] = useState('DD/MM/YYYY');

  useEffect(() => {
    setBreadcrumb(['Tesorería', 'Configuración de Tesorería']);
  }, [setBreadcrumb]);

  return (
    <div className="space-y-4">
      <Card>
        <CardHeader>
          <CardTitle>Parámetros de validación</CardTitle>
        </CardHeader>
        <CardContent className="space-y-3">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-sm font-medium">UUID obligatorio</p>
              <p className="text-xs text-muted-foreground">Exigir UUID en egresos y compromisos.</p>
            </div>
            <Switch checked={uuidObligatorio} onCheckedChange={(value) => setUuidObligatorio(Boolean(value))} />
          </div>
          <div className="grid gap-2 md:grid-cols-2">
            <div>
              <p className="text-sm font-medium">Formato de fecha</p>
              <Input value={formatoFecha} onChange={(event) => setFormatoFecha(event.target.value)} />
            </div>
            <div>
              <p className="text-sm font-medium">Moneda oficial</p>
              <Input value={moneda} onChange={(event) => setMoneda(event.target.value)} />
            </div>
          </div>
          <Button
            size="sm"
            onClick={() => toast({ title: 'Configuración guardada', description: 'Las reglas se aplicarán en próximos registros.' })}
          >
            Guardar cambios
          </Button>
        </CardContent>
      </Card>
      <Card>
        <CardHeader>
          <CardTitle>Usuarios autorizados</CardTitle>
        </CardHeader>
        <CardContent>
          <p className="text-sm">Usuario activo:</p>
          <div className="rounded border border-border p-3 text-sm">
            <p className="font-semibold">{user?.nombre}</p>
            <p className="text-xs text-muted-foreground">{user?.email}</p>
            <p className="text-xs">Rol: {user?.rol}</p>
          </div>
          <p className="mt-2 text-xs text-muted-foreground">Solo el TESORERO está habilitado en este módulo.</p>
        </CardContent>
      </Card>
    </div>
  );
};

// FILE: src/treasury/pages/DashboardTesoreria.tsx
import { useEffect } from 'react';
import { KPIWidgets } from '../components/KPIWidgets';
import { useDashboard } from '../hooks/useDashboard';
import { useUIStore } from '@shared/store/ui.store';
import { Button } from '@shared/components/ui/button';
import { RefreshCcw } from 'lucide-react';

export const DashboardTesoreria = () => {
  const { data, isLoading, refetch } = useDashboard();
  const setBreadcrumb = useUIStore((state) => state.setBreadcrumb);

  useEffect(() => {
    setBreadcrumb(['Tesorería', 'Dashboard']);
  }, [setBreadcrumb]);

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-semibold">Panel general</h1>
          <p className="text-sm text-muted-foreground">Seguimiento financiero diario del municipio.</p>
        </div>
        <Button variant="outline" size="sm" onClick={() => refetch()}>
          <RefreshCcw className="mr-2 h-4 w-4" /> Actualizar
        </Button>
      </div>
      <KPIWidgets data={data} isLoading={isLoading} />
    </div>
  );
};

// FILE: src/treasury/pages/EgresoDetail.tsx
import { useEffect, useState } from 'react';
import { useNavigate, useParams } from 'react-router-dom';
import { Card, CardContent, CardHeader, CardTitle } from '@shared/components/ui/card';
import { Button } from '@shared/components/ui/button';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@shared/components/ui/tabs';
import { EgresoForm } from '../components/EgresoForm';
import { useCuentas } from '../hooks/useBancos';
import { usePresupuesto } from '../hooks/usePresupuesto';
import { useProveedores } from '../hooks/useProveedores';
import { useEgreso, useDeleteEgreso, useUpdateEgreso } from '../hooks/useEgresos';
import { useUIStore } from '@shared/store/ui.store';
import { AuditTrail } from '@shared/components/AuditTrail';
import { Input } from '@shared/components/ui/input';
import { toast } from '@shared/hooks/useToast';

export const EgresoDetail = () => {
  const { id } = useParams();
  const navigate = useNavigate();
  const { data, isLoading } = useEgreso(id);
  const { data: cuentas } = useCuentas();
  const { data: presupuesto } = usePresupuesto();
  const { data: proveedores } = useProveedores();
  const { mutateAsync: updateEgreso, isPending } = useUpdateEgreso();
  const { mutateAsync: deleteEgreso, isPending: isDeleting } = useDeleteEgreso();
  const [refPago, setRefPago] = useState('');
  const setBreadcrumb = useUIStore((state) => state.setBreadcrumb);

  useEffect(() => {
    setBreadcrumb(['Tesorería', 'Egresos', `Detalle ${id ?? ''}`]);
  }, [id, setBreadcrumb]);

  useEffect(() => {
    if (data?.refPago) setRefPago(data.refPago);
  }, [data?.refPago]);

  if (isLoading) return <p className="text-sm text-muted-foreground">Cargando egreso…</p>;
  if (!data) return <p className="text-sm text-muted-foreground">Egreso no encontrado.</p>;

  return (
    <div className="space-y-4">
      <div className="flex items-center justify-between">
        <h1 className="text-xl font-semibold">Egreso {data.concepto}</h1>
        <div className="flex items-center gap-2">
          <Button
            variant="outline"
            onClick={async () => {
              if (data.estatus === 'PAGADO') {
                toast({ title: 'El egreso ya está marcado como pagado', variant: 'warning' });
                return;
              }
              await updateEgreso({ id: data.id, payload: { estatus: 'PAGADO', refPago } });
            }}
          >
            Registrar pago
          </Button>
          <Button
            variant="destructive"
            disabled={isDeleting}
            onClick={async () => {
              await deleteEgreso(data.id);
              navigate('/tesoreria/egresos');
            }}
          >
            Eliminar
          </Button>
        </div>
      </div>
      <Tabs defaultValue="datos">
        <TabsList>
          <TabsTrigger value="datos">Datos</TabsTrigger>
          <TabsTrigger value="adjuntos">Adjuntos</TabsTrigger>
          <TabsTrigger value="bitacora">Bitácora</TabsTrigger>
        </TabsList>
        <TabsContent value="datos" className="mt-4">
          <Card>
            <CardHeader>
              <CardTitle>Información general</CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
              <EgresoForm
                defaultValues={data}
                proveedores={proveedores ?? []}
                cuentas={cuentas ?? []}
                partidas={presupuesto?.partidas ?? []}
                loading={isPending}
                onSubmit={async (values) => {
                  await updateEgreso({ id: data.id, payload: values });
                }}
              />
              <div className="space-y-2">
                <p className="text-sm font-medium">Referencia de pago</p>
                <Input value={refPago} onChange={(event) => setRefPago(event.target.value)} placeholder="Folio de transferencia" />
              </div>
            </CardContent>
          </Card>
        </TabsContent>
        <TabsContent value="adjuntos" className="mt-4">
          <Card>
            <CardHeader>
              <CardTitle>Documentos asociados</CardTitle>
            </CardHeader>
            <CardContent>
              <p className="text-sm text-muted-foreground">Los adjuntos se administran desde el CFDI del proveedor.</p>
            </CardContent>
          </Card>
        </TabsContent>
        <TabsContent value="bitacora" className="mt-4">
          <Card>
            <CardHeader>
              <CardTitle>Bitácora</CardTitle>
            </CardHeader>
            <CardContent>
              <AuditTrail entries={data.bitacora as any[]} />
            </CardContent>
          </Card>
        </TabsContent>
      </Tabs>
    </div>
  );
};

// FILE: src/treasury/pages/EgresoNew.tsx
import { useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { Card, CardContent, CardHeader, CardTitle } from '@shared/components/ui/card';
import { EgresoForm } from '../components/EgresoForm';
import { useCreateEgreso } from '../hooks/useEgresos';
import { useCuentas } from '../hooks/useBancos';
import { usePresupuesto } from '../hooks/usePresupuesto';
import { useProveedores } from '../hooks/useProveedores';
import { useUIStore } from '@shared/store/ui.store';

export const EgresoNew = () => {
  const navigate = useNavigate();
  const setBreadcrumb = useUIStore((state) => state.setBreadcrumb);
  const { mutateAsync, isPending } = useCreateEgreso();
  const { data: cuentas } = useCuentas();
  const { data: presupuesto } = usePresupuesto();
  const { data: proveedores } = useProveedores();

  useEffect(() => {
    setBreadcrumb(['Tesorería', 'Egresos', 'Nuevo egreso']);
  }, [setBreadcrumb]);

  return (
    <Card>
      <CardHeader>
        <CardTitle>Registrar nuevo egreso</CardTitle>
      </CardHeader>
      <CardContent>
        <EgresoForm
          proveedores={proveedores ?? []}
          cuentas={cuentas ?? []}
          partidas={presupuesto?.partidas ?? []}
          loading={isPending}
          onSubmit={async (values) => {
            await mutateAsync(values);
            navigate('/tesoreria/egresos');
          }}
        />
      </CardContent>
    </Card>
  );
};

// FILE: src/treasury/pages/EgresosList.tsx
import { useMemo, useState, useEffect } from 'react';
import type { ColumnDef } from '@tanstack/react-table';
import { Button } from '@shared/components/ui/button';
import { Input } from '@shared/components/ui/input';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@shared/components/ui/select';
import { DataTable } from '@shared/components/DataTable';
import { formatCurrency, formatDate } from '@shared/lib/utils';
import { useEgresos, exportEgresosCSV, type EgresosFilters } from '../hooks/useEgresos';
import { useProveedores } from '../hooks/useProveedores';
import type { Egreso } from '@treasury/types';
import { useNavigate } from 'react-router-dom';
import { useUIStore } from '@shared/store/ui.store';
import { Download, Plus } from 'lucide-react';
import { StatusBadge } from '@shared/components/StatusBadge';

export const EgresosList = () => {
  const [filters, setFilters] = useState<EgresosFilters>({});
  const { data, isLoading } = useEgresos(filters);
  const { data: proveedores } = useProveedores();
  const navigate = useNavigate();
  const setBreadcrumb = useUIStore((state) => state.setBreadcrumb);

  useEffect(() => {
    setBreadcrumb(['Tesorería', 'Egresos']);
  }, [setBreadcrumb]);

  const columns = useMemo<ColumnDef<Egreso>[]>(
    () => [
      {
        accessorKey: 'fecha',
        header: 'Fecha',
        cell: ({ row }) => formatDate(row.original.fecha)
      },
      {
        accessorKey: 'concepto',
        header: 'Concepto'
      },
      {
        accessorKey: 'proveedorId',
        header: 'Proveedor'
      },
      {
        accessorKey: 'importe',
        header: 'Importe',
        cell: ({ row }) => <span className="font-medium">{formatCurrency(row.original.importe)}</span>
      },
      {
        accessorKey: 'cuentaId',
        header: 'Cuenta'
      },
      {
        accessorKey: 'partida',
        header: 'Partida'
      },
      {
        accessorKey: 'capitulo',
        header: 'Capítulo'
      },
      {
        accessorKey: 'estatus',
        header: 'Estatus',
        cell: ({ row }) => <StatusBadge status={row.original.estatus} />
      }
    ],
    []
  );

  const manualFilters = (
    <div className="flex flex-wrap items-center gap-2">
      <Input
        type="date"
        value={filters.fechaInicio ?? ''}
        onChange={(event) => setFilters((prev) => ({ ...prev, fechaInicio: event.target.value }))}
        className="w-40"
      />
      <Input
        type="date"
        value={filters.fechaFin ?? ''}
        onChange={(event) => setFilters((prev) => ({ ...prev, fechaFin: event.target.value }))}
        className="w-40"
      />
      <Select
        value={filters.proveedorId ?? ''}
        onValueChange={(value) => setFilters((prev) => ({ ...prev, proveedorId: value || undefined }))}
      >
        <SelectTrigger className="w-48">
          <SelectValue placeholder="Proveedor" />
        </SelectTrigger>
        <SelectContent>
          <SelectItem value="">Todos</SelectItem>
          {proveedores?.map((prov) => (
            <SelectItem key={prov.id} value={prov.id}>
              {prov.nombre}
            </SelectItem>
          ))}
        </SelectContent>
      </Select>
      <Select value={filters.estatus ?? ''} onValueChange={(value) => setFilters((prev) => ({ ...prev, estatus: (value as Egreso['estatus']) || undefined }))}>
        <SelectTrigger className="w-40">
          <SelectValue placeholder="Estatus" />
        </SelectTrigger>
        <SelectContent>
          <SelectItem value="">Todos</SelectItem>
          <SelectItem value="PENDIENTE">Pendiente</SelectItem>
          <SelectItem value="PAGADO">Pagado</SelectItem>
        </SelectContent>
      </Select>
      <Button variant="ghost" size="sm" onClick={() => setFilters({})}>
        Limpiar filtros
      </Button>
    </div>
  );

  return (
    <div className="space-y-4">
      <div className="flex flex-wrap items-center justify-between gap-3">
        <div>
          <h1 className="text-xl font-semibold">Egresos comprometidos</h1>
          <p className="text-sm text-muted-foreground">Pagos a proveedores y compromisos devengados.</p>
        </div>
        <div className="flex items-center gap-2">
          <Button variant="outline" size="sm" onClick={() => exportEgresosCSV(data ?? [])} disabled={!data?.length}>
            <Download className="mr-2 h-4 w-4" /> Exportar CSV
          </Button>
          <Button size="sm" onClick={() => navigate('/tesoreria/egresos/nuevo')}>
            <Plus className="mr-2 h-4 w-4" /> Nuevo egreso
          </Button>
        </div>
      </div>
      <DataTable
        data={data ?? []}
        columns={columns}
        searchPlaceholder="Buscar por concepto"
        manualFilterComponent={manualFilters}
        onRowClick={(row) => navigate(`/tesoreria/egresos/${row.id}`)}
        bulkActions={[
          {
            label: 'Exportar seleccionados',
            onClick: (rows) => exportEgresosCSV(rows)
          }
        ]}
      />
      {isLoading ? <p className="text-sm text-muted-foreground">Cargando egresos…</p> : null}
    </div>
  );
};

// FILE: src/treasury/pages/IngresoDetail.tsx
import { useParams, useNavigate } from 'react-router-dom';
import { useEffect, useState } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@shared/components/ui/card';
import { Button } from '@shared/components/ui/button';
import { IngresoForm } from '../components/IngresoForm';
import { useDeleteIngreso, useIngreso, useUpdateIngreso } from '../hooks/useIngresos';
import { useCuentas } from '../hooks/useBancos';
import { usePresupuesto } from '../hooks/usePresupuesto';
import { PanelLateral } from '@shared/components/PanelLateral';
import { AuditTrail } from '@shared/components/AuditTrail';
import { useUIStore } from '@shared/store/ui.store';

export const IngresoDetail = () => {
  const { id } = useParams();
  const navigate = useNavigate();
  const { data, isLoading } = useIngreso(id);
  const { data: cuentas } = useCuentas();
  const { data: presupuesto } = usePresupuesto();
  const { mutateAsync: updateIngreso, isPending } = useUpdateIngreso();
  const { mutateAsync: deleteIngreso, isPending: isDeleting } = useDeleteIngreso();
  const [panelOpen, setPanelOpen] = useState(false);
  const setBreadcrumb = useUIStore((state) => state.setBreadcrumb);

  useEffect(() => {
    setBreadcrumb(['Tesorería', 'Ingresos', `Detalle ${id ?? ''}`]);
  }, [id, setBreadcrumb]);

  if (isLoading) {
    return <p className="text-sm text-muted-foreground">Cargando detalle del ingreso…</p>;
  }

  if (!data) {
    return <p className="text-sm text-muted-foreground">No se encontró el ingreso solicitado.</p>;
  }

  return (
    <div className="space-y-4">
      <div className="flex items-center justify-between">
        <h1 className="text-xl font-semibold">Ingreso {data.referencia ?? data.id}</h1>
        <div className="flex items-center gap-2">
          <Button variant="outline" onClick={() => setPanelOpen(true)}>
            Ver bitácora
          </Button>
          <Button
            variant="destructive"
            onClick={async () => {
              await deleteIngreso(data.id);
              navigate('/tesoreria/ingresos');
            }}
            disabled={isDeleting}
          >
            Eliminar
          </Button>
        </div>
      </div>
      <Card>
        <CardHeader>
          <CardTitle>Editar ingreso</CardTitle>
        </CardHeader>
        <CardContent>
          <IngresoForm
            defaultValues={data}
            cuentas={cuentas ?? []}
            partidas={presupuesto?.partidas ?? []}
            loading={isPending}
            onSubmit={async (values) => {
              await updateIngreso({ id: data.id, payload: values });
            }}
          />
        </CardContent>
      </Card>
      <PanelLateral title="Bitácora del ingreso" open={panelOpen} onClose={() => setPanelOpen(false)}>
        <AuditTrail entries={data.bitacora as any[]} />
      </PanelLateral>
    </div>
  );
};

// FILE: src/treasury/pages/IngresoNew.tsx
import { useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { Card, CardContent, CardHeader, CardTitle } from '@shared/components/ui/card';
import { IngresoForm } from '../components/IngresoForm';
import { useCreateIngreso } from '../hooks/useIngresos';
import { useCuentas } from '../hooks/useBancos';
import { usePresupuesto } from '../hooks/usePresupuesto';
import { useUIStore } from '@shared/store/ui.store';

export const IngresoNew = () => {
  const navigate = useNavigate();
  const setBreadcrumb = useUIStore((state) => state.setBreadcrumb);
  const { mutateAsync, isPending } = useCreateIngreso();
  const { data: cuentas } = useCuentas();
  const { data: presupuesto } = usePresupuesto();

  useEffect(() => {
    setBreadcrumb(['Tesorería', 'Ingresos', 'Nuevo ingreso']);
  }, [setBreadcrumb]);

  return (
    <Card>
      <CardHeader>
        <CardTitle>Registrar nuevo ingreso</CardTitle>
      </CardHeader>
      <CardContent>
        <IngresoForm
          cuentas={cuentas ?? []}
          partidas={presupuesto?.partidas ?? []}
          loading={isPending}
          onSubmit={async (values) => {
            await mutateAsync(values);
            navigate('/tesoreria/ingresos');
          }}
        />
      </CardContent>
    </Card>
  );
};

// FILE: src/treasury/pages/IngresosList.tsx
import { useMemo, useState } from 'react';
import type { ColumnDef } from '@tanstack/react-table';
import { Button } from '@shared/components/ui/button';
import { Input } from '@shared/components/ui/input';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@shared/components/ui/select';
import { DataTable } from '@shared/components/DataTable';
import { formatCurrency, formatDate } from '@shared/lib/utils';
import { useIngresos, exportIngresosCSV, type IngresosFilters } from '../hooks/useIngresos';
import type { Ingreso } from '@treasury/types';
import { useNavigate } from 'react-router-dom';
import { useUIStore } from '@shared/store/ui.store';
import { useEffect } from 'react';
import { useCuentas } from '../hooks/useBancos';
import { Download, Plus } from 'lucide-react';

export const IngresosList = () => {
  const [filters, setFilters] = useState<IngresosFilters>({});
  const { data, isLoading } = useIngresos(filters);
  const { data: cuentas } = useCuentas();
  const navigate = useNavigate();
  const setBreadcrumb = useUIStore((state) => state.setBreadcrumb);

  useEffect(() => {
    setBreadcrumb(['Tesorería', 'Ingresos']);
  }, [setBreadcrumb]);

  const columns = useMemo<ColumnDef<Ingreso>[]>(
    () => [
      {
        accessorKey: 'fecha',
        header: 'Fecha',
        cell: ({ row }) => formatDate(row.original.fecha)
      },
      {
        accessorKey: 'concepto',
        header: 'Concepto'
      },
      {
        accessorKey: 'importe',
        header: 'Importe',
        cell: ({ row }) => <span className="font-medium">{formatCurrency(row.original.importe)}</span>
      },
      {
        accessorKey: 'fuente',
        header: 'Fuente'
      },
      {
        accessorKey: 'referencia',
        header: 'Referencia',
        cell: ({ row }) => row.original.referencia ?? '—'
      },
      {
        accessorKey: 'cuentaId',
        header: 'Cuenta'
      },
      {
        accessorKey: 'partida',
        header: 'Partida'
      },
      {
        accessorKey: 'capitulo',
        header: 'Capítulo'
      }
    ],
    []
  );

  const manualFilters = (
    <div className="flex flex-wrap items-center gap-2">
      <Input
        type="date"
        value={filters.fechaInicio ?? ''}
        onChange={(event) => setFilters((prev) => ({ ...prev, fechaInicio: event.target.value }))}
        className="w-40"
      />
      <Input
        type="date"
        value={filters.fechaFin ?? ''}
        onChange={(event) => setFilters((prev) => ({ ...prev, fechaFin: event.target.value }))}
        className="w-40"
      />
      <Input
        placeholder="Fuente"
        value={filters.fuente ?? ''}
        onChange={(event) => setFilters((prev) => ({ ...prev, fuente: event.target.value }))}
        className="w-40"
      />
      <Select value={filters.cuentaId ?? ''} onValueChange={(value) => setFilters((prev) => ({ ...prev, cuentaId: value || undefined }))}>
        <SelectTrigger className="w-52">
          <SelectValue placeholder="Cuenta" />
        </SelectTrigger>
        <SelectContent>
          <SelectItem value="">Todas</SelectItem>
          {cuentas?.map((cuenta) => (
            <SelectItem key={cuenta.id} value={cuenta.id}>
              {cuenta.nombre}
            </SelectItem>
          ))}
        </SelectContent>
      </Select>
      <Button variant="ghost" size="sm" onClick={() => setFilters({})}>
        Limpiar filtros
      </Button>
    </div>
  );

  return (
    <div className="space-y-4">
      <div className="flex flex-wrap items-center justify-between gap-3">
        <div>
          <h1 className="text-xl font-semibold">Ingresos capturados</h1>
          <p className="text-sm text-muted-foreground">Control de ingresos municipales por fuente de financiamiento.</p>
        </div>
        <div className="flex items-center gap-2">
          <Button variant="outline" size="sm" onClick={() => exportIngresosCSV(data ?? [])} disabled={!data?.length}>
            <Download className="mr-2 h-4 w-4" /> Exportar CSV
          </Button>
          <Button size="sm" onClick={() => navigate('/tesoreria/ingresos/nuevo')}>
            <Plus className="mr-2 h-4 w-4" /> Nuevo ingreso
          </Button>
        </div>
      </div>
      <DataTable
        data={data ?? []}
        columns={columns}
        searchPlaceholder="Buscar por concepto o referencia"
        manualFilterComponent={manualFilters}
        onRowClick={(row) => navigate(`/tesoreria/ingresos/${row.id}`)}
        bulkActions={[
          {
            label: 'Exportar seleccionados',
            onClick: (rows) => exportIngresosCSV(rows)
          }
        ]}
      />
      {isLoading ? <p className="text-sm text-muted-foreground">Cargando ingresos…</p> : null}
    </div>
  );
};

// FILE: src/treasury/pages/MovimientosBancarios.tsx
import { useEffect, useMemo, useState } from 'react';
import type { ColumnDef } from '@tanstack/react-table';
import { Button } from '@shared/components/ui/button';
import { Input } from '@shared/components/ui/input';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@shared/components/ui/select';
import { DataTable } from '@shared/components/DataTable';
import { useMovimientos, useGuardarMovimiento, useImportarMovimientos, useConciliarMovimientos } from '../hooks/useBancos';
import type { MovimientoBancario } from '@treasury/types';
import { formatCurrency, formatDate, downloadFile } from '@shared/lib/utils';
import { useUIStore } from '@shared/store/ui.store';
import sampleMovimientos from '@mocks/data/movimientos_ejemplo.csv?raw';
import { toast } from '@shared/hooks/useToast';

const parseCSV = async (file: File) => {
  const text = await file.text();
  const [header, ...rows] = text.trim().split(/\r?\n/);
  const columns = header.split(',');
  return rows.map((row) => {
    const values = row.split(',');
    const record: Record<string, string> = {};
    columns.forEach((col, index) => {
      record[col.trim()] = values[index]?.replace(/"/g, '') ?? '';
    });
    return {
      id: crypto.randomUUID(),
      cuentaId: record.cuenta,
      fecha: record.fecha,
      concepto: record.concepto,
      tipo: record.tipo === 'CARGO' ? 'CARGO' : 'ABONO',
      importe: Number(record.importe),
      ref: record.ref,
      conciliado: record.conciliado === 'true'
    } as MovimientoBancario;
  });
};

export const MovimientosBancariosPage = () => {
  const [filters, setFilters] = useState<{ cuentaId?: string; conciliado?: string }>({});
  const { data, isLoading } = useMovimientos(filters);
  const guardar = useGuardarMovimiento();
  const importar = useImportarMovimientos();
  const conciliar = useConciliarMovimientos();
  const setBreadcrumb = useUIStore((state) => state.setBreadcrumb);

  useEffect(() => {
    setBreadcrumb(['Tesorería', 'Movimientos Bancarios']);
  }, [setBreadcrumb]);

  const columns = useMemo<ColumnDef<MovimientoBancario>[]>(
    () => [
      {
        accessorKey: 'fecha',
        header: 'Fecha',
        cell: ({ row }) => formatDate(row.original.fecha)
      },
      {
        accessorKey: 'concepto',
        header: 'Concepto'
      },
      {
        accessorKey: 'tipo',
        header: 'Tipo'
      },
      {
        accessorKey: 'importe',
        header: 'Importe',
        cell: ({ row }) => <span className="font-medium">{formatCurrency(row.original.importe)}</span>
      },
      {
        accessorKey: 'cuentaId',
        header: 'Cuenta'
      },
      {
        accessorKey: 'ref',
        header: 'Referencia',
        cell: ({ row }) => row.original.ref ?? '—'
      },
      {
        accessorKey: 'conciliado',
        header: 'Conciliado',
        cell: ({ row }) => (row.original.conciliado ? 'Sí' : 'No')
      }
    ],
    []
  );

  const handleImport = async (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0];
    if (!file) return;
    const registros = await parseCSV(file);
    await importar.mutateAsync(registros);
    toast({ title: 'Movimientos importados', description: `${registros.length} registros añadidos.` });
  };

  return (
    <div className="space-y-4">
      <div className="flex flex-wrap items-center gap-2">
        <Input
          placeholder="Cuenta"
          value={filters.cuentaId ?? ''}
          onChange={(event) => setFilters((prev) => ({ ...prev, cuentaId: event.target.value || undefined }))}
          className="w-36"
        />
        <Select
          value={filters.conciliado ?? ''}
          onValueChange={(value) => setFilters((prev) => ({ ...prev, conciliado: value || undefined }))}
        >
          <SelectTrigger className="w-40">
            <SelectValue placeholder="Estado" />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="">Todos</SelectItem>
            <SelectItem value="true">Conciliado</SelectItem>
            <SelectItem value="false">Pendiente</SelectItem>
          </SelectContent>
        </Select>
        <Input type="file" accept=".csv" onChange={handleImport} className="w-60" />
        <Button variant="outline" size="sm" onClick={() => downloadFile('movimientos_ejemplo.csv', sampleMovimientos, 'text/csv')}>
          Descargar plantilla
        </Button>
      </div>
      <DataTable
        data={data ?? []}
        columns={columns}
        searchPlaceholder="Buscar concepto"
        onRowClick={async (row) => {
          await guardar.mutateAsync({ id: row.id, conciliado: !row.conciliado });
        }}
        bulkActions={[
          {
            label: 'Conciliar',
            onClick: async (rows) => {
              await conciliar.mutateAsync({ ids: rows.map((row) => row.id), conciliado: true });
            }
          }
        ]}
      />
      {isLoading ? <p className="text-sm text-muted-foreground">Cargando movimientos…</p> : null}
    </div>
  );
};

// FILE: src/treasury/pages/Presupuesto.tsx
import { useEffect, useState } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@shared/components/ui/card';
import { Button } from '@shared/components/ui/button';
import { Input } from '@shared/components/ui/input';
import { usePresupuesto, useModificarPresupuesto } from '../hooks/usePresupuesto';
import { formatCurrency } from '@shared/lib/utils';
import { useUIStore } from '@shared/store/ui.store';
import { toast } from '@shared/hooks/useToast';

export const PresupuestoPage = () => {
  const { data, isLoading } = usePresupuesto();
  const { mutateAsync, isPending } = useModificarPresupuesto();
  const setBreadcrumb = useUIStore((state) => state.setBreadcrumb);
  const [partida, setPartida] = useState('');
  const [monto, setMonto] = useState(0);
  const [motivo, setMotivo] = useState('');

  useEffect(() => {
    setBreadcrumb(['Tesorería', 'Presupuesto']);
  }, [setBreadcrumb]);

  if (isLoading) return <p className="text-sm text-muted-foreground">Cargando presupuesto…</p>;
  if (!data) return <p className="text-sm text-muted-foreground">Sin presupuesto cargado.</p>;

  const totalDisponible = data.partidas.reduce((sum, partida) => sum + (partida.disponible ?? 0), 0);
  const totalPagado = data.partidas.reduce((sum, partida) => sum + ((partida as any).pagado ?? 0), 0);

  return (
    <div className="space-y-4">
      <Card>
        <CardHeader>
          <CardTitle>Resumen presupuestal {data.ejercicio}</CardTitle>
        </CardHeader>
        <CardContent className="grid gap-4 md:grid-cols-2">
          <div className="rounded-lg border border-border p-4">
            <p className="text-sm text-muted-foreground">Disponible total</p>
            <p className="text-2xl font-semibold">{formatCurrency(totalDisponible)}</p>
          </div>
          <div className="rounded-lg border border-border p-4">
            <p className="text-sm text-muted-foreground">Pagado</p>
            <p className="text-2xl font-semibold text-primary">{formatCurrency(totalPagado)}</p>
          </div>
        </CardContent>
      </Card>
      <Card>
        <CardHeader>
          <CardTitle>Detalle por partida</CardTitle>
        </CardHeader>
        <CardContent className="overflow-x-auto">
          <table className="w-full min-w-[700px] text-sm">
            <thead className="bg-muted/40 text-xs uppercase text-muted-foreground">
              <tr>
                <th className="px-3 py-2 text-left">Partida</th>
                <th className="px-3 py-2 text-left">Capítulo</th>
                <th className="px-3 py-2 text-left">Nombre</th>
                <th className="px-3 py-2 text-right">Disponible</th>
                <th className="px-3 py-2 text-right">Comprometido</th>
                <th className="px-3 py-2 text-right">Devengado</th>
                <th className="px-3 py-2 text-right">Pagado</th>
              </tr>
            </thead>
            <tbody>
              {data.partidas.map((item) => (
                <tr key={item.clave} className="border-t border-border/70">
                  <td className="px-3 py-2">{item.clave}</td>
                  <td className="px-3 py-2">{item.capitulo}</td>
                  <td className="px-3 py-2">{item.nombre}</td>
                  <td className="px-3 py-2 text-right">{formatCurrency(item.disponible ?? 0)}</td>
                  <td className="px-3 py-2 text-right">{formatCurrency((item as any).comprometido ?? 0)}</td>
                  <td className="px-3 py-2 text-right">{formatCurrency((item as any).devengado ?? 0)}</td>
                  <td className="px-3 py-2 text-right">{formatCurrency((item as any).pagado ?? 0)}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </CardContent>
      </Card>
      <Card>
        <CardHeader>
          <CardTitle>Registrar modificación presupuestal</CardTitle>
        </CardHeader>
        <CardContent className="grid gap-3 md:grid-cols-4">
          <Input placeholder="Partida" value={partida} onChange={(event) => setPartida(event.target.value)} />
          <Input
            type="number"
            step="0.01"
            placeholder="Monto"
            value={monto}
            onChange={(event) => setMonto(Number(event.target.value))}
          />
          <Input placeholder="Motivo" value={motivo} onChange={(event) => setMotivo(event.target.value)} />
          <Button
            onClick={async () => {
              if (!partida || !monto || !motivo) {
                toast({ title: 'Complete la información', variant: 'warning' });
                return;
              }
              await mutateAsync({ partida, monto, motivo });
              setPartida('');
              setMonto(0);
              setMotivo('');
            }}
            disabled={isPending}
          >
            Guardar modificación
          </Button>
        </CardContent>
      </Card>
    </div>
  );
};

// FILE: src/treasury/pages/Proveedores.tsx
import { useEffect, useMemo, useState } from 'react';
import type { ColumnDef } from '@tanstack/react-table';
import { Button } from '@shared/components/ui/button';
import { Input } from '@shared/components/ui/input';
import { DataTable } from '@shared/components/DataTable';
import { useProveedores, useCrearProveedor, useActualizarProveedor, useEliminarProveedor } from '../hooks/useProveedores';
import type { Proveedor } from '@treasury/types';
import { validateRFC } from '@shared/lib/validators';
import { toast } from '@shared/hooks/useToast';
import { useUIStore } from '@shared/store/ui.store';
import { Save, Trash } from 'lucide-react';

export const ProveedoresPage = () => {
  const [busqueda, setBusqueda] = useState('');
  const { data, isLoading, refetch } = useProveedores(busqueda);
  const crear = useCrearProveedor();
  const actualizar = useActualizarProveedor();
  const eliminar = useEliminarProveedor();
  const [nuevo, setNuevo] = useState<Partial<Proveedor>>({ nombre: '', rfc: '', email: '', telefono: '', direccion: '' });
  const [editing, setEditing] = useState<Record<string, Partial<Proveedor>>>({});
  const setBreadcrumb = useUIStore((state) => state.setBreadcrumb);

  useEffect(() => {
    setBreadcrumb(['Tesorería', 'Proveedores']);
  }, [setBreadcrumb]);

  const columns = useMemo<ColumnDef<Proveedor>[]>(
    () => [
      {
        accessorKey: 'nombre',
        header: 'Nombre',
        cell: ({ row }) => (
          <Input
            defaultValue={row.original.nombre}
            onChange={(event) => setEditing((prev) => ({ ...prev, [row.original.id]: { ...prev[row.original.id], nombre: event.target.value } }))}
          />
        )
      },
      {
        accessorKey: 'rfc',
        header: 'RFC',
        cell: ({ row }) => (
          <Input
            defaultValue={row.original.rfc}
            onChange={(event) => setEditing((prev) => ({ ...prev, [row.original.id]: { ...prev[row.original.id], rfc: event.target.value } }))}
          />
        )
      },
      {
        accessorKey: 'email',
        header: 'Correo',
        cell: ({ row }) => (
          <Input
            defaultValue={row.original.email}
            onChange={(event) => setEditing((prev) => ({ ...prev, [row.original.id]: { ...prev[row.original.id], email: event.target.value } }))}
          />
        )
      },
      {
        accessorKey: 'telefono',
        header: 'Teléfono',
        cell: ({ row }) => (
          <Input
            defaultValue={row.original.telefono}
            onChange={(event) => setEditing((prev) => ({ ...prev, [row.original.id]: { ...prev[row.original.id], telefono: event.target.value } }))}
          />
        )
      },
      {
        id: 'acciones',
        header: 'Acciones',
        cell: ({ row }) => (
          <div className="flex items-center gap-2">
            <Button
              size="icon"
              variant="outline"
              onClick={async () => {
                const draft = editing[row.original.id];
                if (!draft) {
                  toast({ title: 'Sin cambios por guardar', variant: 'warning' });
                  return;
                }
                if (draft.rfc) {
                  const resultado = validateRFC(draft.rfc);
                  if (resultado !== true) {
                    toast({ title: 'RFC inválido', description: String(resultado), variant: 'warning' });
                    return;
                  }
                }
                await actualizar.mutateAsync({ id: row.original.id, payload: draft });
                setEditing((prev) => {
                  const next = { ...prev };
                  delete next[row.original.id];
                  return next;
                });
                refetch();
              }}
            >
              <Save className="h-4 w-4" />
            </Button>
            <Button
              size="icon"
              variant="destructive"
              onClick={async () => {
                await eliminar.mutateAsync(row.original.id);
                refetch();
              }}
            >
              <Trash className="h-4 w-4" />
            </Button>
          </div>
        )
      }
    ],
    [actualizar, eliminar, editing, refetch]
  );

  const handleCrear = async () => {
    if (!nuevo.nombre || !nuevo.rfc) {
      toast({ title: 'Complete nombre y RFC', variant: 'warning' });
      return;
    }
    const resultado = validateRFC(nuevo.rfc);
    if (resultado !== true) {
      toast({ title: 'RFC inválido', description: String(resultado), variant: 'warning' });
      return;
    }
    await crear.mutateAsync(nuevo);
    setNuevo({ nombre: '', rfc: '', email: '', telefono: '', direccion: '' });
    refetch();
  };

  return (
    <div className="space-y-4">
      <div className="flex flex-wrap items-center gap-2">
        <Input
          placeholder="Buscar proveedor"
          className="w-64"
          value={busqueda}
          onChange={(event) => setBusqueda(event.target.value)}
        />
        <Button variant="ghost" size="sm" onClick={() => setBusqueda('')}>
          Limpiar
        </Button>
      </div>
      <div className="grid gap-3 md:grid-cols-5">
        <Input placeholder="Nombre" value={nuevo.nombre ?? ''} onChange={(event) => setNuevo((prev) => ({ ...prev, nombre: event.target.value }))} />
        <Input placeholder="RFC" value={nuevo.rfc ?? ''} onChange={(event) => setNuevo((prev) => ({ ...prev, rfc: event.target.value.toUpperCase() }))} />
        <Input placeholder="Correo" value={nuevo.email ?? ''} onChange={(event) => setNuevo((prev) => ({ ...prev, email: event.target.value }))} />
        <Input placeholder="Teléfono" value={nuevo.telefono ?? ''} onChange={(event) => setNuevo((prev) => ({ ...prev, telefono: event.target.value }))} />
        <Button onClick={handleCrear} disabled={crear.isPending}>
          Agregar proveedor
        </Button>
      </div>
      <DataTable data={data ?? []} columns={columns} />
      {isLoading ? <p className="text-sm text-muted-foreground">Cargando proveedores…</p> : null}
    </div>
  );
};

// FILE: src/treasury/pages/ReportesTesoreria.tsx
import { useEffect, useState } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@shared/components/ui/card';
import { Button } from '@shared/components/ui/button';
import { Input } from '@shared/components/ui/input';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@shared/components/ui/select';
import { useReportes, exportReporteCSV } from '../hooks/useReportes';
import { formatCurrency, formatDate } from '@shared/lib/utils';
import { toast } from '@shared/hooks/useToast';
import { useUIStore } from '@shared/store/ui.store';

export const ReportesTesoreriaPage = () => {
  const [filters, setFilters] = useState<{ cuentaId?: string; capitulo?: string; fechaInicio?: string; fechaFin?: string }>({});
  const { data, isLoading } = useReportes(filters);
  const setBreadcrumb = useUIStore((state) => state.setBreadcrumb);

  useEffect(() => {
    setBreadcrumb(['Tesorería', 'Reportes']);
  }, [setBreadcrumb]);

  return (
    <div className="space-y-4">
      <div className="flex flex-wrap items-center gap-2">
        <Input
          placeholder="Cuenta"
          value={filters.cuentaId ?? ''}
          onChange={(event) => setFilters((prev) => ({ ...prev, cuentaId: event.target.value || undefined }))}
          className="w-36"
        />
        <Input
          placeholder="Capítulo"
          value={filters.capitulo ?? ''}
          onChange={(event) => setFilters((prev) => ({ ...prev, capitulo: event.target.value || undefined }))}
          className="w-36"
        />
        <Input
          type="date"
          value={filters.fechaInicio ?? ''}
          onChange={(event) => setFilters((prev) => ({ ...prev, fechaInicio: event.target.value }))}
          className="w-40"
        />
        <Input
          type="date"
          value={filters.fechaFin ?? ''}
          onChange={(event) => setFilters((prev) => ({ ...prev, fechaFin: event.target.value }))}
          className="w-40"
        />
        <Button variant="ghost" size="sm" onClick={() => setFilters({})}>
          Limpiar
        </Button>
      </div>
      {isLoading ? <p className="text-sm text-muted-foreground">Generando reportes…</p> : null}
      {data ? (
        <div className="space-y-4">
          <Card>
            <CardHeader className="flex flex-row items-center justify-between">
              <div>
                <CardTitle>Libro de ingresos</CardTitle>
                <p className="text-xs text-muted-foreground">Total registros: {data.libroIngresos.length}</p>
              </div>
              <div className="flex items-center gap-2">
                <Button variant="outline" size="sm" onClick={() => exportReporteCSV('libro_ingresos', data.libroIngresos)}>
                  Exportar CSV
                </Button>
                <Button variant="ghost" size="sm" onClick={() => toast({ title: 'Exportación PDF', description: 'Se generará en el sistema de reportes oficial.' })}>
                  Exportar PDF
                </Button>
              </div>
            </CardHeader>
            <CardContent className="space-y-2">
              {data.libroIngresos.map((item) => (
                <div key={`${item.fecha}-${item.concepto}`} className="flex items-center justify-between rounded border border-border px-3 py-2 text-sm">
                  <span>{formatDate(item.fecha)} · {item.concepto}</span>
                  <span className="font-medium">{formatCurrency(item.importe)}</span>
                </div>
              ))}
            </CardContent>
          </Card>
          <Card>
            <CardHeader className="flex flex-row items-center justify-between">
              <div>
                <CardTitle>Libro de egresos</CardTitle>
                <p className="text-xs text-muted-foreground">Total registros: {data.libroEgresos.length}</p>
              </div>
              <div className="flex items-center gap-2">
                <Button variant="outline" size="sm" onClick={() => exportReporteCSV('libro_egresos', data.libroEgresos)}>
                  Exportar CSV
                </Button>
                <Button variant="ghost" size="sm" onClick={() => toast({ title: 'Exportación PDF', description: 'Se generará en el sistema de reportes oficial.' })}>
                  Exportar PDF
                </Button>
              </div>
            </CardHeader>
            <CardContent className="space-y-2">
              {data.libroEgresos.map((item) => (
                <div key={`${item.fecha}-${item.concepto}`} className="flex items-center justify-between rounded border border-border px-3 py-2 text-sm">
                  <span>{formatDate(item.fecha)} · {item.concepto}</span>
                  <span className="font-medium">{formatCurrency(item.importe)}</span>
                </div>
              ))}
            </CardContent>
          </Card>
          <Card>
            <CardHeader>
              <CardTitle>Compromisos por estatus</CardTitle>
            </CardHeader>
            <CardContent className="grid gap-3 md:grid-cols-3">
              {Object.entries(data.compromisosPorEstatus).map(([estatus, payload]) => (
                <div key={estatus} className="rounded border border-border p-3 text-sm">
                  <p className="font-semibold">{estatus}</p>
                  <p className="text-xs text-muted-foreground">Registros: {payload.items.length}</p>
                  <p className="text-xs">Monto: {formatCurrency(payload.total)}</p>
                </div>
              ))}
            </CardContent>
          </Card>
          <Card>
            <CardHeader className="flex flex-row items-center justify-between">
              <CardTitle>Flujo de caja</CardTitle>
              <Button variant="outline" size="sm" onClick={() => exportReporteCSV('flujo_caja', [{ flujo: data.flujoCaja }])}>
                Exportar CSV
              </Button>
            </CardHeader>
            <CardContent>
              <p className="text-2xl font-semibold">{formatCurrency(data.flujoCaja)}</p>
              <p className="text-sm text-muted-foreground">Saldo neto considerando filtros aplicados.</p>
            </CardContent>
          </Card>
        </div>
      ) : null}
    </div>
  );
};

